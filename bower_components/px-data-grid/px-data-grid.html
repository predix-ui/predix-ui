<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-grid/vaadin-grid.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-tree-toggle.html">
<link rel="import" href="../px-spinner/px-spinner.html">
<link rel="import" href="../px-modal/px-modal.html">
<link rel="import" href="../px-icon-set/px-icon.html">
<link rel="import" href="px-data-grid-column.html">
<link rel="import" href="px-auto-filter-field.html">
<link rel="import" href="px-data-grid-theme.html">
<link rel="import" href="px-data-grid-selection-column.html">
<link rel="import" href="px-data-grid-toggle-details-column.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../px-moment-imports/px-moment-imports.html">

<link rel="import" href="px-data-grid-string-renderer.html">
<link rel="import" href="px-data-grid-date-renderer.html">
<link rel="import" href="px-data-grid-number-renderer.html">
<link rel="import" href="px-data-grid-cell-content-wrapper.html">
<link rel="import" href="px-data-grid-filter.html">
<link rel="import" href="px-data-grid-filters-modal.html">
<link rel="import" href="px-data-grid-filters-preview.html">
<link rel="import" href="px-data-grid-sorter.html">
<link rel="import" href="px-data-grid-action-column.html">
<link rel="import" href="px-data-grid-edit-column.html">

<link rel="import" href="px-data-grid-filterable-mixin.html">

<link rel="import" href="css/px-data-grid-styles.html">

</head><body><dom-module id="px-data-grid">
  <template>
    <style include="px-data-grid-styles"></style>

    <template is="dom-if" if="{{_showActionBar(autoFilter, hideActionMenu, filterable)}}">

      <div class="action-bar">
        <template is="dom-if" if="[[autoFilter]]">
          <px-auto-filter-field placeholder="[[localize('Search Table')]]" on-filter-change="_autoFilterChanged" value="{{_autoFilterValue}}">
          </px-auto-filter-field>
        </template>

        <div class="action-bar__right">
          <template is="dom-if" if="[[filterable]]">
            <px-data-grid-filters-modal filters="{{_filters}}" columns="[[columns]]" localize="[[_boundedLocalize]]" offer-filter-saving="[[offerFilterSaving]]" initial-filter-state="[[_initialFilterState]]" compact-mode="[[compactAdvancedFilterDialog]]" string-comparators="[[stringComparators]]" number-comparators="[[numberComparators]]">
            </px-data-grid-filters-modal>
          </template>

          <template is="dom-if" if="[[!hideColumnFilter]]">
            <px-dropdown class="px-data-grid-column-selector" multi="" allow-outside-scroll="" display-value="[[_columnSelectorLabel]]" items="[[_columnSelectorContent]]" selected-values="[[_selectedActionItems]]" disable-clear="" hide-selected="" on-px-dropdown-click="_actionClicked">
            </px-dropdown>
          </template>

          <template is="dom-if" if="[[_actionMenuShown]]">
            <px-dropdown class="px-data-grid-action-menu" allow-outside-scroll="" display-value="[[localize('Actions')]]" items="[[_actionMenuContent]]" disable-clear="" on-px-dropdown-click="_actionClicked">
            </px-dropdown>
          </template>
        </div>

      </div>
    </template>

    <px-data-grid-filters-preview filters="[[_filters]]" columns="[[columns]]" localize="[[_boundedLocalize]]" on-trigger-filters-modal="_openAdvancedFilter">
    </px-data-grid-filters-preview>

    <vaadin-grid size="[[size]]" data-provider="[[_currentDataProvider]]" active-item="[[activeItem]]" column-reordering-allowed="[[_isColumnReorderingAllowed(columnReorderingAllowed,_groupByColumn)]]" expanded-items="[[expandedItems]]" striped$="[[_isStriped(striped,_groupByColumn)]]" selected-items="{{selectedItems}}" multi-sort="[[multiSort]]" item-id-path="{{itemIdPath}}" page-size="{{pageSize}}" auto-height$="[[_isAutoHeight(gridHeight)]]" loading="{{_loading}}">

      <template is="dom-if" if="[[_isSelectable(selectionMode)]]" restamp="">
        <px-data-grid-selection-column frozen="" auto-select="" hidden="[[hideSelectionColumn]]" multi-select="[[_isMultiSelect(selectionMode)]]" tree-grid="[[_groupByColumn]]" allow-sort-by-selection="[[allowSortBySelection]]">
        </px-data-grid-selection-column>
      </template>

      <template is="dom-if" if="[[_rowDetails]]" restamp="">
        <px-data-grid-toggle-details-column frozen="">
        </px-data-grid-toggle-details-column>
      </template>

      <template is="dom-repeat" items="[[columns]]" as="column" restamp="">
        <px-data-grid-column name="[[column.name]]" path="[[column.path]]" hidden="[[column.hidden]]" localize="[[_boundedLocalize]]" type="[[column.type]]" frozen="[[_undefinedToFalse(column.frozen)]]" resizable="[[_checkColumnResizable(resizable, column.resizable)]]" mapped-object="[[column]]" width="[[_getColumnWidth(column)]]" flex-grow="[[_getColumnFlexGrow(column)]]" on-column-change="_onColumnUpdate" group-by-column-allowed="[[_groupByColumnAllowed(_hasLocalDataProvider, _expandableRows)]]" is-data-column="true">
          <template class="header">
            <px-data-grid-sorter path="[[_resolveColumnPath(column)]]">[[resolveColumnHeader(column)]]</px-data-grid-sorter>
          </template>

          <template>

            <dom-if if="[[_isGroupedByColumn(column, _groupByColumn)]]">
              <template>
                <vaadin-grid-tree-toggle leaf="[[!item.hasChildren]]" expanded="{{expanded}}" level="[[level]]">
                  <template is="dom-if" if="[[item.hasChildren]]">
                    <template is="dom-if" if="[[!expanded]]">
                      <px-icon icon="px-utl:chevron-right"></px-icon>
                    </template>
                    <template is="dom-if" if="[[expanded]]">
                      <px-icon icon="px-utl:chevron"></px-icon>
                    </template>
                  </template>
                  <px-data-grid-cell-content-wrapper focus-target="" cell-color="[[_resolveCellColor(item, column, _highlightEntities.*)]]" item="{{item}}" column="[[column]]" localize="[[_boundedLocalize]]">
                  </px-data-grid-cell-content-wrapper>
                </vaadin-grid-tree-toggle>
              </template>
            </dom-if>

            <dom-if if="[[!_isGroupedByColumn(column, _groupByColumn)]]">
              <template>
                <px-data-grid-cell-content-wrapper focus-target="" cell-color="[[_resolveCellColor(item, column, _highlightEntities.*, _editingItem)]]" item="{{item}}" column="[[column]]" localize="[[_boundedLocalize]]">
                </px-data-grid-cell-content-wrapper>
              </template>
            </dom-if>
          </template>
        </px-data-grid-column>
      </template>

      <vaadin-grid-column-group>
        <template is="dom-if" if="[[_offerEditColumn(editable)]]" restamp="">
          <px-data-grid-edit-column editted-item="[[_editingItem]]" edit-mode="[[editable]]" edit="[[_boundedEditItem]]" cancel="[[_boundedCancelEdit]]">
          
        </px-data-grid-edit-column></template>

        <template is="dom-if" if="[[_offerActionColumn(editable, itemActions, _editingItem)]]" restamp="">
          <px-data-grid-action-column item-actions="[[itemActions]]" editted-item="[[_editingItem]]" edit-mode="[[editable]]" save="[[_boundedSaveItem]]">
          
        </px-data-grid-action-column></template>
      </vaadin-grid-column-group>
    </vaadin-grid>

    <px-spinner size="40" hidden$="[[_spinnerHidden]]"></px-spinner>
  </template>
  <script>{var DataGridElement=function(_Predix$DataGridFilte){babelHelpers.inherits(DataGridElement,_Predix$DataGridFilte);babelHelpers.createClass(DataGridElement,[{key:"updateColumns",value:function updateColumns(){for(var _this2=this,probs=["hidden","name","frozen","width","flexGrow","path"],_loop=function _loop(i){var prefix="columns."+i+".";probs.forEach(function(prob){var path=prefix+prob;_this2.notifyPath(path)})},i=0;i<this.columns.length;++i){_loop(i)}}}],[{key:"is",get:function get(){return"px-data-grid"}},{key:"properties",get:function get(){return{tableData:{type:Array,notify:!0},hideSelectionColumn:{type:Boolean,value:!1},selectedItems:{type:Array,value:function value(){return[]},notify:!0},size:{type:Number,value:void 0},pageSize:{type:Number,value:void 0},multiSort:{type:Boolean,value:!1},selectionMode:{type:String,value:"none",observer:"_selectionModeChanged"},activeItem:{type:Object,notify:!0,value:null},resizable:{type:Boolean,value:!1},editable:{type:Boolean,value:!1},columnReorderingAllowed:{type:Boolean,value:!1},expandedItems:{type:Array,value:[],notify:!0},_rowDetails:{type:Boolean,value:!1},hideActionMenu:{type:Boolean,value:!1},_actionMenuShown:{type:Boolean,computed:"_showActionMenu(hideActionMenu, _actionMenuContent)"},columns:{type:Array,value:function value(){return[]},observer:"_columnsChanged"},_lastColumnsReceived:{type:Array,value:function value(){return[]}},_actionMenuContent:{type:Array},_columnSelectorContent:{type:Array},_columnSelectorLabel:{type:String,computed:"_computeColumnSelectorLabel(_selectedActionItems)"},language:{type:String,value:"en"},useKeyIfMissing:{type:Boolean,value:!0},resources:{type:Object,value:function value(){return{en:{Actions:"Actions","column selected":"column selected","columns selected":"columns selected","Freeze column":"Freeze Column","Unfreeze column":"Unfreeze Column","Group by column":"Group by Column",Ungroup:"Ungroup","Hide column":"Hide Column"},fr:{Actions:"Actions","Value is required":"Pakollinen arvo"},fi:{Actions:"Toiminnot","Hide column":"Piilota sarake"}}}},tableActions:{type:Array,value:[],observer:"_updateActionMenu"},hideColumnFilter:{type:Boolean,value:!1},itemActions:{type:Array,value:[]},remoteDataProvider:{type:Function,observer:"_remoteDataProviderChanged"},_currentDataProvider:{type:Function},_expandableRows:{type:Boolean,value:!1},striped:{type:Boolean,value:!1},ellipsis:{type:Boolean,value:!1,observer:"_ellipsisModeChanged"},_loading:{type:Boolean,value:!1,observer:"_loadingChanged"},_spinnerHidden:{type:Boolean,value:!0},loadingSpinnerDebounce:{type:Number,value:500},autoFilter:{type:Boolean,value:!1},highlight:{type:Array,value:function value(){return[]}},_highlightEntities:{type:Array,value:function value(){return[]}},_hasLocalDataProvider:{type:Boolean},defaultColumnWidth:{type:String,value:"100px"},defaultColumnFlexGrow:{type:Number,value:1},_selectedActionItems:{type:Array,value:[]},_groupByColumn:{type:Object,value:!1},gridHeight:{type:String,reflectToAttribute:!0,observer:"_gridHeightChanged"},flexToSize:{type:Boolean,value:!1,reflectToAttribute:!0},itemIdPath:{type:String},offerFilterSaving:{type:Boolean,value:!1},allowSortBySelection:{type:Boolean,value:!1},instantSortWhenSelection:{type:Boolean,value:!1},compactAdvancedFilterDialog:{type:Boolean,value:!0},stringComparators:{type:Array},numberComparators:{type:Array},_editingItem:{type:Object,value:null,observer:"_editingItemObserver"},_editingRenderers:{type:Array,value:function value(){return[]}},_boundedLocalize:Function,_autoFilterValue:{type:String}}}},{key:"observers",get:function get(){return["_highlightsObserver(highlight, _filterHighlights, highlight.*, _filterHightlights.*)","_localizeChanged(localize)","_tableDataChanged(tableData, tableData.*, isAttached)","_setColumnId(columns, columns.*)","_selectedItemsChanged(selectedItems.*)"]}}]);function DataGridElement(){var _this;babelHelpers.classCallCheck(this,DataGridElement);_this=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(DataGridElement).call(this));_this._observer=new Polymer.FlattenedNodesObserver(babelHelpers.assertThisInitialized(babelHelpers.assertThisInitialized(_this)),function(info){_this._checkRowDetailsTemplate(info.addedNodes)});return _this}babelHelpers.createClass(DataGridElement,[{key:"_checkRowDetailsTemplate",value:function _checkRowDetailsTemplate(nodes){var rowDetailsTemplate=nodes.filter(function(node){return node.localName&&"template"===node.localName&&node.className&&-1!==node.className.indexOf("row-details")});this._rowDetails=rowDetailsTemplate.length;if(this._rowDetails){this._expandableRows=!0;this._vaadinGrid._rowDetailsTemplate=rowDetailsTemplate[0];var templatizer=new Vaadin.Grid.Templatizer;templatizer._grid=this._vaadinGrid;templatizer.dataHost=this._vaadinGrid.dataHost;templatizer.template=this._vaadinGrid._rowDetailsTemplate;this._vaadinGrid._rowDetailsTemplate.templatizer=templatizer}}},{key:"ready",value:function ready(){var _this3=this;babelHelpers.get(babelHelpers.getPrototypeOf(DataGridElement.prototype),"ready",this).call(this);this._vaadinGrid=this.shadowRoot.querySelector("vaadin-grid");this._vaadinGrid._pxDataGrid=this;this._vaadinGrid.addEventListener("px-sorter-changed",this._onPxSorterChanged);this._boundedScrollListener=this._scrollListener.bind(this);this._vaadinGrid.$.outerscroller.addEventListener("scroll",this._boundedScrollListener);this._vaadinGrid.selectItem=function(item){return _this3._handleSelectItem(item)};this._boundedGetItemId=this._gridGetItemId.bind(this);this._vaadinGrid.getItemId=this._boundedGetItemId;this.addEventListener("column-froze",function(event){return _this3._handleColumnFreeze(event)});this.addEventListener("column-unfroze",function(event){return _this3._handleColumnUnfreeze(event)});this.addEventListener("group-by-column",function(event){if(_this3._groupByColumn){_this3._ungroup()}_this3._moveColumnToLeft(event.detail.column);_this3._groupByColumn=event.detail.column;_this3._vaadinGrid.clearCache();_this3._vaadinGrid.setAttribute("tree-grid",!0)});this.addEventListener("ungroup",function(event){_this3._ungroup()});this.addEventListener("item-save",function(){if(_this3._groupByColumn){_this3._vaadinGrid.clearCache()}});this._boundedCancelEdit=this._cancelEdit.bind(this);this._boundedSaveItem=this._saveItem.bind(this);this._boundedEditItem=this._setEditingItem.bind(this);document.addEventListener("renderer-editing-changed",function(event){var renderer=event.detail.renderer;if(renderer._editing){_this3._editingRenderers.push(renderer)}else{_this3._editingRenderers.splice(_this3._editingRenderers.indexOf(renderer),1)}});if(this._vaadinGrid._safari){var tbodyelement=this._vaadinGrid.$.table.querySelector("#items");tbodyelement.addEventListener("mouseover",this._onRowHoverEvent.bind(this));tbodyelement.addEventListener("mouseout",this._onRowUnhoverEvent.bind(this))}}},{key:"_onRowHoverEvent",value:function _onRowHoverEvent(event){var searchElement=event.target.offsetParent;while(searchElement){if(searchElement.tagName&&"tr"==searchElement.tagName.toLowerCase()){searchElement.classList.add("safari-hover");this.lastColumnWithSafariStyleForHover=searchElement;break}searchElement=searchElement.offsetParent}}},{key:"_onRowUnhoverEvent",value:function _onRowUnhoverEvent(event){if(this.lastColumnWithSafariStyleForHover){this.lastColumnWithSafariStyleForHover.classList.remove("safari-hover")}}},{key:"_ungroup",value:function _ungroup(){this._groupByColumn=!1;this._vaadinGrid.clearCache();this._vaadinGrid.removeAttribute("tree-grid")}},{key:"_resolveLastFrozenColumnIndex",value:function _resolveLastFrozenColumnIndex(){for(var lastColumnFrozen=void 0,columns=this._getColumns(),i=0;i<columns.length;++i){if(columns[i].frozen){lastColumnFrozen=i}}return lastColumnFrozen}},{key:"_columnSanityCheck",value:function _columnSanityCheck(){var lastColumnFrozen=this._resolveLastFrozenColumnIndex();if(lastColumnFrozen!==void 0){var columns=this._getColumns(),lastFrozenColumn=columns[lastColumnFrozen];if(0<lastColumnFrozen){for(var i=0;i<lastColumnFrozen;++i){if(!columns[i].frozen){columns[i].frozen=!0;if(columns[i].mappedObject){columns[i].mappedObject.frozen=!0}}}}columns.forEach(function(c){return c._lastFrozenChanged(c===lastFrozenColumn)})}}},{key:"_handleColumnFreeze",value:function _handleColumnFreeze(event){var column=event.detail.column;this._moveColumnToLeft(column)}},{key:"_moveColumnToLeft",value:function _moveColumnToLeft(column){var columns=this._getColumns(),columnId=column.mappedObject?column.mappedObject.id:void 0;if(columnId===void 0){console.warn("Failed to resolve column ID of frozen column");return}for(var firstDataColumnIndex=0,i=0;i<columns.length;i++){if(columns[i].isDataColumn&&columns[i]!==this._groupByColumn){firstDataColumnIndex=i;break}}for(var targetColumnIndex=0,_i=0;_i<columns.length;_i++){if(columns[_i].isDataColumn){var columnObj=columns[_i].mappedObject;if(columnObj&&columnObj.id===columnId){targetColumnIndex=_i;break}}}this._vaadinGrid.insertBefore(columns[targetColumnIndex],columns[firstDataColumnIndex])}},{key:"_handleColumnUnfreeze",value:function _handleColumnUnfreeze(event){var lastFrozen=this._getColumns().filter(function(column){return column._lastFrozen})[0];if(lastFrozen){this._vaadinGrid.insertBefore(event.detail.column,lastFrozen.nextSibling)}}},{key:"_doInstantSortAfterSelect",value:function _doInstantSortAfterSelect(){return this.instantSortWhenSelection&&this.allowSortBySelection&&0<Array.from(this._vaadinGrid._sorters).map(function(s){return s.path}).filter(function(p){return"--selection--"===p}).length}},{key:"_selectedItemsChanged",value:function _selectedItemsChanged(selectedItems){if(this._vaadinGrid&&this._doInstantSortAfterSelect()){this._vaadinGrid.clearCache()}}},{key:"_groupByColumnAllowed",value:function _groupByColumnAllowed(hasLocalDataProvider,expandableRows){return hasLocalDataProvider&&!expandableRows}},{key:"_handleSelectItem",value:function _handleSelectItem(item){if(!this._vaadinGrid._isSelected(item)){if(!this._isMultiSelect()){this._vaadinGrid.pop("selectedItems")}this._vaadinGrid.push("selectedItems",item)}}},{key:"_getValue",value:function _getValue(column,item){if(column&&item){return this.get(column.path,item)}else{return}}},{key:"_getColumnWidth",value:function _getColumnWidth(column){return column.width?column.width:this.defaultColumnWidth}},{key:"_getColumnFlexGrow",value:function _getColumnFlexGrow(column){return column.flexGrow===void 0?this.defaultColumnFlexGrow:column.flexGrow}},{key:"_resolveCellColor",value:function _resolveCellColor(item,column){var _this4=this;if(!this._highlightEntities||item===void 0){return}var columnColor,rowColor,cellColor;this._highlightEntities.forEach(function(highlightEntity){if("row"===highlightEntity.type){if(_this4._isRowConditionApplied(item,highlightEntity.condition)){if(highlightEntity.color){rowColor=highlightEntity.color}else{rowColor="default"}}}else if("column"===highlightEntity.type){if(_this4._isColumnConditionApplied(column,highlightEntity.condition)){if(highlightEntity.color){columnColor=highlightEntity.color}else{columnColor="default"}}}else{var value=_this4._getValue(column,item);if(highlightEntity.condition(value,column,item)){if(highlightEntity.color){cellColor=highlightEntity.color}else{cellColor="default"}}}});var finalColor=cellColor?cellColor:rowColor?rowColor:columnColor?columnColor:void 0;return finalColor}},{key:"_isRowConditionApplied",value:function _isRowConditionApplied(item,condition){var _this5=this;return!!this.columns.filter(function(column){var cellText=_this5.get(column.name,item);return condition(cellText,item)}).length}},{key:"_isColumnConditionApplied",value:function _isColumnConditionApplied(column,condition){var cachedItems=this._vaadinGrid._cache.items,itemsArray=Object.keys(cachedItems).map(function(key){return cachedItems[key]});return!!itemsArray.filter(function(item){return condition(column,item)}).length}},{key:"_tableDataChanged",value:function _tableDataChanged(tableData,splices,isAttached){var _this6=this;if(!isAttached){return}if(0<this.selectedItems.length){this.selectedItems=[]}if(tableData){this._currentDataProvider=function(params,callback){_this6._localDataProvider(params,function(items,size){callback(items,size);_this6._populateTableColumns(items)})};this._hasLocalDataProvider=!0}this._editingItem=null}},{key:"_compareValues",value:function _compareValues(a,b,path,direction){var column=this._getColumnByPath(path),valueA="--selection--"===path?!this._vaadinGrid._isSelected(a):Polymer.Base.get(path,a),valueB="--selection--"===path?!this._vaadinGrid._isSelected(b):Polymer.Base.get(path,b);if("date"===column.type){var momentA=this._getMomentObj(valueA,path),momentB=this._getMomentObj(valueB,path),compareVal=this._compareMomentObj(momentA,momentB,direction);if(compareVal!==void 0){return compareVal}}if("asc"===direction){return this._compare(valueA,valueB)}else if("desc"===direction){return this._compare(valueB,valueA)}else{return 0}}},{key:"_compareMomentObj",value:function _compareMomentObj(momentA,momentB,direction){if(!momentA||!momentB){return}if(momentA.isBefore(momentB)){return"asc"===direction?-1:1}if(momentA.isSame(momentB)){return 0}if(momentA.isAfter(momentB)){return"asc"===direction?1:-1}}},{key:"_getMomentObj",value:function _getMomentObj(value,path){var column=this._getColumnByPath(path),dateFormat=column.dateFormat||{},timezone=dateFormat.timezone||"utc",format=dateFormat.format;if(format){if("ISO"===format){return window.Px.moment(value)}else{return window.Px.moment.tz(value,format,timezone)}}}},{key:"_getColumnByPath",value:function _getColumnByPath(columnPath){if(!this.columns){return}return this.columns.filter(function(column){return column.path===columnPath})[0]}},{key:"_localDataResolver",value:function _localDataResolver(params,items){var _this7=this;if(params.filters){var autoFilters=params.filters.filter(function(filter){return filter.value.isAutoFilter});if(autoFilters.length&&this._vaadinGrid._checkPaths(autoFilters,"filtering",items)){items=this._applyAutoFilter(items,autoFilters)}var advancedFilters=params.filters.filter(function(filter){return filter.value.isAdvancedFilter}).map(function(filter){return filter.value.filter});if(advancedFilters&&0!=advancedFilters.length){items=this._applyCustomFilter(items,this.columns,advancedFilters)}}if(params.sortOrders&&params.sortOrders.length&&this._vaadinGrid._checkPaths(this._sorters,"sorting",items)){var multiSort=function multiSort(a,b){return params.sortOrders.map(function(sort){if("asc"===sort.direction||"desc"===sort.direction){return _this7._compareValues(a,b,sort.path,sort.direction)}else{return 0}}).reduce(function(p,n){return p?p:n},0)};items=items.slice(0).sort(multiSort)}return items}},{key:"_gridGetItemId",value:function _gridGetItemId(item){if(this._groupByColumn&&item&&item._groupId){return item._groupId}else{return this.itemIdPath?this._vaadinGrid.get(this.itemIdPath,item):item}}},{key:"_localDataProvider",value:function _localDataProvider(params,callback){var _this8=this,items=(Array.isArray(this.tableData)?this.tableData:[]).slice(0);items=this._localDataResolver(params,items);if(this._groupByColumn){var columnPath=this._groupByColumn.path;if(!params.parentItem){var valuesMap=items.reduce(function(map,item){var value=item[columnPath],groupItem=Object.assign({},item);for(var i in groupItem){if(i!==columnPath){groupItem[i]=""}}if(_this8._groupByColumn.mappedObject){groupItem._groupId="--group--"+_this8._groupByColumn.mappedObject.id+"-"+value}groupItem.hasChildren=!0;map.set(value,groupItem);return map},new Map);items=[];valuesMap.forEach(function(item){return items.push(item)})}else{items=items.filter(function(item){return item[columnPath]===params.parentItem[columnPath]})}}var totalSize=items.length,start=params.page*params.pageSize,end=start+params.pageSize;items=items.slice(start,end);callback(items,totalSize)}},{key:"_getAllLocalItems",value:function _getAllLocalItems(){if(this._hasLocalDataProvider){var items=(Array.isArray(this.tableData)?this.tableData:[]).slice(0);return this._localDataResolver({page:0,pageSize:this.tableData.length},items)}else{return[]}}},{key:"_remoteDataProviderChanged",value:function _remoteDataProviderChanged(provider){var _this9=this;this._hasLocalDataProvider=!1;this._currentDataProvider=function(params,callback){provider(params,function(items,size){callback(items,size);_this9._populateTableColumns(items)})}}},{key:"_resolveColumnPath",value:function _resolveColumnPath(column){if("undefined"===typeof column.path){console.warn("column.path for column ".concat(JSON.stringify(column)," should be initialized."))}return column.path?column.path:""}},{key:"_populateTableColumns",value:function _populateTableColumns(data){if(!this.columns.length&&data&&data.length){this.columns=[];for(var key in data[0]){this.push("columns",{name:key,hidden:!1,editable:!0,renderer:"px-data-grid-string-renderer",type:"string",path:key,generated:!0})}}this._updateActionMenu(this.tableActions);this._updateColumnSelector()}},{key:"_actionClicked",value:function _actionClicked(evt){var item=evt.detail.detail.item,key=item.key;if(key&&"string"==typeof key){if(0===key.indexOf("-column-")){var columnId=key.substr("-column-".length),column=this._getColumnElementById(columnId);if(column){column.hidden=column.hidden===void 0?!0:!column.hidden}else{console.warn("Failed to find column with ID "+columnId)}}else if(0===key.indexOf("-action-")){var actionId=key.substr("-action-".length);this.dispatchEvent(new CustomEvent("table-action",{detail:{id:actionId},composed:!0,bubbles:!0}))}else if(0===key.indexOf("-internal-ungroup-")){this._ungroup()}}}},{key:"_getColumns",value:function _getColumns(){return this._vaadinGrid?Array.from(this._vaadinGrid.querySelectorAll("px-data-grid-column")):[]}},{key:"_updateColumnSelector",value:function _updateColumnSelector(){var _this10=this,content=[];this._selectedActionItems=[];var defaultName=this.localize("Column #"),counter=0,selected=[],oneVisibleColumn=1==this.getVisibleColumns().length;this._getColumns().forEach(function(columnElement){var columnId=columnElement.mappedObject?columnElement.mappedObject.id:void 0;if(columnId===void 0){return}var index=++counter,hidden=columnElement.hidden?columnElement.hidden:!1,name=columnElement.name?columnElement.name:defaultName+index,key="-column-"+columnId,groupedByThis=_this10._groupByColumn===columnElement,item={key:key,val:name,disabled:groupedByThis||oneVisibleColumn&&!hidden};if(!hidden){selected.push(key)}content.push(item)});this._columnSelectorContent=content;setTimeout(function(){_this10._selectedActionItems=selected})}},{key:"_computeColumnSelectorLabel",value:function _computeColumnSelectorLabel(selectedItems){var columnsSelected=selectedItems.length,selectionText=1<columnsSelected?"columns selected":"column selected";return"".concat(columnsSelected," ").concat(this.localize(selectionText))}},{key:"_updateActionMenu",value:function _updateActionMenu(tableActions){var content=[];if(tableActions){tableActions.forEach(function(item){content.push({key:"-action-"+item.id,val:item.name,selected:!1,icon:item.icon,disabled:item.disabled||!1,disableSelect:!0})})}if(this._groupByColumn){content.push({key:"-internal-ungroup-",val:this.localize("Clear Grouping"),icon:"px-nav:reload",selected:!1,disableSelect:!0})}this._actionMenuContent=content}},{key:"_getColumnsWithName",value:function _getColumnsWithName(name){return this._getColumns().filter(function(c){return c.name==name})}},{key:"_getColumnById",value:function _getColumnById(columnId){return this.columns.filter(function(column){return column.id===columnId})[0]}},{key:"_getColumnElementById",value:function _getColumnElementById(columnId){return this._getColumns().filter(function(column){return column.mappedObject&&column.mappedObject.id==columnId})[0]}},{key:"_scheduleColumnSanityCheck",value:function _scheduleColumnSanityCheck(){var _this11=this;this._columnSanityCheckDebouncer=Polymer.Debouncer.debounce(this._columnSanityCheckDebouncer,Polymer.Async.idlePeriod,function(){_this11._columnSanityCheck()})}},{key:"_onColumnUpdate",value:function _onColumnUpdate(event){if("hidden"==event.detail.type){this._updateColumnSelector()}else if("frozen"==event.detail.type){this._scheduleColumnSanityCheck()}}},{key:"_loadingChanged",value:function _loadingChanged(loading){var _this12=this;clearTimeout(this._spinnerHiddenTimeout);if(loading){this._spinnerHiddenTimeout=setTimeout(function(){return _this12._spinnerHidden=!1},this.loadingSpinnerDebounce)}else{this._spinnerHidden=!0}}},{key:"_showActionBar",value:function _showActionBar(filterField,hideActionMenu,filterable){return filterField||!hideActionMenu||filterable}},{key:"_showActionMenu",value:function _showActionMenu(){var hide=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1,tableActions=1<arguments.length&&arguments[1]!==void 0?arguments[1]:[];return!hide&&0<tableActions.length}},{key:"resolveColumnHeader",value:function resolveColumnHeader(column){return column.header?column.header:column.name}},{key:"_applyAutoFilter",value:function _applyAutoFilter(items,filters){var _this13=this;return items.filter(function(item,index){return 0===filters.filter(function(filter){var filterValueLowercase=_this13._vaadinGrid._normalizeEmptyValue(filter.value.query).toString().toLowerCase();if(item&&filter.path===void 0){for(var key in item){var value=_this13._vaadinGrid._normalizeEmptyValue(Polymer.Base.get(key,item));if(-1!==value.toString().toLowerCase().indexOf(filterValueLowercase)){return!1}}return!0}else{var _value=_this13._vaadinGrid._normalizeEmptyValue(Polymer.Base.get(filter.path,item));return-1===_value.toString().toLowerCase().indexOf(filterValueLowercase)}}).length})}},{key:"_autoFilterChanged",value:function _autoFilterChanged(event){if(!this.autoFilter){return}else{var filters=this._vaadinGrid._filters.filter(function(filter){return!filter.value.isAutoFilter});filters.push({value:{query:event.detail.value,isAutoFilter:!0}});this._vaadinGrid._filters=filters;this._vaadinGrid.clearCache()}}},{key:"_isGroupedByColumn",value:function _isGroupedByColumn(column,_groupByColumn){return _groupByColumn&&_groupByColumn.name===column.name}},{key:"_columnOrderCleaner",value:function _columnOrderCleaner(){var _this14=this,columnsRow=this._getColumns(),leftColumns=columnsRow.filter(function(c){return!c.isDataColumn&&c.frozen}),rightColumns=columnsRow.filter(function(c){return c.isDataColumn||!c.frozen});if(leftColumns&&leftColumns.length&&rightColumns&&rightColumns.length){var firstRight=rightColumns[0];leftColumns.forEach(function(c){_this14._vaadinGrid.insertBefore(c,firstRight)})}}},{key:"_isSelectable",value:function _isSelectable(){return"single"==this.selectionMode||"multi"==this.selectionMode}},{key:"_isMultiSelect",value:function _isMultiSelect(){return this._isSelectable()&&"multi"==this.selectionMode}},{key:"_selectionModeChanged",value:function _selectionModeChanged(mode){var _this15=this;if("none"!=mode&&"single"!=mode&&"multi"!=mode){console.warn("Invalid selection-mode value '"+mode+"', use 'none', 'single' or 'multi'");return}var selectable="none"!=mode;if("none"===mode&&this._vaadinGrid){this._vaadinGrid.selectedItems=[]}if("single"===mode&&this._vaadinGrid&&1<this._vaadinGrid.selectedItems.length){this._vaadinGrid.selectedItems=[]}if(selectable){setTimeout(function(){if(_this15.selectable){_this15._columnOrderCleaner()}})}Polymer.RenderStatus.afterNextRender(this._vaadinGrid,function(){return _this15._vaadinGrid.notifyResize()})}},{key:"_highlightsObserver",value:function _highlightsObserver(highlight,filterHighlights){this.set("_highlightEntities",highlight.concat(filterHighlights))}},{key:"_gridHeightChanged",value:function _gridHeightChanged(gridHeight){var _this16=this;if(!this._vaadinGrid){return}if(!this.gridHeight||"default"==this.gridHeight||"auto"==this.gridHeight){this._vaadinGrid.style.height=null}else{this._vaadinGrid.style.height=this.gridHeight}Polymer.RenderStatus.afterNextRender(this._vaadinGrid,function(){return _this16._vaadinGrid.notifyResize()})}},{key:"setRowDetailsVisible",value:function setRowDetailsVisible(item,isVisible){var _this17=this;if(!item){return}var index=this._vaadinGrid.detailsOpenedItems.indexOf(item);if(isVisible&&0>index){this._vaadinGrid.detailsOpenedItems.push(item);Polymer.RenderStatus.afterNextRender(this._vaadinGrid,function(){return _this17._vaadinGrid.notifyResize()})}else if(!isVisible&&0<=index){this._vaadinGrid.detailsOpenedItems.splice(index,1);Polymer.RenderStatus.afterNextRender(this._vaadinGrid,function(){return _this17._vaadinGrid.notifyResize()})}}},{key:"_editingItemObserver",value:function _editingItemObserver(editingItem,oldV){if("undefined"===typeof oldV){return}this.dispatchEvent(new CustomEvent("editing-item-changed",{bubbles:!0,composed:!0,detail:{item:editingItem}}))}},{key:"_setEditingItem",value:function _setEditingItem(event){event.stopPropagation();this._editingItem=event.details.item;this._vaadinGrid.notifyResize()}},{key:"_cancelEdit",value:function _cancelEdit(event){this._editingRenderers.forEach(function(renderer){return renderer.restoreInitial()});this._editingItem=null;this._vaadinGrid.notifyResize()}},{key:"_isItemEditing",value:function _isItemEditing(item,editingItem){return item===editingItem}},{key:"_isAnyItemEditing",value:function _isAnyItemEditing(editingItem){return!!editingItem}},{key:"_saveItem",value:function _saveItem(){if(this._editingRenderers.every(function(renderer){return renderer._performValidation().valid})){var changedPaths=this._editingRenderers.filter(function(renderer){return renderer.applyValue()}).map(function(renderer){return renderer.column.path});if(0<changedPaths.length){this.dispatchEvent(new CustomEvent("item-edited",{bubbles:!0,composed:!0,detail:{item:this._editingItem,paths:changedPaths}}))}this._editingItem=null;this._vaadinGrid.notifyResize()}}},{key:"_localizeChanged",value:function _localizeChanged(localize){this._boundedLocalize=localize.bind(this)}},{key:"_scrollListener",value:function _scrollListener(e){if(0!=e.target.scrollLeft){this._vaadinGrid.setAttribute("horizontal-offset","true")}else{this._vaadinGrid.removeAttribute("horizontal-offset")}}},{key:"_onPxSorterChanged",value:function _onPxSorterChanged(e){var _this18=this;this._pxDataGrid._editingItem=null;var sorter=e.detail.sorter;this._removeArrayItem(this._sorters,sorter);sorter._order=null;if(this.multiSort){if(sorter.direction){this._sorters.push(sorter)}this._sorters.forEach(function(sorter,index){return sorter._order=1<_this18._sorters.length?index:null},this)}else{this._sorters.forEach(function(sorter){sorter._order=null;sorter.direction=null});if(sorter.direction){this._sorters=[sorter]}}e.stopPropagation();if(this.dataProvider&&JSON.stringify(this._previousSorters)!==JSON.stringify(this._mapSorters())){this.clearCache()}this._a11yUpdateSorters();this._previousSorters=this._mapSorters()}},{key:"getVisibleColumns",value:function getVisibleColumns(){return this._getColumns().filter(function(col){return!col.hidden}).sort(function(a,b){return a._order-b._order})}},{key:"getData",value:function getData(visibleOnly){var _this19=this,items=[];if(visibleOnly){items=Array.from(this._vaadinGrid.querySelectorAll("px-data-grid-cell-content-wrapper"));var gridRect=this._vaadinGrid.getBoundingClientRect(),headerRect=this._vaadinGrid.querySelector("px-data-grid-header-cell").getBoundingClientRect();items=items.filter(function(wrapper){var wrapperRect=wrapper.getBoundingClientRect();return wrapperRect.top<gridRect.bottom&&wrapperRect.bottom>headerRect.bottom}).map(function(wrapper){return wrapper.item}).filter(function(v,i,a){return a.indexOf(v)===i&&v})}else{var cachedItems=this._vaadinGrid._cache.items;Object.keys(cachedItems).forEach(function(key){items.push(cachedItems[key])})}return items.map(function(item){var sortedObject={};_this19.getVisibleColumns().forEach(function(col){sortedObject[col.path]=item[col.path]});return sortedObject})}},{key:"_cleanColumns",value:function _cleanColumns(columns){if(!columns){return[]}return this._copyArray(columns)}},{key:"_columnsChanged",value:function _columnsChanged(columns){var _this20=this;this._lastColumnsReceived=this._cleanColumns(columns);Polymer.RenderStatus.afterNextRender(this._vaadinGrid,function(){return _this20._updateColumnSelector()})}},{key:"_setColumnId",value:function _setColumnId(columns){var _this21=this;if(!columns||this._columnIdSetting){return}this._columnIdSetting=!0;columns.forEach(function(column,index){if(!column.id){_this21.set("columns.".concat(index,".id"),"".concat(column.path,"[").concat(column.type||"string","]"));if(1<columns.filter(function(col){return col.id===column.id}).length){console.warn("Warning! There are multiple columns with '".concat(column.path,"' path ")+"and '".concat(column.type||"string","' type, please provide column.id for those columns"))}}});this._columnIdSetting=!1}},{key:"restoreLayout",value:function restoreLayout(){if(!this._lastColumnsReceived){console.warn("No layout defined where to return");return}var revertTo=this._lastColumnsReceived;this._revertColumns(revertTo)}},{key:"_revertColumns",value:function _revertColumns(revertTo){var _this22=this;this.columns=[];Polymer.RenderStatus.afterNextRender(this._vaadinGrid,function(){return _this22.columns=revertTo})}},{key:"_undefinedToFalse",value:function _undefinedToFalse(value){if(value===void 0){return!1}else{return value}}},{key:"_copyArray",value:function _copyArray(arr){return JSON.parse(JSON.stringify(arr))}},{key:"_isAutoHeight",value:function _isAutoHeight(gridHeight){return"auto"===gridHeight}},{key:"_checkColumnResizable",value:function _checkColumnResizable(gridResizable,columnResizable){return gridResizable?columnResizable===void 0?!0:columnResizable:!1}},{key:"_isStriped",value:function _isStriped(striped,groupByColumn){return striped&&!groupByColumn}},{key:"_ellipsisModeChanged",value:function _ellipsisModeChanged(ellipsisMode){if(ellipsisMode){this.classList.add("ellipsis")}else{this.classList.remove("ellipsis")}if(this._vaadinGrid){this._vaadinGrid.notifyResize()}}},{key:"_compare",value:function _compare(a,b){a=this._vaadinGrid._normalizeEmptyValue(a);b=this._vaadinGrid._normalizeEmptyValue(b);if("string"===typeof a&&"string"===typeof b){a=a.toUpperCase();b=b.toUpperCase()}if(a<b){return-1}if(a>b){return 1}return 0}},{key:"_offerEditColumn",value:function _offerEditColumn(editable){return editable}},{key:"_offerActionColumn",value:function _offerActionColumn(editable,itemActions,editingItem){return editable||itemActions&&0<itemActions.length}},{key:"_isColumnReorderingAllowed",value:function _isColumnReorderingAllowed(columnReordingAllowed,groupByColumn){return columnReordingAllowed&&!groupByColumn}},{key:"_openAdvancedFilter",value:function _openAdvancedFilter(event){this.shadowRoot.querySelector("px-data-grid-filters-modal").open()}},{key:"getState",value:function getState(){return{columns:this.getVisibleColumns(),highlight:this.highlight.map(function(entity){return Object.assign({},entity)}),filters:this._copyArray(this._filters),autoFilter:this._autoFilterValue}}},{key:"setState",value:function setState(state){var _this23=this;this.columns=[];Polymer.RenderStatus.afterNextRender(this._vaadinGrid,function(){_this23.columns=state.columns;_this23._filters=state.filters;_this23._autoFilterValue=state.autoFilter;_this23.highlight=state.highlight})}}]);return DataGridElement}(Predix.DataGridFilterableMixin(Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior],Polymer.Element)));customElements.define(DataGridElement.is,DataGridElement);window.Predix=window.Predix||{};Predix.DataGridElement=DataGridElement}</script>
</dom-module>
</body></html>