<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-icon-set/px-icon-set.html">
<link rel="import" href="../px-icon-set/px-icon.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="css/px-dropdown-styles.html">


</head><body><dom-module id="px-dropdown-content">
  <template>
    <style include="px-dropdown-styles"></style>
    <iron-a11y-keys id="keys" keys="up down space enter tab esc" target="[[keyBindingsTarget]]" on-keys-pressed="_handleKeyPress">
    </iron-a11y-keys>
    <iron-dropdown id="dropdown" class$="dropdown {{_getCaretClass(showCaret,mobile,verticalAlign,horizontalAlign)}}" auto-fit-on-attach="" fit-into="{{_getFitElement(boundTarget)}}" position-target="{{_getPositionElement(mobile,openTrigger)}}" dynamic-align="{{!disableDynamicAlign}}" vertical-offset="{{_getOffset(showCaret,triggerHeight,mobile)}}" vertical-align="{{_getVertical(verticalAlign,mobile)}}" horizontal-align="{{_getHorizontal(horizontalAlign,mobile)}}" opened="{{opened}}" hover="{{hover}}" no-cancel-on-outside-click="{{preventCloseOnOutsideClick}}" allow-outside-scroll="{{allowOutsideScroll}}" disabled$="{{disabled}}" with-backdrop="{{mobile}}">
      <div slot="dropdown-content" class="dropdown-content shadow-temporary">
        <slot name="header"></slot>
        <template is="dom-if" if="{{searchMode}}" value="{{searchTerm::input}}">
          <div class="u-p- fixed">
            <div class="search__form">
              <input class="text-input search__box" disabled$="[[disabled]]" placeholder="{{placeholder}}" value="{{searchTerm::input}}" on-input="_notifyResize" autocomplete="off">
              
              <px-icon class="search__icon" icon="px-utl:search"></px-icon>
            </div>
          </div>
        </template>
        <iron-selector id="selector" class="selector" multi="{{multi}}" selected="{{selected}}" selected-values="{{selectedValues}}" selected-items="{{selectedItems}}" attr-for-selected="{{selectBy}}">
          <template is="dom-repeat" id="dropdownItems" items="{{_computedItems}}" strip-whitespace="">
            <div class="dropdown-option" key="{{item.key}}" val="{{item.val}}" disabled$="{{item.disabled}}" disable-select="{{item.disableSelect}}" on-mouseover="_hoverOn" on-mouseout="_hoverOff" title="{{item.val}}">
              <template is="dom-if" if="{{_showCheckmark(multi,mobile)}}">
                <px-icon icon="px-utl:check" class="select-icon u-pr--"></px-icon>
              </template>
              <template is="dom-if" if="{{item.icon}}">
                <px-icon icon="{{item.icon}}" class="item-icon u-mr-" style$="color:{{item.color}};stroke:{{item.color}}"></px-icon>
              </template>
              <span class$="dropdown-option__item {{_getTruncateClass(disableTruncate)}}">{{item.val}}</span>
            </div>
          </template>
        </iron-selector>
        <template is="dom-if" if="{{_showButtons(mobile,hideMobileButtons)}}">
          <div class="flex flex--middle flex--right u-m- fixed">
            <template is="dom-if" if="{{!disableClear}}">
              <button class$="btn {{_showMobileClearButton(mobile,disableClear,selected,selectedValues,selectedValues.*)}}" on-tap="_handleClearTapped">[[localize('Clear')]]</button>
            </template>
            <template is="dom-if" if="{{multi}}">
              <button class="btn btn--primary u-ml-" on-tap="toggle">[[localize('Apply')]]</button>
            </template>
          </div>
        </template>
        <slot name="footer"></slot>
      </div>
    </iron-dropdown>
  </template>
</dom-module>
<script>Polymer({is:"px-dropdown-content",behaviors:[Polymer.AppLocalizeBehavior],properties:{openTrigger:{type:HTMLElement,observer:"_openTriggerChanged"},opened:{type:Boolean,notify:!0},hover:{type:Boolean,notify:!0},boundTarget:{type:String},preventCloseOnOutsideClick:{type:Boolean},disableClear:{type:Boolean},disableSelect:{type:Boolean},disableTruncate:{type:Boolean},displayValueSelected:{type:String,notify:!0},items:{type:Array,notify:!0},multi:{type:Boolean},selectBy:{type:String,observer:"_updateSelection"},selected:{type:String,notify:!0},selectedValues:{type:Array,notify:!0},selectedItems:{type:Array,readOnly:!0},allowOutsideScroll:{type:Boolean},disabled:{type:Boolean},searchMode:{type:Boolean},searchTerm:{type:String,observer:"_computeFilter"},sortMode:{type:String},triggerHeight:{type:Number},showCaret:{type:Boolean},disableDynamicAlign:{type:Boolean},verticalAlign:{type:String},horizontalAlign:{type:String},mobile:{type:Boolean,reflectToAttribute:!0},mobileAt:{type:Number},hideMobileButtons:{type:Boolean},language:{type:String,value:"en"},useKeyIfMissing:{type:Boolean,value:!0},resources:{type:Object,value:function value(){return{en:{Clear:"Clear",Apply:"Apply"}}}},keyBindingsTarget:{type:HTMLElement},_focusedOption:{type:HTMLElement},_keyboardBeingUsed:{type:Boolean,value:!1},_computedItems:{type:Array,value:function value(){return[]}}},listeners:{"iron-activate":"_handleActivate","iron-select":"_handleSelection","iron-deselect":"_handleDeselection","iron-overlay-canceled":"_handleCancel"},observers:["_itemsChanged(items, items.*)","_initSort(sortMode, _computedItems)"],created:function created(){this._handleOpenTriggerTappedBound=this.toggle.bind(this);this._handleClearTappedBound=this._handleClearTapped.bind(this);this._closeBound=this.close.bind(this)},attached:function attached(){Polymer.RenderStatus.afterNextRender(this,function(){this._updateSelection()}.bind(this))},toggle:function toggle(){this.$.dropdown.toggle()},_handleCancel:function _handleCancel(e){e.preventDefault();e.stopPropagation();if(-1===Polymer.dom(e.detail).path.indexOf(this.openTrigger)){this.$.dropdown.close()}},close:function close(){this.$.dropdown.close()},open:function open(){this.$.dropdown.open()},_openTriggerChanged:function _openTriggerChanged(newTrigger,oldTrigger){if(oldTrigger&&babelHelpers.instanceof(oldTrigger,HTMLElement)){oldTrigger.removeEventListener("tap",this._handleOpenTriggerTappedBound);oldTrigger.removeEventListener("clear-tapped",this._handleClearTappedBound)}if(newTrigger&&babelHelpers.instanceof(newTrigger,HTMLElement)){newTrigger.addEventListener("tap",this._handleOpenTriggerTappedBound,!1);newTrigger.addEventListener("clear-tapped",this._handleClearTappedBound,!1)}},_handleClearTapped:function _handleClearTapped(){this.set("selected",null);this.set("selectedValues",[]);if(this.multi){Polymer.dom(this.$.dropdown).querySelectorAll("input#option:checked").forEach(function(item){item.checked=!1})}if(!this.mobile)this.$.dropdown.close()},_updateSelection:function _updateSelection(){if(Array.isArray(this.items)&&0<this.items.length){var length,selected,i;if(this.multi){length=this.items.length;selected=Array.isArray(this.selectedValues)?this.selectedValues.slice(0):[];for(i=0;i<length;i++){if(this.items[i].selected!==void 0&&"true"===this.items[i].selected.toString()){if(selected&&-1===selected.indexOf(this.items[i][this.selectBy])){selected.push(this.items[i][this.selectBy])}}}this.selectedValues=selected}else{length=this.items.length;selected=this.selected;for(i=0;i<length;i++){if(this.items[i].selected!==void 0&&"true"===this.items[i].selected.toString()){if(selected!==this.items[i][this.selectBy]){this.set("selected",this.items[i][this.selectBy]);break}}}}}},_itemsChanged:function _itemsChanged(items){if(items===void 0)return;var newComputedItems=[];if(null!==items){items.forEach(function(item,idx){if("string"===typeof item){newComputedItems[idx]={key:idx,val:item}}else{newComputedItems[idx]=item}}.bind(this))}this._computedItems=newComputedItems;if(this.clearSelectionsOnChange){this.set("selected",null);this.set("selectedValues",[])}this._updateSelection();this._notifyResize()},_getFitElement:function _getFitElement(target){return Polymer.dom(document).querySelector(target)},_getPositionElement:function _getPositionElement(mobile,openTrigger){return mobile?window:openTrigger},_handleActivate:function _handleActivate(evt){if(evt.detail.item.hasAttribute("disabled")){evt.preventDefault()}else if(this.disableSelect||evt.detail.item.disableSelect){evt.preventDefault();this.fire("px-dropdown-click",evt);this.$.dropdown.close()}else{this.fire("px-dropdown-click",evt)}},_handleSelection:function _handleSelection(evt){if(this.multi&&1===this.selectedValues.length&&!this.hideSelected){this.displayValueSelected=this.$.selector.selectedItems[0].innerText.trim()}else if(this.multi&&1<this.selectedValues.length&&!this.hideSelected){this.displayValueSelected=this.selectedValues.length+" "+this.localize("selected")}else if(!this.hideSelected){this.displayValueSelected=this.$.selector.selectedItem?this.$.selector.selectedItem.val:this.displayValue;this.$.dropdown.close()}this.$.dropdown.notifyResize();this.fire("px-dropdown-selection-changed",{val:evt.detail.item.val,key:evt.detail.item.key,selected:!0})},_handleDeselection:function _handleDeselection(evt){if(this.multi&&1===this.$.selector.selectedItems.length&&!this.hideSelected){this.displayValueSelected=this.$.selector.selectedItems[0].innerText.trim()}else if(this.multi&&1<this.selectedValues.length&&!this.hideSelected){this.displayValueSelected=this.selectedValues.length+" "+this.localize("selected")}else{this.displayValueSelected=this.displayValue}this.$.dropdown.notifyResize();this.fire("px-dropdown-selection-changed",{val:evt.detail.item.val,key:evt.detail.item.key,selected:!1})},_notifyResize:function _notifyResize(){this.$.dropdown.notifyResize()},_computeFilter:function _computeFilter(){if(this.searchMode){var term=this.searchTerm.toLowerCase(),items=this.$.dropdown.querySelectorAll(".dropdown-option"),length=items.length,i;for(i=0;i<length;i++){this.toggleClass("hidden",-1===items[i].val.toString().toLowerCase().indexOf(term)&&-1===items[i].key.toString().toLowerCase().indexOf(term),items[i])}}},_showMobileClearButton:function _showMobileClearButton(mobile,disableClear,selected,selectedValues){if(mobile&&("string"===typeof selected||"number"===typeof selected||0<selectedValues.length)){return""}else{return"btn--disabled"}},_initSort:function _initSort(sortMode,items){if(sortMode!==void 0&&items!==void 0){this.$.dropdownItems.sort="_computeSort";this.$.dropdownItems.render()}},_bindMouse:function _bindMouse(){this._keyboardBeingUsed=!1;this.removeEventListener("mousemove",this._bindMouse)},_computeSort:function _computeSort(a,b){var sortValue=0;if(!this.sortMode){return-1}if(this.sortMode&&0===sortValue){if("key"===this.sortMode){sortValue=a.key-b.key}if("val"===this.sortMode){var nameA=a.val.toUpperCase(),nameB=b.val.toUpperCase();if(nameA<nameB){sortValue--}if(nameA>nameB){sortValue++}}}return sortValue},_setFocusedOption:function _setFocusedOption(newOption,oldOption){this._focusedOption=newOption;if(newOption){this.toggleClass("focused",!0,newOption)}if(oldOption){this.toggleClass("focused",!1,oldOption)}},_handleKeyPress:function _handleKeyPress(event){this._keyboardBeingUsed=!0;this.addEventListener("mousemove",this._bindMouse.bind(this));var keyPressed=event.detail.combo,options=this.$.selector.getEffectiveChildren().filter(function(node){return node.nodeType===Node.ELEMENT_NODE&&"DIV"===node.nodeName&&!node.hasAttribute("disabled")&&!node.classList.contains("hidden")}),focused=options.indexOf(this._focusedOption),searchFocused=this.searchMode&&Polymer.dom(this.$.dropdown).querySelector(":focus")===Polymer.dom(this.$.dropdown).querySelector(".search__box");switch(keyPressed){case"space":case"enter":if(searchFocused)break;if(!this.opened){this.toggle()}else if(-1!==focused){options[focused].click()}event.detail.keyboardEvent.preventDefault();break;case"esc":this.$.dropdown.close();break;case"tab":if(this.opened){this.$.dropdown.close()}break;case"down":if(!this.opened){this.toggle()}if(-1<focused&&focused<options.length-1){this._setFocusedOption(options[focused+1],options[focused]);this.$.dropdown.querySelector(".dropdown-content").scrollTop+=options[focused+1].offsetHeight}else if(focused===options.length-1){break}else if(-1===focused&&this.searchMode&&!searchFocused){Polymer.dom(this.$.dropdown).querySelector(".search__box").focus()}else if(searchFocused){Polymer.dom(this.$.dropdown).querySelector(".search__box").blur();this.$.trigger.focus();this._setFocusedOption(options[0])}else{this._setFocusedOption(options[0])}event.detail.keyboardEvent.preventDefault();break;case"up":if(!this.opened){this.toggle()}if(0<focused){this._setFocusedOption(options[focused-1],options[focused]);Polymer.dom(this.$.dropdown).querySelector(".dropdown-content").scrollTop-=options[focused].offsetHeight}else if(0===focused&&this.searchMode&&!searchFocused){Polymer.dom(this.$.dropdown).querySelector(".search__box").focus();this._setFocusedOption(null,options[0])}else if(-1===focused&&!searchFocused){this._setFocusedOption(options[options.length-1])}event.detail.keyboardEvent.preventDefault();break;}},_hoverOn:function _hoverOn(event){if(!this._keyboardBeingUsed&&!this.mobile){var currHighlightedItem=this.querySelector(".dropdown-option.focused");if(currHighlightedItem){this.toggleClass("focused",!1,currHighlightedItem)}this.toggleClass("focused",!0,Polymer.dom(event).localTarget)}},_hoverOff:function _hoverOff(event){this.toggleClass("focused",!1,Polymer.dom(event).localTarget)},_getCaretClass:function _getCaretClass(showCaret,mobile,verticalAlign,horizontalAlign){return showCaret&&!mobile?verticalAlign+" "+horizontalAlign:""},_getTruncateClass:function _getTruncateClass(disableTruncate){return disableTruncate?"":"truncate"},_getOffset:function _getOffset(showCaret,triggerHeight,mobile){return mobile?0:showCaret?triggerHeight+5:triggerHeight},_getVertical:function _getVertical(verticalAlign,mobile){return mobile?"middle":verticalAlign},_getHorizontal:function _getHorizontal(horizontalAlign,mobile){return mobile?"left":horizontalAlign},_showCheckmark:function _showCheckmark(multi,mobile){return multi&&!mobile},_showButtons:function _showButtons(mobile,hideMobileButtons){return mobile&&!hideMobileButtons}});</script>
</body></html>