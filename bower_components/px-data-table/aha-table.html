<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><!--
/**
 * @module aha-table
 *
 * Internal table helper component used by px-data-table.
 *
 * Originally based on https://github.com/liuwenchao/aha-table, but heavily modified.
 *
 */
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="px-pagination.html">
<link rel="import" href="px-data-table-cell.html">
<link rel="import" href="../px-icon-set/px-icon-set.html">
<link rel="import" href="../px-icon-set/px-icon.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="css/aha-table-styles.html">

</head><body><dom-module id="aha-table">
  <template>
    <style include="aha-table-styles"></style>
    <content id="columndefs"></content>

    <template is="dom-if" if="{{showColumnChooser}}">
      <div class="flex columnChooser u-mb-">
        <px-dropdown class="u-ml--" display-value="{{localize('Show/Hide Column')}}" items="{{_columnChooserItems}}" multi="" hide-selected="" clear-selections-on-change="">
        </px-dropdown>
      </div>
    </template>

    <div class="scroll-body">

      <div id="scrollBodyTableContainer" class$="table {{_getTableClass(tableCells, tableColumns)}}" role="grid">
        <!-- Header -->
        <div class="tr tr--header" role="row">
          <template is="dom-repeat" items="{{meta}}" as="column">
            <template is="dom-if" if="{{!column.hide}}">
              <span role="columnheader" class$="{{_getHeaderClass(column)}}" draggable="{{enableColumnReorder}}" on-touchstart="_dragStartColumnHeader" on-touchmove="_touchMoveHeader" on-touchleave="_dragLeave" on-touchend="_touchDropColumnHeader" on-dragleave="_dragLeave" on-dragstart="_dragStartColumnHeader" on-dragover="_dragOverHeader" on-drop="_dragDropColumnHeader" on-dragend="_dragEndColumnHeader">
                <div class="flex header--container">
                  <span class$="{{_getTextSortingClass(sortable, column, sortedColumn)}}" on-tap="_sort">{{column.label}}<px-icon icon$="{{_getSortingIcon(sortable, column, sortedColumn, descending)}}" class$="{{_getSortingClass(sortable, column, sortedColumn, descending)}}"></px-icon>
                  </span>
                  <template is="dom-if" if="{{!_isEqual(column.type, 'selected')}}">
                    <template is="dom-if" if="{{enableColumnResize}}">
                      <div class="header--drag-handle" on-down="_headerResizeMouseDown" on-track="_headerTrack"></div>
                    </template>
                  </template>
                </div>
              </span>
            </template>
          </template>
        </div>

        <!-- Second Header (filter/select all) -->
        <div class$="{{_getSecondHeaderClass(_enableFilterRow)}}" role="row">
          <template is="dom-repeat" items="{{meta}}" as="column" id="filterRepeat">
            <span class$="{{_getFilterHeaderClass(column)}}" role="gridcell" hidden$="{{column.hide}}">
              <!-- select all checkbox -->
              <template is="dom-if" if="{{_isEqual(column.type, 'selected')}}">
                <span class="flex" hidden$="{{column.hide}}">
                  <template is="dom-if" if="{{!singleSelect}}">
                    <input id="selectAllCheckbox" role="checkbox" aria-label="Click to select or deselect all rows" type="checkbox" on-change="_clickSelectAll">
                  </template>
                </span>
              </template>

              <!-- filter entry -->
              <template is="dom-if" if="{{_isFilterableColumn(column, filterable, column.hide)}}">
                <input role="textbox" aria-label="Enter text to filter column" placeholder="{{localize('Filter')}}" class="text-input text-input--filter" type="text" on-input="_filter">
              </template>
            </span>
          </template>
        </div>
        <!-- Data rows -->
        <template id="recordList" is="dom-repeat" items="{{displayedRows}}" as="internalRow" strip-whitespace="">

          <div role="row" class$="{{_getRowClass(internalRow,striped)}}">
            <!-- Data cells -->
            <template is="dom-repeat" items="{{meta}}" as="column">
              <!-- selected column checkbox or radio button -->
              <template is="dom-if" if="{{_isEqual(column.type, 'selected')}}">
                <span role="gridcell" class$="{{_getSelectedCellClass(internalRow._selected, internalRow._highlight)}}" hidden$="{{column.hide}}" on-tap="_clickRow">
                  <span class="flex flex--middle">
                    <template is="dom-if" if="{{!singleSelect}}">
                      <input role="checkbox" aria-label="Click to select row" type="checkbox" checked="{{internalRow._selected::change}}">
                    </template>
                    <template is="dom-if" if="{{singleSelect}}">
                      <input role="checkbox" aria-label="Click to select row" type="radio" name="selected" checked="{{internalRow._selected::change}}">
                    </template>
                  </span>
                </span>
              </template>
              <template id="cellRepeat" is="dom-if" if="{{!_isEqual(column.type, 'selected')}}">
                <template is="dom-if" if="{{!column.hide}}">
                  <px-data-table-cell on-save="_save" row-highlighted="[[internalRow._highlight]]" cell-highlighted="[[_getHighlightValue(internalRow, column, column.highlightdefined)]]" cell-selected="[[internalRow._selected]]" on-validate="_handleValidateEvent" cell-type="{{column.type}}" dropdown-items="{{column.dropdownItems}}" placeholder="{{column.placeholder}}" cell-display-value="{{_readContent(internalRow, column)}}" cell-value="{{_getInternalDataAt(internalRow, column.name)}}" cell-display-tooltip="{{_shouldClipDatumString(internalRow, column)}}" cell-editable="{{column.editable}}" cell-validation="{{_getInternalCellValidationStateAt(internalRow, column.name)}}" column-name="{{column.name}}" on-tap="_clickCell">
                  </px-data-table-cell>
                </template>
              </template>
            </template>
          </div>
        </template>
      </div>

      <template is="dom-if" if="{{!displayedRows.length}}">
        <div class="flex flex--center no-results">{{localize('No Results')}}</div>
      </template>
    </div>

    <!-- Pagination controls -->
    <div class="pagination">
      <px-pagination class$="{{_getPaginationVisibility(hidePaginationControl)}}" id="pagination" data-remote="{{dataRemote}}" number-of-items="{{_adaptedNumberOfItems}}" page-size="{{pageSize}}" page-size-options="{{pageSizeOptions}}" first-item-index-to-display="{{firstItemIndex}}" language="{{language}}" use-key-if-missing="{{useKeyIfMissing}}" resources="{{resources}}">
      </px-pagination>
    </div>
  </template>

</dom-module>
<script>Polymer({is:"aha-table",behaviors:[Polymer.AppLocalizeBehavior],properties:{data:{type:Array,notify:!0,value:function value(){return[]}},meta:{type:Array,value:function value(){return[]}},selectedRows:{type:Array,value:function value(){return[]},notify:!0},selectable:{type:Boolean,value:!1,observer:"_selectableChanged"},singleSelect:{type:Boolean,value:!1,observer:"_singleSelectChanged"},striped:{type:Boolean,value:!1},tableCells:{type:Boolean,value:!1},tableColumns:{type:Boolean,value:!1},filterable:{type:Boolean,value:!1},sortable:{type:Boolean,value:!1},includeAllColumns:{type:Boolean,value:!1,observer:"_includeAllColumnsChanged"},_enableFilterRow:{type:Boolean,value:!1},sortedColumn:{type:String,value:""},filteredColumns:{type:Array,value:function value(){return[]}},displayedRows:{type:Array,value:function value(){return[]}},descending:{type:Boolean,value:!1},totalEntries:{type:Number,value:10,observer:"_calculateAdaptedNumberOfItems"},firstItemIndex:{type:Number,value:1},dataRemote:{type:Boolean,value:!1},pageSize:{type:Number,value:10,observer:"_setPageSize"},_adaptedNumberOfItems:{type:Number},numberOfItems:{type:Number,observer:"_calculateAdaptedNumberOfItems"},hidePaginationControl:{type:Boolean,value:!1},showColumnChooser:{type:Boolean,value:!1},enableColumnReorder:{type:Boolean,value:!1},enableColumnResize:{type:Boolean,value:!1},_internalData:{type:Array,value:function value(){return[]}},_columnChooserItems:{type:Array,value:function value(){return[]}},_displayingInsertion:{type:Boolean,value:!1},_requestInsertionIndicatorRemoval:{type:Boolean,value:!1},_headerInitialSize:{type:Number,value:0},_columnDragged:{type:String,value:""},_isAttached:{type:Boolean,value:!1},scrollBody:{type:String,value:"#scrollBodyTableContainer"},dataChangeTrigger:{type:Boolean,value:!1},pageSizeOptions:{type:Array,value:function value(){return[{key:"1",val:"10"},{key:"2",val:"20"},{key:"3",val:"50"},{key:"4",val:"100"}]}}},observers:["_updateDisplayedRows(firstItemIndex)","_updateDisplayedRows(pageSize)","_dataChanged(data.*)","_computeColumnChooserItems(meta, meta.*)","_computeIfColumnFilterEnabled(meta.splices, filterable, meta.*, selectable, singleSelect)"],listeners:{validate:"_handleValidateEvent","px-dropdown-selection-changed":"_columnChooserChanged"},ready:function ready(){this.addEventListener("px-data-table-highlight-loaded",this._highlightLoaded.bind(this));var boundHandler=this._columnChanged.bind(this);this._observer=Polymer.dom(this.$.columndefs).observeNodes(boundHandler)},attached:function attached(){this._isAttached=!0},_columnChanged:function _columnChanged(info){if(this.selectable&&0===this.meta.length)this.push("meta",this._generateMetaForColumn("_selected","selected",!0,this.localize("Selected")+" (0)"));var addedColumns=info.addedNodes.filter(function(node){return node.nodeType===Node.ELEMENT_NODE&&"PX-DATA-TABLE-COLUMN"===node.nodeName}),removedColumns=info.removedNodes.filter(function(node){return node.nodeType===Node.ELEMENT_NODE&&"PX-DATA-TABLE-COLUMN"===node.nodeName});if(0<addedColumns.length){for(var i=0;i<addedColumns.length;i++){if(!addedColumns[i].type){addedColumns[i].type="string"}if(!addedColumns[i].label){var name=addedColumns[i].name||"";addedColumns[i].label=name.charAt(0).toUpperCase()+name.slice(1)}this._addColumn(addedColumns[i])}}removedColumns.forEach(function(columnToRemove){this.meta.forEach(function(column,idx){if(columnToRemove===column){this.splice("meta",idx,1)}}.bind(this))}.bind(this))},_addColumn:function _addColumn(addedColumn){var previousNode,notFound=this.getEffectiveChildren().every(function(column,index){if(column.name===addedColumn.name){return!1}previousNode=column;return!0});if(!notFound){var idx=0;if(previousNode){this.meta.forEach(function(column,index){if(column.name===previousNode.name){idx=index+1}});this.splice("meta",idx,0,addedColumn)}else{if(this.selectable)idx+=1;this.splice("meta",idx,1,addedColumn)}}else{this.push("meta",addedColumn)}},_selectedColumnExists:function _selectedColumnExists(){return this.meta&&this.meta[0]&&"_selected"===this.meta[0].name},_highlightLoaded:function _highlightLoaded(evt){evt=Polymer.dom(evt);var column=this._findFirstMatchingElementNameFromEventPath(evt,"PX-DATA-TABLE-COLUMN");column._highLightElLoadedCount+=1;if(column._highLightElLoadedCount===Polymer.dom(column).querySelectorAll("px-data-table-highlight").length){var columnIndex=this._findMetaIndexFromColumnElement(column);if(0<columnIndex){this.set("meta."+columnIndex+".highlightdefined",!0)}}},_findMetaIndexFromColumnElement:function _findMetaIndexFromColumnElement(columnElement){var columnIndex=-1;this.meta.some(function(item,idx){if(item===columnElement){columnIndex=idx;return!0}});return columnIndex},_findFirstMatchingElementNameFromEventPath:function _findFirstMatchingElementNameFromEventPath(evt,nodeName){var el;evt.path.some(function(node){if(node.nodeName===nodeName){el=node;return!0}});return el},_dataChanged:function _dataChanged(changeRec){this.dataChangeTrigger=!1;if(this.data===void 0||null===this.data||!this._isAttached&&0===changeRec.base.length){this._internalData=[];return}if(!this._isAttached){var _this=this;this.debounce("attach",function(){_this._dataChanged(changeRec)},10);return}if(this.includeAllColumns||0===this.meta.length||1===this.meta.length&&"_selected"===this.meta[0].name){this._generateMetaFromData()}if(!this._typeofComparison(this._internalData,"undefined")&&0===this._internalData.length){this._internalData=this._initializeInternalData()}else{this.dataChangeTrigger=!0;this._internalData=this._refreshInternalData()}this.selectedRows=this._internalData.filter(function(it){return!0===it._selected});this._filterSortAndUpdateDisplayedTable();var pathNumber=/([#])([0-9])+/;if(pathNumber.test(changeRec.path)){var index=pathNumber.exec(changeRec.path)[0].slice(1),pathPieces=changeRec.path.split("."),columnName=pathPieces[pathPieces.length-1],column;this.meta.some(function(columnEl){if(columnEl.name===columnName){column=columnEl;return!0}});if(this._cellChanged(this._readContent(this._internalData[index],column),changeRec.value)){this._handleValidateEvent(evt)}}},_getNumberOfItems:function _getNumberOfItems(numberOfItems,totalEntries,dataRemote){return dataRemote?totalEntries:numberOfItems},_includeAllColumnsChanged:function _includeAllColumnsChanged(newValue){if(!0===newValue){this._generateMetaFromData()}else if(!1===newValue&&this._isAttached&&0<this.getContentChildren("#columndefs").length){this.meta=this.getContentChildren("#columndefs").filter(function(node){return node.nodeType===Node.ELEMENT_NODE&&"PX-DATA-TABLE-COLUMN"===node.nodeName});this._selectableChanged(this.selectable)}},_selectableChanged:function _selectableChanged(newSelectable){if(!0===newSelectable&&null!==this.meta&&this.meta!==void 0&&0<this.meta.length){this.splice("meta",0,0,this._generateMetaForColumn("_selected","selected",!0,this.localize("Selected")+" (0)"))}else if(!1===newSelectable&&null!==this.meta&&this.meta!==void 0&&0<this.meta.length&&"_selected"===this.meta[0].name){this.shift("meta")}},_singleSelectChanged:function _singleSelectChanged(){if(this._internalData&&1<this.selectedRows.length)this._setAllRows(!1)},_generateMetaFromData:function _generateMetaFromData(){for(var prop in this.data[0]){var previousNode,notFound=this.meta.every(function(column,index){if(column.name===prop){return!1}return!0});if(notFound){var colInfo=this._generateMetaForColumn(prop,"string",!1,prop.charAt(0).toUpperCase()+prop.slice(1));this.push("meta",colInfo)}}},_generateMetaForColumn:function _generateMetaForColumn(prop,type,isSelectAll,label){return Polymer.Base.create("px-data-table-column",{name:prop,label:label,type:type,sortable:this.sortable,filterable:this.filterable,disableSelect:!this.selectable,editable:!1,required:!1,hide:!1,selectAll:isSelectAll,validate:function validate(){return{passedValidation:!0}}})},_filterSortAndUpdateDisplayedTable:function _filterSortAndUpdateDisplayedTable(){var i,index,count=0,self=this,len;this.filteredSortedData=this._internalData;for(i=0,len=this._internalData.length;i<len;i++){this._setInternalDataAt(this._internalData[i],"_filtered",!1)}if(!this.dataRemote){if(this.sortedColumn){this.filteredSortedData=this._sortByColumn(this.filteredSortedData)}for(index in this.filteredColumns){this.filteredSortedData=this._filterByColumn(this.filteredColumns[index].name,this.filteredColumns[index].userEntry,this.filteredSortedData)}self=this;this._internalData.forEach(function(row){if(!self._getInternalCellStateAt(row,"_filtered")){count++}});if(!1==this.dataChangeTrigger){this.set("numberOfItems",count);this.$.pagination.goToPageNumber(1)}}else{this.$.pagination.updateDisplay();this.set("numberOfItems",this.totalEntries)}this._updateDisplayedRows();var selectAllCheckbox=Polymer.dom(this.root).querySelector("#selectAllCheckbox");if(null!==selectAllCheckbox&&selectAllCheckbox!==void 0&&selectAllCheckbox.checked){selectAllCheckbox.checked=!1}},_refreshInternalData:function _refreshInternalData(resetDataState){var _internalData=[],i,len;for(i=0,len=this.data.length;i<len;i++){var thisObj=this.data[i],cellDataObj={dataIndex:i},resetDataFlag=resetDataState||i>=this._internalData.length;for(var key in thisObj){if(Object.prototype.hasOwnProperty.call(thisObj,key)){cellDataObj[key]={};cellDataObj[key].value=thisObj[key];if(resetDataFlag){cellDataObj[key]._validation={passedValidation:!0}}else if(this._internalData[i].row[key]&&this._internalData[i].row[key]._validation){cellDataObj[key]._validation=this._internalData[i].row[key]._validation}}}_internalData.push({row:cellDataObj,_filtered:resetDataFlag?!1:this._internalData[i]._filtered,_selected:resetDataFlag?!1:this._internalData[i]._selected,_highlight:resetDataFlag?{value:!1,highlightColor:""}:this._internalData[i]._highlight})}return _internalData},_initializeInternalData:function _initializeInternalData(){return this._refreshInternalData(!0)},_setInternalDataAt:function _setInternalDataAt(row,columnName,value){if("_selected"===columnName||"_filtered"===columnName||"_highlight"===columnName){this.set("displayedRows."+this.displayedRows.indexOf(row)+"."+columnName,value);row[columnName]=value}else{row.row[columnName].value=value}},_getInternalDataAt:function _getInternalDataAt(row,columnName){return this._getInternalCellStateAt(row,columnName).value},_getInternalCellValidationStateAt:function _getInternalCellValidationStateAt(row,columnName){return this._getInternalCellStateAt(row,columnName)._validation},_setInternalCellValidationStateAt:function _setInternalCellValidationStateAt(row,columnName,value){row.row[columnName]._validation=value},_getInternalCellStateAt:function _getInternalCellStateAt(row,columnName){if("_selected"===columnName||"_filtered"===columnName){return row[columnName]}else{return row.row[columnName]?row.row[columnName]:{}}},_setPageSize:function _setPageSize(){this.$.pagination.setPageSize(this.pageSize)},_getInternalRowStateAt:function _getInternalRowStateAt(row,columnName){if("_selected"===columnName||"_filtered"===columnName){return row}else{return row.row}},_updateDisplayedRows:function _updateDisplayedRows(){var fromPage,to;if(null!==this.firstItemIndex&&this.firstItemIndex!==void 0&&null!==this.pageSize&&this.pageSize!==void 0&&this.filteredSortedData!==void 0&&null!==this.filteredSortedData&&!this.hidePaginationControl){fromPage=this.firstItemIndex-1;to=fromPage+parseInt(this.pageSize,10);this.filteredSortedData=this.filteredSortedData.map(function(row){row.isNew=!0;return row});if(this.dataRemote){this.set("displayedRows",this.filteredSortedData)}else{this.set("displayedRows",this.filteredSortedData.slice(fromPage,to))}}else if(this.filteredSortedData!==void 0&&null!==this.filteredSortedData&&this.hidePaginationControl){this.filteredSortedData=this.filteredSortedData.map(function(row){row.isNew=!0;return row});this.set("displayedRows",this.filteredSortedData)}},_triggerSortChangeRequest:function _triggerSortChangeRequest(){this.debounce("_debounceTriggerSortChangeRequest",function(){this.fire("px-sort-change-intent",!this.sortedColumn?"[]":JSON.stringify([{name:this.sortedColumn,direction:this.descending?"descending":"ascending"}]))},300)},_sort:function _sort(e,p){if(!this.sortable)return;var column=e.model.column,sortingColumn;if(column&&column.sortable){sortingColumn=column.name;if(sortingColumn===this.sortedColumn&&!this.descending){this.set("descending",!this.descending)}else if(sortingColumn===this.sortedColumn&&this.descending){this.set("sortedColumn","")}else{this.set("sortedColumn",sortingColumn);this.set("descending",!1)}}if(!this.dataRemote){this._filterSortAndUpdateDisplayedTable()}else{this._triggerSortChangeRequest()}},_sortByColumn:function _sortByColumn(rowsToSort){var sortFunction=this._getSortFunction(),sortedRows;sortedRows=rowsToSort.map(function(e,i){var v;if("_selected"===this.sortedColumn){v=this._getInternalCellStateAt(e,this.sortedColumn)}else{v=this._getInternalDataAt(e,this.sortedColumn)}if(void 0===v||null===v){v=""}return{index:i,value:this._typeofComparison(v,"string")?v.toLowerCase():v}},this).sort(sortFunction.bind(this)).map(function(e){return rowsToSort[e.index]});return sortedRows},_getSortFunction:function _getSortFunction(){var sortFunction;if("_selected"!==this.sortedColumn){this.meta.forEach(function(obj){if(this.sortedColumn===obj.name){sortFunction=this._resolveFunctionOnWindow("sort-function-name",obj)}},this)}if(!sortFunction){if("_selected"===this.sortedColumn){sortFunction=this._defaultSortSelected}else{sortFunction=this._defaultSortAlphabetically}}return sortFunction},_resolveFunctionOnWindow:function _resolveFunctionOnWindow(elAttributeName,elObj){var customFunction=window,customFunctionFullPath,i,customFunctionRef=elObj[elAttributeName];if(null===customFunctionRef||customFunctionRef===void 0){if(babelHelpers.instanceof(elObj,HTMLElement)){customFunctionRef=elObj.attributes[elAttributeName]}if(null===customFunctionRef||customFunctionRef===void 0){return null}}customFunctionFullPath=customFunctionRef.value.split(".");for(i in customFunctionFullPath){customFunction=customFunction[customFunctionFullPath[i]];if(customFunction===void 0){console.warn("px-data-table: Custom function was used, but was not found on window. Is the path correct?");return null}}return customFunction},_defaultSortAlphabetically:function _defaultSortAlphabetically(a,b){if(this.descending){return a.value<b.value?1:-1}else{return a.value>b.value?1:-1}},_defaultSortSelected:function _defaultSortSelected(a,b){if(this.descending){return a.value&&!b.value?1:!a.value&&b.value?-1:0}else{return a.value&&!b.value?-1:!a.value&&b.value?1:0}},_triggerFilterChangeRequest:function _triggerFilterChangeRequest(){this.debounce("_debounceTriggerFilterChangeRequest",function(){this.fire("px-filter-change-intent",JSON.stringify(this.filteredColumns))},300)},_filter:function _filter(e){if(!1==e.isTrusted)this.dataChangeTrigger=!0;else if(!0==e.isTrusted)this.dataChangeTrigger=!1;var column=this.$.filterRepeat.modelForElement(e.target).column,userEntry,isNotInFilteredColumnsList,index,filteredColumn;if(column&&column.filterable){userEntry=e.target.value;isNotInFilteredColumnsList=!0;for(index in this.filteredColumns){filteredColumn=this.filteredColumns[index];if(filteredColumn.name===column.name){isNotInFilteredColumnsList=!1;if(""===userEntry||userEntry===void 0||null===userEntry){this.filteredColumns.splice(index,1)}else{filteredColumn.userEntry=userEntry}}}if(isNotInFilteredColumnsList){if(""!==userEntry&&userEntry!==void 0&&null!==userEntry){this.filteredColumns.push({name:column.name,userEntry:userEntry})}}if(!this.dataRemote){this._filterSortAndUpdateDisplayedTable()}else{this._triggerFilterChangeRequest()}}},_filterByColumn:function _filterByColumn(columnName,userEntry,rowsToFilter){var filterFunction=this._getFilterFunction(columnName),i,len,matched,self=this,filteredRows;for(i=0,len=rowsToFilter.length;i<len;i++){if(!1===rowsToFilter[i]._filtered){matched=filterFunction(userEntry,this._getInternalDataAt(rowsToFilter[i],columnName));if(!matched){this._setInternalDataAt(rowsToFilter[i],"_filtered",!0)}}}this.filtered=rowsToFilter.some(function(row){return self._getInternalCellStateAt(row,"_filtered")});filteredRows=rowsToFilter.filter(function(r){return!self._getInternalCellStateAt(r,"_filtered")});return filteredRows},_getFilterFunction:function _getFilterFunction(columnName){var filterFunction;this.meta.forEach(function(obj){if(columnName===obj.name){filterFunction=this._resolveFunctionOnWindow("filter-function-name",obj)}},this);if(!filterFunction){filterFunction=this._defaultFilter}return filterFunction},_defaultFilter:function _defaultFilter(searchString,cellValue){if(searchString===void 0||null===searchString||""===searchString){return!0}if(cellValue){return-1<cellValue.toString().toLowerCase().indexOf(searchString.toString().toLowerCase())}},_save:function _save(evt){var row=evt.model.internalRow,column=evt.model.column,newValue=evt.detail.newValue;if(row){this.fire("before-save",{event:evt,row:row,column:column});this._setInternalDataAt(row,column.name,newValue);evt.currentTarget.cellValue=this._getInternalDataAt(row,column.name);evt.currentTarget.cellDisplayValue=this._readContent(row,column);this.data[row.row.dataIndex][column.name]=newValue}if(column.required&&!evt.target.validity.valid){this.fire("after-invalid",{event:evt,row:row,column:column})}this.fire("after-save",{event:evt,row:row,column:column})},_cellChanged:function _cellChanged(oldValue,newValue){return oldValue!==newValue},_handleValidateEvent:function _handleValidateEvent(evt){var column=evt.model.column,validationObj=column.validate(evt.detail.newValue);evt.currentTarget.cellValidation=validationObj;this._setInternalCellValidationStateAt(evt.model.internalRow,column.name,validationObj)},_clickRow:function _clickRow(evt){var column=evt.model.column,row=evt.model.internalRow,detail={row:row,column:column},selectAllCheckbox;if(column.editable||"dropdown"===column.type||!0===column.disableSelect)return;if(this.selectable){this._selectRow(row,this.$.recordList.indexForElement(evt.currentTarget));if(!this.singleSelect){selectAllCheckbox=Polymer.dom(this.root).querySelector("#selectAllCheckbox");selectAllCheckbox.checked=!1}if("_selected"===this.sortedColumn){this.set("sortedColumn","")}}this.fire("px-row-click",detail)},_clickCell:function _clickCell(evt){var column=evt.model.column,row=evt.model.internalRow,detail={row:row,column:column,rowIndex:this.$.recordList.indexForElement(evt.currentTarget)};this._clickRow(evt);this.fire("px-cell-click",detail)},_clickSelectAll:function _clickSelectAll(e){if(e.target.checked){this._setAllRows(!0)}else{this._setAllRows(!1)}},_setAllRows:function _setAllRows(isSelected){var i,len;if(isSelected){for(i=0,len=this._internalData.length;i<len;i++){if(this.filteredSortedData.includes(this._internalData[i])){this._setInternalDataAt(this._internalData[i],"_selected",isSelected)}}}else{for(i=0,len=this._internalData.length;i<len;i++){this._setInternalDataAt(this._internalData[i],"_selected",isSelected)}}for(i=0,len=this.displayedRows.length;i<len;i++){this.notifyPath("displayedRows."+i+"._selected",this.displayedRows[i]._selected)}this.splice("selectedRows",0,this.selectedRows.length);if(isSelected){for(i=0,len=this._internalData.length;i<len;i++){if(this._internalData[i]._selected){this.push("selectedRows",this._internalData[i])}}}this.set("meta.0.label",this.localize("Selected")+" ("+this.selectedRows.length+")");this.fire("px-select-all-click",this.selectedRows)},_selectRow:function _selectRow(row,indexInDisplayedRows){this.fire("before-select",row);if(-1<this.selectedRows.indexOf(row)){row._selected=!1;this.notifyPath("displayedRows."+indexInDisplayedRows+"._selected",row._selected);this.splice("selectedRows",this.selectedRows.indexOf(row),1)}else{if(this.singleSelect)this._setAllRows(!1);row._selected=!0;this.notifyPath("displayedRows."+indexInDisplayedRows+"._selected",row._selected);this.push("selectedRows",row)}this.set("meta.0.label",this.localize("Selected")+" ("+this.selectedRows.length+")");this.fire("after-select",row)},_dragDropColumnHeader:function _dragDropColumnHeader(evt){if(this.enableColumnReorder){this._dropColumnHeader(this._findHeaderFromChild(evt.target))}},_touchDropColumnHeader:function _touchDropColumnHeader(evt){if(this.enableColumnReorder){this._removeDragFromSourceHeader();var target=document.elementFromPoint(event.changedTouches[0].clientX,event.changedTouches[0].clientY);target=this._findHeaderFromChild(target);this._dropColumnHeader(target)}},_dropColumnHeader:function _dropColumnHeader(target){var srcName=this._columnDragged,toMove,regex,targetName,targetColumn,columns,parent;regex=target.classList.toString().match(/.*aha-(.*)-th/);targetName=regex&&1<regex.length?regex[1]:null;if(null!=targetName){if(targetName!==srcName){columns=this.getEffectiveChildren();columns.forEach(function(column){if(column.name===srcName){toMove=column}if(column.name===targetName){targetColumn=column}});if(toMove&&"_selected"!==targetName||toMove!==columns[0]){parent=Polymer.dom(toMove).parentNode;Polymer.dom(parent).removeChild(toMove);Polymer.dom.flush();if("_selected"===targetName){Polymer.dom(parent).insertBefore(toMove,columns[0])}else{Polymer.dom(parent).insertBefore(toMove,targetColumn.nextSibling)}}}else{target.classList.remove("dragged")}}this._removeInsertionDisplay()},_dragOverHeader:function _dragOverHeader(evt){if(this.enableColumnReorder){var target=this._findHeaderFromChild(evt.target);if(!target.classList.contains("aha-insertion-indicator-th")){evt.preventDefault();this._allowColumnDrop(target,this._requestInsertionIndicatorRemoval&&this._displayingInsertion)}}},_touchMoveHeader:function _touchMoveHeader(evt){if(this.enableColumnReorder){var target=document.elementFromPoint(event.changedTouches[0].clientX,event.changedTouches[0].clientY);target=this._findHeaderFromChild(target);if(!target.classList.contains("aha-insertion-indicator-th")){this._allowColumnDrop(target,target!==this._findHeaderFromChild(evt.target))}}},_allowColumnDrop:function _allowColumnDrop(target,moveIndicator){if(moveIndicator){this.set("_requestInsertionIndicatorRemoval",!1);var targetIdx,indicatorIdx,regex=target.classList.toString().match(/.*aha-(.*)-th/),targetName=regex&&1<regex.length?regex[1]:null;if(null!=targetName){this.meta.forEach(function(column,index){if(column.name===targetName){targetIdx=index}else if("insertion-indicator"===column.name){indicatorIdx=index}});if(targetIdx!==void 0&&targetIdx+1!==indicatorIdx){var indicator=this.splice("meta",indicatorIdx,1)[0];if(targetIdx+1>indicatorIdx){targetIdx--}this.splice("meta",targetIdx+1,0,indicator)}}}else if(!this._displayingInsertion){var regex=target.classList.toString().match(/.*aha-(.*)-th/),targetName=regex&&1<regex.length?regex[1]:null;if(null!==targetName){var targetIdx;this.meta.forEach(function(column,index){if(column.name===targetName){targetIdx=index}});var insertCol=this._generateMetaForColumn("insertion-indicator","string",!1,"");insertCol.filterable=!1;insertCol.sortable=!1;this.splice("meta",targetIdx+1,0,insertCol);this.set("_displayingInsertion",!0)}}},_dragLeave:function _dragLeave(evt){this._removeInsertionDisplay()},_dragEndColumnHeader:function _dragEndColumnHeader(evt){this._removeDragFromSourceHeader()},_removeInsertionDisplay:function _removeInsertionDisplay(){var _this=this;this.set("_requestInsertionIndicatorRemoval",!0);window.setTimeout(function(){if(_this.enableColumnReorder&&_this._displayingInsertion&&_this._requestInsertionIndicatorRemoval){var insertionColIdx;_this.meta.forEach(function(column,index){if("insertion-indicator"===column.name){insertionColIdx=index}});_this.splice("meta",insertionColIdx,1);_this.set("_displayingInsertion",!1);this._columnDragged=""}},100)},_dragStartColumnHeader:function _dragStartColumnHeader(evt){var target=this._findHeaderFromChild(evt.target);if(this.enableColumnReorder&&target.classList.contains("moveable")){var name=target.classList.toString().match(/.*aha-(.*)-th/)[1];this._columnDragged=name;target.classList.add("dragged");if(evt.changedTouches){evt.preventDefault();this._allowColumnDrop(target,!1)}}else{evt.preventDefault()}},_removeDragFromSourceHeader:function _removeDragFromSourceHeader(){var src=Polymer.dom(this.root).querySelector(".dragged");if(src){src.classList.remove("dragged")}},_columnChooserChanged:function _columnChooserChanged(evt){if(evt.detail.selected){this.showColumn(evt.detail.key)}else{this.hideColumn(evt.detail.key)}},_computeColumnChooserItems:function _computeColumnChooserItems(){this.debounce("computeItems",function(){var items=[];this.meta.forEach(function(column,index){if("_selected"!==column.name&&"insertion-indicator"!==column.name&&!column.disableHide){items.push({key:column.name,val:column.label,selected:!column.hide})}});if(JSON.stringify(this._columnChooserItems)!==JSON.stringify(items)){this.set("_columnChooserItems",items)}},5)},_calculateAdaptedNumberOfItems:function _calculateAdaptedNumberOfItems(){this.set("_adaptedNumberOfItems",this.dataRemote?this.totalEntries:this.numberOfItems)},hideColumn:function hideColumn(columnName){this.meta.forEach(function(column,index){if(column.name===columnName){column.hide=!0;this.notifyPath("meta."+index+".hide",!0)}},this)},showColumn:function showColumn(columnName){this.meta.forEach(function(column,index){if(column.name===columnName){column.hide=!1;this.notifyPath("meta."+index+".hide",!1)}},this)},_headerTrack:function _headerTrack(evt){var target=this._findHeaderFromChild(evt.target);if(target!==this){target.style.width=this._headerInitialSize+evt.detail.dx+"px"}},_headerResizeMouseDown:function _headerResizeMouseDown(evt){var target=this._findHeaderFromChild(evt.target),currentSize;if(target!==this){currentSize=target.getBoundingClientRect();this._headerInitialSize=currentSize.width;evt.preventDefault();evt.stopPropagation()}},_getRowClass:function _getRowClass(row,striped){return["tr","rows",this.striped?"striped":"",row.isNew?"is-new":""].join(" ")},_getHighlightValue:function _getHighlightValue(row,column,high){var highlightElements=Polymer.dom(column).querySelectorAll("px-data-table-highlight"),doHighlight=!1,highlightObj={value:!1},highlightClass;highlightElements.forEach(function(highlightEl){var rowState=this._getInternalRowStateAt(row,column.name),data=this._getInternalDataAt(row,column.name);doHighlight=highlightEl.highlight(data,rowState,column.name);if(highlightObj.value&&doHighlight){if("low"===highlightObj.highlightValue){highlightObj.highlightClass="px-data-table-highlight--"+highlightEl.highlightValue}else if("medium"===highlightObj.highlightValue){if("high"===highlightEl.highlightValue){highlightObj.highlightClass="px-data-table-highlight--"+highlightEl.highlightValue}}else{highlightObj.highlightClass="px-data-table-highlight--"+highlightEl.highlightValue}}else if(!highlightObj.value){highlightObj.value=doHighlight;highlightObj.highlightClass="px-data-table-highlight--"+highlightEl.highlightValue}if("row"===highlightEl.highlightType){this._setInternalDataAt(row,"_highlight",highlightObj);highlightObj={value:!1}}}.bind(this));return highlightObj},_isSelectAllColumn:function _isSelectAllColumn(column){return column.selectAll},_isFilterableColumn:function _isFilterableColumn(column){return!column.selectAll&&column.filterable&&this.filterable},_readContent:function _readContent(row,column){var datum=this._getInternalDataAt(row,column.name);if(null===datum||datum===void 0||this._typeofComparison(datum,"string")&&0===datum.trim().length){return""}if(this._shouldClipDatumString(row,column)){return this._clipDatumString(datum,column)}return datum},_shouldClipDatumString:function _shouldClipDatumString(row,column){var datum=this._getInternalDataAt(row,column.name),maxColWidth=column.maxColumnCharacterWidth;if(0===maxColWidth||null===datum||datum===void 0||this._typeofComparison(datum,"string")&&0===datum.trim().length){return!1}if(maxColWidth!==void 0&&null!==maxColWidth){return datum.length>maxColWidth}return!1},_clipDatumString:function _clipDatumString(datum,column){var maxColWidth=column.maxColumnCharacterWidth,ellipsisClipPosition=column.ellipsisClipPosition,datumLeftIndex,datumRightIndex;if("left"===ellipsisClipPosition){datum="\u2026"+datum.substr(datum.length-maxColWidth,datum.length)}else if("center"===ellipsisClipPosition){datumLeftIndex=Math.floor(maxColWidth/2);datumRightIndex=maxColWidth-datumLeftIndex;datum=datum.substr(0,datumLeftIndex)+"\u2026"+datum.substr(datum.length-datumRightIndex,datum.length)}else{datum=datum.substr(0,maxColWidth)+"\u2026"}return datum},_isEqual:function _isEqual(source,target){return source===target},_getHeaderClass:function _getHeaderClass(item){var classList=["th","aha-"+item.name+"-th","u-p0"];if(this.sortable&&item.sortable){classList.push("sortable")}if(this.enableColumnReorder&&"selected"!==item.type){classList.push("moveable")}return classList.join(" ")},_getSecondHeaderClass:function _getSecondHeaderClass(filterable){var classList=["tr","tr--filter"];if(!filterable){classList.push("hidden")}return classList.join(" ")},_getFilterHeaderClass:function _getFilterHeaderClass(column){return"insertion-indicator"===column.name?"td insertion-indicator":"td"},_getSortingIcon:function _getSortingIcon(sortable,column,sortingColumn,descending){var sortingIcon=" ";if(sortable&&sortingColumn===column.name){sortingIcon=descending?"px-nav:down":"px-nav:up"}return sortingIcon},_getSortingClass:function _getSortingClass(sortable,column,sortingColumn,descending){var classList="sorting";if(!sortable||sortable&&sortingColumn!==column.name){classList=classList+" visuallyhidden"}return classList},_getTextSortingClass:function _getTextSortingClass(sortable,column,sortingColumn){var classList=["column-head","u-mv--","u-mh-"];if("_selected"===column.name){classList.push("column-head--selected")};if(sortable&&column.sortable){classList.push("sorted-text-hover")}if(sortable&&sortingColumn===column.name){classList.push("sorted-text")}return classList.join(" ")},_getTableClass:function _getTableClass(tableCells,tableColumns){var classArray=[];if(tableCells){classArray.push("table--cells")}if(tableColumns){classArray.push("table--columns")}return classArray.join(" ")},_getPaginationVisibility:function _getPaginationVisibility(hidePaginationControl){return hidePaginationControl?"visuallyhidden":""},_getSelectedCellClass:function _getSelectedCellClass(selected,rowHighlighted){var classList=["td",selected?"selected-cell__selected":"",rowHighlighted.value?rowHighlighted.highlightClass:""];return classList.join(" ")},_findHeaderFromChild:function _findHeaderFromChild(childElem){var header=childElem;while(!header.classList.contains("th")&&header!==this){header=Polymer.dom(header).parentNode}return header},_computeIfColumnFilterEnabled:function _computeIfColumnFilterEnabled(meta,filterable){this._enableFilterRow=meta&&(this.selectable&&!this.singleSelect||filterable&&this.meta.some(function(val){return this._isFilterableColumn(val)}.bind(this)))},_typeofComparison:function _typeofComparison(val,comparator){return babelHelpers.typeof(val)===comparator||!1}});</script>
</body></html>