<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="px-datetime-validate.html">
<link rel="import" href="px-datetime-behavior.html">
<link rel="import" href="css/px-datetime-entry-cell-styles.html">

<!--
Datetime input element. Includes iron-ally-keys-behavior to limit keystrokes to only valid characters.

### Usage

  <px-datetime-entry-cell
    id="cell{{index}}"
    class="cell"
    order='{{index}}'
    moment-obj="[[momentObj]]"
    moment-format='[[item]]'
    time-zone="[[timeZone]]">
  </px-datetime-entry-cell>


@element px-datetime-entry-cell
@homepage index.html
@demo index.html
-->
</head><body><dom-module id="px-datetime-entry-cell">
  <template>
    <style include="px-datetime-entry-cell-styles"></style>
    <input order="{{order}}" class="datetime-entry-input text-input--bare" on-focus="_handleFocus" on-blur="_handleBlur" on-paste="_handlePaste" on-beforepaste="_beforePaste" on-beforecopy="_beforeCopy" on-copy="_handleCopy" disabled="[[_getDisabled(momentFormat)]]" type="[[_getType(_isNumber)]]" pattern$="[[_getPattern(_isNumber)]]" placeholder="[[_placeholderText(momentFormat)]]" on-keypress="_keyPress" max$="[[_max]]" min$="[[_min]]" step="1">
    </template>
</dom-module>

<script>Polymer({is:"px-datetime-entry-cell",behaviors:[PxDatetimeBehavior.SingleMoment,PxDatetimeBehavior.Validate,Polymer.IronA11yKeysBehavior],properties:{momentFormat:{type:String,observer:"_formatChanged"},symbol:{type:String},order:{type:Number,reflectToAttribute:!0},isSelected:{type:Boolean,readOnly:!0,notify:!0,value:!1},_max:{type:Number,computed:"_getMax(momentFormat)"},_min:{type:Number,computed:"_getMin(momentFormat)"},_isNumber:{type:Boolean,computed:"_computeIsNumber(momentFormat)"},_cellLength:{type:Number,value:0}},observers:["_updateInputValue(momentObj, timeZone)"],keyBindings:{right:"_moveFocusForward",left:"_moveFocusBack"},attached:function attached(){this._addGeneralKeyBindings()},clear:function clear(){this.$$(".datetime-entry-input").value=""},setValueFromMoment:function setValueFromMoment(){if(!this.momentObj){this.clear()}else{this.$$(".datetime-entry-input").value=this.momentObj.tz(this.timeZone).format(this.momentFormat)}},_computeIsNumber:function _computeIsNumber(momentFormat){return!/^(?:a|A|MMM|MMMM|Do|ddd|dddd|Z|ZZ)$/.test(momentFormat)},_getPattern:function _getPattern(){if(this._isNumber===void 0){return null}if(this._isNumber){return"[0-9]*"}else{return null}},_getType:function _getType(){if(this._isNumber===void 0){return}return this._isNumber?"tel":"text"},_getDisabled:function _getDisabled(momentFormat){return"Z"===this.momentFormat||"ZZ"===this.momentFormat},_formatChanged:function _formatChanged(){if(this.momentFormat!==void 0){this._updateInputValue();this._sizeInputs();if("A"===this.momentFormat||"a"===this.momentFormat){this._cellLength=2}else if("Z"!==this.momentFormat&&"ZZ"!==this.momentFormat){this._cellLength=this.momentFormat.length}else{this._cellLength=-1}}},_sizeInputs:function _sizeInputs(){var style=window.getComputedStyle(this.$$(".datetime-entry-input"),null),fontSize=style.getPropertyValue("font-size"),fontFamily=style.getPropertyValue("font-family"),c=document.createElement("canvas"),ctx=c.getContext("2d"),length;if("0px"===fontSize||"0"===fontSize||""===fontSize){setTimeout(function(){this._sizeInputs()}.bind(this),50);return}ctx.font=fontSize+" "+fontFamily;if(this.$$(".datetime-entry-input").value){length=ctx.measureText(this.$$(".datetime-entry-input").value.toUpperCase()).width}else{length=ctx.measureText(this.$$(".datetime-entry-input").placeholder).width}length=Math.ceil(length);this.$$(".datetime-entry-input").style.width=length+"px"},_addGeneralKeyBindings:function _addGeneralKeyBindings(){if("A"===this.momentFormat||"a"===this.momentFormat){this.addOwnKeyBinding("a p","_toggleAMPM");this.addOwnKeyBinding("down up","_toggleAMPM");this.addOwnKeyBinding("backspace del","_preventDeleteDefault")}else if("Z"!==this.momentFormat&&"ZZ"!==this.momentFormat){this.addOwnKeyBinding("down up","_wraparound")}},_addSeparatorKeyBinding:function _addSeparatorKeyBinding(){var separator=""===this.symbol.trim()?"space":this.symbol.trim();this.addOwnKeyBinding(separator,"_moveFocusForward")},_updateInputValue:function _updateInputValue(){if(this.momentObj!==void 0&&this.timeZone!==void 0){this.setValueFromMoment();this._sizeInputs()}},_moveFocusBack:function _moveFocusBack(){setTimeout(function(){this.fire("px-entry-cell-move",{dir:-1})}.bind(this),10)},_moveFocusForward:function _moveFocusForward(){setTimeout(function(){this.fire("px-entry-cell-move",{dir:1})}.bind(this),10)},_handleFocus:function _handleFocus(evt){if("Z"!==this.momentFormat&&"ZZ"!==this.momentFormat){this._setIsSelected(!0)}this.fire("px-cell-focused")},_wraparound:function _wraparound(evt){var key=evt.detail.combo;dtEntryValue=this.$$(".datetime-entry-input").value,currentVal=dtEntryValue?parseInt(dtEntryValue):this._min-1,isUpDown=!1;if("up"===key){currentVal++;currentVal=currentVal>this._max?this._min:currentVal;currentVal=currentVal<this._min?this._min:currentVal;this.$$(".datetime-entry-input").value=currentVal;evt.preventDefault()}else if("down"===key){currentVal--;currentVal=currentVal>this._max?this._max:currentVal;currentVal=currentVal<this._min?this._max:currentVal;this.$$(".datetime-entry-input").value=currentVal;evt.preventDefault()}},_checkValue:function _checkValue(){if(this.$$(".datetime-entry-input").value&&1===this.$$(".datetime-entry-input").value.length&&/^(?:MM|DD|HH|hh|kk|mm|ss|YY)$/.test(this.momentFormat)){this.$$(".datetime-entry-input").value="0"+this.$$(".datetime-entry-input").value}else if(this.$$(".datetime-entry-input").value&&2===this.$$(".datetime-entry-input").value.length&&"YYYY"===this.momentFormat){var mo=Px.moment(this.$$(".datetime-entry-input").value,"YY");this.$$(".datetime-entry-input").value=mo.format(this.momentFormat)}else if(this.$$(".datetime-entry-input").value&&"S"===this.momentFormat[0]&&this.$$(".datetime-entry-input").value.length<this.momentFormat.length){var dtNumber=parseInt(this.$$(".datetime-entry-input").value);dtNumber=dtNumber.toPrecision(this.momentFormat.length)*Math.pow(10,this.momentFormat.length-this.$$(".datetime-entry-input").value.length);this.$$(".datetime-entry-input").value=dtNumber.toString()}this._sizeInputs()},_handleBlur:function _handleBlur(evt){var ne=Polymer.dom(evt);this._setIsSelected(!1);this._checkValue();this.fire("px-cell-blurred")},_toggleAMPM:function _toggleAMPM(evt){evt.preventDefault();var ne=Polymer.dom(evt),key=evt.detail.combo;if("A"===key||"a"===key){this._setAMPM("AM");this._moveFocusForward()}else if("P"===key||"p"===key){this._setAMPM("PM");this._moveFocusForward()}else if("up"===key||"down"===key){if("AM"===this.$$(".datetime-entry-input").value||"am"===this.$$(".datetime-entry-input").value){this._setAMPM("PM")}else{this._setAMPM("AM")}}},_setAMPM:function _setAMPM(ampm){var mo=Px.moment.tz("01:00:00 "+ampm,"hh:mm:ss "+this.momentFormat,this.timeZone);this.$$(".datetime-entry-input").value=mo.tz(this.timeZone).format(this.momentFormat)},_preventDeleteDefault:function _preventDeleteDefault(evt){evt.preventDefault();this.clear()},_placeholderText:function _placeholderText(momentFormat){var phText={Z:"\xB1"+"xx:xx",ZZ:"\xB1"+"xxxx",X:"epoch time (s)",x:"epoch time (ms)",a:"AM",A:"AM"};if(phText[momentFormat]){return phText[momentFormat]}return momentFormat},_beforeCopy:function _beforeCopy(evt){if(!evt.clipboardData){this.fire("px-request-datetime-entry-copy",window.clipboardData)}},_beforePaste:function _beforePaste(evt){if(!evt.clipboardData){this.fire("px-request-datetime-entry-paste",window.clipboardData)}},_handlePaste:function _handlePaste(evt){if(evt.clipboardData){this.fire("px-request-datetime-entry-paste",evt.clipboardData)}evt.preventDefault()},_handleCopy:function _handleCopy(evt){if(evt.clipboardData){this.fire("px-request-datetime-entry-copy",evt.clipboardData)}evt.preventDefault()},_convertMomentFormat:function _convertMomentFormat(){var momentTypeConversion={Y:"y",M:"M",D:"d",H:"h",h:"h",k:"h",m:"m",s:"s",X:"s",S:"ms",x:"ms"};return momentTypeConversion[this.momentFormat[0]]},_getMax:function _getMax(momentFormat){if(/^(?:M|MM|h|hh)$/.test(momentFormat)){return 12}if(/^(?:D|DD)$/.test(momentFormat)){return 31}if(/^(?:H|HH)$/.test(momentFormat)){return 23}if(/^(?:k|kk)$/.test(momentFormat)){return 24}if(/^(?:m|mm|ss|s)$/.test(momentFormat)){return 59}if("S"===momentFormat){return 9}if("SS"===momentFormat){return 99}if("SSS"===momentFormat){return 999}if("YY"===momentFormat){return 99}if("YYYY"===momentFormat){return 9999}return""},_getMin:function _getMin(momentFormat){if(/^(?:YY|YYYY|X|x|H|HH|m|mm|s|ss|S|SS|SSS)$/.test(momentFormat)){return 0}if(/^(?:M|MM|D|DD|h|hh|k|kk)$/.test(momentFormat)){return 1}return""},_keyPress:function _keyPress(evt){if("Backspace"!==evt.key&&"Delete"!==evt.key&&"Cut"!==evt.key&&"Copy"!==evt.key&&"ArrowLeft"!==evt.key&&"ArrowRight"!==evt.key){if(("A"===this.momentFormat||"a"===this.momentFormat)&&!/[aApP]/.test(evt.key)){evt.preventDefault();return}if(this._isNumber&&!/[0-9]/.test(evt.key)){evt.preventDefault();return}if(-1!==this._cellLength&&this.$$(".datetime-entry-input").value.length===this._cellLength){this.$$(".datetime-entry-input").value="";this._addSeparatorKeyBinding()}if(this.$$(".datetime-entry-input").value.length===this._cellLength-1){this._moveFocusForward()}}}});</script>
</body></html>