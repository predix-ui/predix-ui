<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. tests, examples), we assume the server is started with
    'gulp serve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="css/px-heatmap-grid-styles.html">
<link rel="import" href="../px-tooltip/px-tooltip.html">
<link rel="import" href="../px-icon-set/px-icon-set-utility.html">
<link rel="import" href="../px-icon-set/px-icon.html">

</head><body><dom-module id="px-heatmap-grid-table">
  <template>
    <style include="px-heatmap-grid-styles"></style>
    <div class="table-container flex flex--row">
      <template is="dom-if" if="{{!hideRowHeader}}">
        <div class$="u-pl- u-pr- table-row-header flex flex--col flex--justify {{disabledHeader}}">
          <template is="dom-if" if="{{showAggregation}}">
            <div class="row-header">
              <div class="row-header-text"><span>{{aggregationType}}</span></div>
            </div>
          </template>
          <template is="dom-repeat" items="{{rows}}" as="row">
            <div class="row-header flex flex--row flex--middle flex--justify" on-click="_sortRow">
              <div class="row-header-text" id="row-header-{{index}}">{{_getHeader("row", index, rows)}}</div>
              <px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron-left" hidden$="{{_sortingIcon(index,'row','up', heatmapData)}}"></px-icon>
              <px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron-right" hidden$="{{_sortingIcon(index,'row','down', heatmapData)}}"></px-icon>
              <px-tooltip smart-orientation="true" orientation="right" for="row-header-{{index}}" delay="100" tooltip-message="{{_getHeader('row', index, rows)}}">
              </px-tooltip>
            </div>
          </template>
        </div>
      </template>
      <div class="table-container flex flex--row flex--left flex--top">
        <template is="dom-if" if="{{showRowAggregation}}">
          <div class="table-column">
            <div class="u-pr-- u-pb-- u-pl-- col-header" hidden$="{{hideColHeader}}">
              <div class="col-header-text">{{aggregationType}}</div>
            </div>
            <div class="u-p-- table-empty-cell" hidden$="{{!showColAggregation}}">
              <span>&nbsp;</span>
            </div>
            <template is="dom-repeat" items="{{rowAggregatedData}}">
              <div class="u-p-- table-cell">
                <span>{{item}}</span>
              </div>
            </template>
          </div>
        </template>
        <template is="dom-repeat" items="{{heatmapData}}" as="items" id="heatmapDataRepeat">
          <div class="table-column">
            <template is="dom-if" if="{{!hideColHeader}}">
              <div class="u-pr-- u-pb-- u-pl-- col-header flex flex--row flex--middle flex--justify" on-click="_sortCol">
                <div class="col-header-text" id="col-header-{{index}}">
                  {{_getHeader("col", index, cols)}}
                </div>
                <px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron-up" hidden$="{{_sortingIcon(index,'col','up',heatmapData)}}"></px-icon>
                <px-icon class="actionable actionable--select u-ml-" icon="px-utl:chevron" hidden$="{{_sortingIcon(index,'col','down',heatmapData)}}"></px-icon>
                <px-tooltip smart-orientation="true" orientation="bottom" for="col-header-{{index}}" delay="100" tooltip-message="{{_getHeader('col', index, cols)}}">
                </px-tooltip>
              </div>
            </template>
            <template is="dom-if" if="{{showColAggregation}}">
              <div class="u-p-- table-cell">
                <span>{{_getColAggregation(index, colAggregatedData)}}</span>
              </div>
            </template>
            <template is="dom-repeat" items="{{items}}" as="item">
              <div class="u-p-- table-cell cell-values" style$="[[item.color]]">
                <span hidden$="{{hideValues}}">{{item.value}}</span>
                <template is="dom-if" if="{{hideValues}}">
                  <px-tooltip smart-orientation="true" orientation="bottom" delay="100" tooltip-message="{{item.value}}"></px-tooltip>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>
  </template>
</dom-module>

<script>Polymer({is:"px-heatmap-grid-table",properties:{data:{type:Array,value:function value(){return[]},notify:!0,observer:"_dataChanged"},heatmapData:{type:Array,value:function value(){return[]}},config:{type:Object,value:function value(){return{minValue:0,maxValue:0,startColor:[],endColor:[],factors:[]}},observer:"_configChanged"},scale:{type:Array,value:function value(){return[0,100]},observer:"_scaleChanged"},hideColHeader:{type:Boolean,value:!1,observer:"_hideColHeaderChanged",notify:!0},hideRowHeader:{type:Boolean,value:!1,observer:"_hideRowHeaderChanged"},hideValues:{type:Boolean,value:!1},aggregationType:{type:String,value:"",observer:"_calculateAggregation"},showAggregation:{type:Boolean,value:!1,observer:"_showAggregationChanged"},availableAggregations:{type:Array,value:["AVERAGE","MAX","MIN","SUM","COUNT","STD"]},scaleColorFrom:{type:String,observer:"_scaleColorFromChanged"},scaleColorTo:{type:String,observer:"_scaleColorToChanged"}},attached:function attached(){this._dataChanged(this.data,[]);this._configChanged(this.config,{})},ready:function ready(){this.addEventListener("px-tooltip-request-show",this._hideTooltip)},detached:function detached(){this.removeEventListener("px-tooltip-request-show",this._hideTooltip)},_dataChanged:function _dataChanged(newData,oldData){if(newData!=oldData&&newData&&newData.length&&null!==newData[0]){var rows=[],cols=[],tableData=[],response={};if(Array.isArray(newData[0])){tableData=this._processNewDataArray(newData)}else if("object"!==babelHelpers.typeof(newData[0])&&"string"!==typeof newData[0]){tableData=this._processNewDataNumber(newData)}else if("object"===babelHelpers.typeof(newData[0])&&newData[0].values){response=this._processNewDataObject(newData);tableData=response.tableData;rows=response.rows;cols=response.cols}else if("string"!==typeof newData[0]){response=this._processNewDataFullObject(newData);tableData=response.tableData;rows=response.rows;cols=response.cols}rows.length=Object.keys(rows).length;cols.length=Object.keys(cols).length;this.set("heatmapData",[]);this.set("rows",rows);this.set("cols",cols);this.set("heatmapData",tableData);this._calculateAggregation(this.aggregationType,"");this._hideColHeaderChanged(!1,!0);this._hideRowHeaderChanged(!1,!0);this._initializeRowsOrdering();this._initializeColsOrdering()}},_processNewDataArray:function _processNewDataArray(data){for(var nColor=[],tableData=[],stopLen=data.length,i=0;i<stopLen;i++){for(var colArr=data[i],stopLen2=colArr.length,j=0,value;j<stopLen2;j++){value=colArr[j];if(!tableData[j])tableData.push([]);nColor=this.config!=void 0?this._calculateColor(value):[255,255,255];tableData[j][i]={value:value,color:nColor?"background-color: rgb("+nColor[0]+","+nColor[1]+","+nColor[2]+");":""}}}return tableData},_processNewDataObject:function _processNewDataObject(data){for(var nColor=[],iRow=-1,iCol=-1,tableData=[],rows=[],cols=[],stopLen=data.length,i=0;i<stopLen;i++){var cell=data[i],stopLen2=cell.values.length;iRow=cell.row?Object.keys(rows).indexOf(cell.row):-2;iCol=cell.col?Object.keys(cols).indexOf(cell.col):-2;if(-2===iCol){rows[cell.row]=cell.row}if(-2===iRow){cols[cell.col]=cell.col}for(var j=0,value;j<stopLen2;j++){value=cell.values[j];nColor=this.config!=void 0?this._calculateColor(value):[255,255,255];if(-2===iCol){if(0===i)tableData.push([]);tableData[j].push({value:value,color:nColor?"background-color: rgb("+nColor[0]+","+nColor[1]+","+nColor[2]+");":""})}else{if(0===j)tableData.push([]);tableData[i].push({value:value,color:nColor?"background-color: rgb("+nColor[0]+","+nColor[1]+","+nColor[2]+");":""})}}}return{tableData:tableData,rows:rows,cols:cols}},_processNewDataNumber:function _processNewDataNumber(data){for(var nColor=[],tableData=[],stopLen=data.length,i=0,value;i<stopLen;i++){value=data[i];nColor=this.config!=void 0?this._calculateColor(value):[255,255,255];tableData.push([{value:value,color:nColor?"background-color: rgb("+nColor[0]+","+nColor[1]+","+nColor[2]+");":""}])}return tableData},_processNewDataFullObject:function _processNewDataFullObject(data){for(var nColor=[],iRow=-1,iCol=-1,tableData=[],rows=[],cols=[],stopLen=data.length,i=0,cell;i<stopLen;i++){cell=data[i];if(cell){iRow=Object.keys(rows).indexOf(cell.row);iCol=Object.keys(cols).indexOf(cell.col);if(-1===iCol){cols[cell.col]=cell.col;tableData.push([]);iCol=Object.keys(cols).length-1};if(-1===iRow){rows[cell.row]=cell.row;iRow=Object.keys(rows).length-1};nColor=this.config!=void 0?this._calculateColor(cell.value):[255,255,255];tableData[iCol][iRow]={value:cell.value,color:nColor?"background-color: rgb("+nColor[0]+","+nColor[1]+","+nColor[2]+");":""}}}return{tableData:tableData,rows:rows,cols:cols}},_initializeRowsOrdering:function _initializeRowsOrdering(){var initialRowsOrder=[],stopLen=this.rows.length;if(this.rows&&stopLen){for(var i=0;i<stopLen;i++){initialRowsOrder.push({index:i,value:Object.keys(this.rows)[i]})}this.initialRowsOrder=initialRowsOrder}else if(this.heatmapData&&this.heatmapData.length){stopLen=this.heatmapData[0].length;for(var i=0;i<stopLen;i++){initialRowsOrder.push({index:i,value:this.heatmapData[0][i].value})}this.initialRowsOrder=initialRowsOrder}},_initializeColsOrdering:function _initializeColsOrdering(){var initialColsOrder=[],stopLen=this.cols.length;if(this.cols&&stopLen){for(var i=0;i<stopLen;i++){initialColsOrder.push({index:i,value:Object.keys(this.cols)[i]})}this.initialColsOrder=initialColsOrder}else if(this.heatmapData&&this.heatmapData.length){stopLen=this.heatmapData.length;for(var i=0;i<stopLen;i++){initialColsOrder.push({index:i,value:this.heatmapData[i][0].value})}this.initialColsOrder=initialColsOrder}},_calculateColor:function _calculateColor(value){var config=this.config,colors=[];if(value<config.minValue||value>config.maxValue){colors=null}else{for(var stopLen=config.factors.length,i=0;i<stopLen;i++){colors.push(Math.round(config.factors[i]*(value-config.minValue))+config.startColor[i])}}return colors},_configChanged:function _configChanged(newConfig,oldConfig){if(newConfig!==oldConfig&&newConfig){var config=this.config,temp,stopLen,nValues,data;if(this.scaleColorFrom){temp=this.scaleColorFrom.replace(/[^\d,]/g,"").split(",");config.startColor=[];stopLen=temp.length;for(var i=0;i<stopLen;i++){config.startColor.push(+temp[i])}}if(this.scaleColorTo){temp=this.scaleColorTo.replace(/[^\d,]/g,"").split(",");config.endColor=[];stopLen=temp.length;for(var i=0;i<stopLen;i++){config.endColor.push(+temp[i])}}nValues=config.maxValue-config.minValue;stopLen=config.endColor.length;config.factors=[];for(var i=0;i<stopLen;i++){config.factors.push((config.endColor[i]-config.startColor[i])/nValues)}data=[].concat(this.data);this.set("data",data)}},_scaleChanged:function _scaleChanged(newScale,oldScale){if(newScale!==oldScale&&newScale&&2===newScale.length){this.set("config.minValue",newScale[0]);this.set("config.maxValue",newScale[1]);this._configChanged(this.config,{})}},_getHeader:function _getHeader(option,index){if("col"===option){return this.cols[Object.keys(this.cols)[index]]}else if("row"===option){return this.rows[Object.keys(this.rows)[index]]}},_hideTooltip:function _hideTooltip(e){var tooltip=e.detail.target,headerEl=tooltip.parentElement.querySelector("div");if(headerEl.scrollWidth<=headerEl.clientWidth&&""!=tooltip.for){tooltip._hide()}},_hideColHeaderChanged:function _hideColHeaderChanged(newValue,oldValue){if(newValue!==void 0&&newValue!==oldValue){!1===newValue?this.disabledHeader="":this.disabledHeader="disable-col-header"}if(newValue!==void 0&&!1===newValue&&newValue!==oldValue&&this.cols&&(!this.cols.length||!Object.keys(this.cols)[0])){this.set("hideColHeader",void 0);this.set("hideColHeader",!0)}},_sortCol:function _sortCol(e){var col=e.model.index,order=0,_this=this,temp,newData,rows,newRows,tempRowsReduced,stopLen,stopLen2;if(this.sortColOrder&&this.sortColOrder.index===col&&2!==this.sortColOrder.order){order=++this.sortColOrder.order}this.sortColOrder={index:col,order:order};if(2>order){temp=[];stopLen=this.heatmapData[col].length;for(var i=0,el;i<stopLen;i++){el=this.heatmapData[col][i];temp.push({index:i,value:el?"number"===typeof el.value?el.value:-Infinity:-Infinity})}temp.sort(function(a,b){return order?b.value-a.value:a.value-b.value})}else{temp=[];if(this.rows&&this.rows.length&&Object.keys(this.rows)[0]){stopLen=this.initialRowsOrder.length;for(var i=0,r;i<stopLen;i++){r=this.initialRowsOrder[i];temp.push({index:Object.keys(_this.rows).indexOf(r.value)})}}else{stopLen=this.heatmapData[0].length;tempRowsReduced=[];for(var i=0;i<stopLen;i++){tempRowsReduced.push(this.heatmapData[0][i].value)}stopLen=this.initialRowsOrder.length;for(var i=0,r;i<stopLen;i++){r=this.initialRowsOrder[i];temp.push({index:tempRowsReduced.indexOf(r.value)})}}}stopLen=this.heatmapData.length;stopLen2=temp.length;newData=[];for(var i=0,newSubData;i<stopLen;i++){newSubData=[];for(var j=0;j<stopLen2;j++){newSubData.push(this.heatmapData[i][temp[j].index])}newData.push(newSubData)}rows=this.rows;newRows=[];stopLen=temp.length;if(rows.length){for(var i=0;i<stopLen;i++){newRows[Object.keys(rows)[temp[i].index]]=rows[Object.keys(rows)[temp[i].index]]}newRows.length=Object.keys(newRows).length}this.set("heatmapData",[]);this.set("rows",[]);this.set("heatmapData",newData);this.set("rows",newRows)},_sortRow:function _sortRow(e){var row=e.model.index,order=0,_this=this,temp,hd,newData,cols,newCols,tempColsReduced,stopLen;if(this.sortRowOrder&&this.sortRowOrder.index===row&&2!==this.sortRowOrder.order){order=++this.sortRowOrder.order}this.sortRowOrder={index:row,order:order};if(2>order){stopLen=this.heatmapData.length;temp=[];for(var i=0,tempItem;i<stopLen;i++){tempItem=this.heatmapData[i][row];temp.push({index:i,value:tempItem?"number"===typeof tempItem.value?tempItem.value:-Infinity:-Infinity})}temp.sort(function(a,b){return order?b.value-a.value:a.value-b.value})}else{temp=[];if(this.cols&&this.cols.length&&Object.keys(this.cols)[0]){stopLen=this.initialColsOrder.length;for(var i=0,r;i<stopLen;i++){r=this.initialColsOrder[i];temp.push({index:Object.keys(_this.cols).indexOf(r.value)})}}else{stopLen=this.heatmapData.length;tempColsReduced=[];for(var i=0;i<stopLen;i++){tempColsReduced.push(this.heatmapData[i][0].value)}stopLen=this.initialColsOrder.length;for(var i=0,r;i<stopLen;i++){r=this.initialColsOrder[i];temp.push({index:tempColsReduced.indexOf(r.value)})}}}hd=this.heatmapData;stopLen=temp.length;newData=[];for(var i=0;i<stopLen;i++){newData.push(hd[temp[i].index])}cols=this.cols;newCols=[];if(cols.length){stopLen=temp.length;for(var i=0;i<stopLen;i++){newCols[Object.keys(cols)[temp[i].index]]=cols[Object.keys(cols)[temp[i].index]]}newCols.length=Object.keys(newCols).length}this.set("cols",[]);this.set("heatmapData",[]);this.set("cols",newCols);this.set("heatmapData",newData)},_sortingIcon:function _sortingIcon(i,h,d){var hideIcon=!0;if(this.sortColOrder&&"col"===h.toLowerCase()&&this.sortColOrder.index===i){if("up"===d.toLowerCase()&&0===this.sortColOrder.order){hideIcon=!1}else if("down"===d.toLowerCase()&&1===this.sortColOrder.order){hideIcon=!1}}else if(this.sortRowOrder&&"row"===h.toLowerCase()&&this.sortRowOrder.index===i){if("up"===d.toLowerCase()&&0===this.sortRowOrder.order){hideIcon=!1}else if("down"===d.toLowerCase()&&1===this.sortRowOrder.order){hideIcon=!1}}return hideIcon},_calculateAggregation:function _calculateAggregation(n,o){var _Mathsqrt=Math.sqrt,_Mathpow=Math.pow;if(this.aggregationType&&null!=this.aggregationType&&n&&n!==o&&this.availableAggregations&&-1!==this.availableAggregations.indexOf(n.toUpperCase())&&0<this.heatmapData.length){this.set("showAggregation",!0);var rowAggregation=[],colAggregation=[],data=[],colDigits=[],rowDigits=[];data=this.heatmapData.map(function(hd){return hd.map(function(v){return v.value})});colDigits=data.map(function(hd){return hd.map(function(a){if(a&&"number"===typeof a){var temp=(a+"").split(".");temp=temp[1]?temp[1].length:0;return temp}return 0}).reduce(function(a,b,i){return 0===i?b:a>b?b:a})});rowDigits=data[0].map(function(hd,i){return data.map(function(a){if(a[i]&&"number"===typeof a[i]){var temp=(a[i]+"").split(".");temp=temp[1]?temp[1].length:0;return temp}return 0}).reduce(function(a,b,i){return 0===i?b:a>b?b:a})});this.set("rowAggregatedData",[]);this.set("colAggregatedData",[]);switch(n.toUpperCase()){case"SUM":rowAggregation=data[0].map(function(c,i){return data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?b[i]:0)},0)});colAggregation=data.map(function(c){return c.reduce(function(a,b){return a+(b&&"number"===typeof b?b:0)},0)});break;case"AVERAGE":rowAggregation=data[0].map(function(c,i){return data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?b[i]:0)},0)/data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?1:0)},0)});colAggregation=data.map(function(c,i){return c.reduce(function(a,b){return a+(b&&"number"===typeof b?b:0)},0)/data[i].reduce(function(a,b){return a+(b&&"number"===typeof b?1:0)},0)});break;case"STD":rowAggregation=data[0].map(function(c,i){return data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?b[i]:0)},0)/data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?1:0)},0)});rowAggregation=data[0].map(function(c,i){return _Mathsqrt(data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?_Mathpow(b[i]-rowAggregation[i],2):0)},0)/data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?1:0)},0))});colAggregation=data.map(function(c,i){return c.reduce(function(a,b){return a+(b&&"number"===typeof b?b:0)},0)/data[i].reduce(function(a,b){return a+(b&&"number"===typeof b?1:0)},0)});colAggregation=data.map(function(c,i){return _Mathsqrt(c.reduce(function(a,b){return a+(b&&"number"===typeof b?_Mathpow(b-colAggregation[i],2):0)},0)/data[i].reduce(function(a,b){return a+(b&&"number"===typeof b?1:0)},0))});break;case"MAX":rowAggregation=data[0].map(function(c,i){return data.reduce(function(a,b){return"number"===typeof b[i]?a>b[i]?a:b[i]:a},-Infinity)});colAggregation=data.map(function(c){return c.reduce(function(a,b){return"number"===typeof b?a>b?a:b:a},-Infinity)});break;case"MIN":rowAggregation=data[0].map(function(c,i){return data.reduce(function(a,b){return"number"===typeof b[i]?a<b[i]?a:b[i]:a},1/0)});colAggregation=data.map(function(c){return c.reduce(function(a,b){return"number"===typeof b?a<b?a:b:a},1/0)});break;default:rowAggregation=data[0].map(function(c,i){return data.reduce(function(a,b){return a+(b[i]&&"number"===typeof b[i]?1:0)},0)});colAggregation=data.map(function(c,i){return data[i].reduce(function(a,b){return a+(b&&"number"===typeof b?1:0)},0)});}colAggregation=colAggregation.map(function(v,i){return(v+"").substr(0,(v+"").split(".")[0].length+2+colDigits[i])});rowAggregation=rowAggregation.map(function(v,i){return(v+"").substr(0,(v+"").split(".")[0].length+2+rowDigits[i])});this.set("rowAggregatedData",rowAggregation);this.set("colAggregatedData",colAggregation)}else if(this.aggregationType&&o&&n&&o!==n&&-1===this.availableAggregations.indexOf(n.toUpperCase())){this.set("aggregationType","");this.set("showAggregation",!1)}},_getColAggregation:function _getColAggregation(i){return this.colAggregatedData?this.colAggregatedData[i]:""},_scaleColorFromChanged:function _scaleColorFromChanged(newColor,oldColor){if(newColor&&newColor!==oldColor){this._configChanged(this.config,{})}},_scaleColorToChanged:function _scaleColorToChanged(newColor,oldColor){if(newColor&&newColor!==oldColor){this._configChanged(this.config,{})}},_hideRowHeaderChanged:function _hideRowHeaderChanged(nHide,oHide){var _this=this;if(nHide!==void 0&&!1===nHide&&nHide!==oHide&&this.rows&&(!this.rows.length||!Object.keys(this.rows)[0])){this.hideRowHeader=!0}else if(!nHide&&oHide){this.hideRowHeader=!1}},_showAggregationChanged:function _showAggregationChanged(nShow,oShow){if(nShow!==void 0&&nShow!=oShow){this.set("showRowAggregation",nShow);this.set("showColAggregation",!1);if(this.heatmapData[0]&&1<this.heatmapData[0].length){this.set("showColAggregation",nShow)}}}});</script>
</body></html>