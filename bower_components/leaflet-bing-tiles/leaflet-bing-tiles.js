L.TileLayer.Bing=L.TileLayer.extend({options:{bingMapsKey:null,imagerySet:"Aerial",culture:"en-US",minZoom:1,noAttribution:!1},statics:{METADATA_URL:"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/{imagerySet}?key={bingMapsKey}&include=ImageryProviders&uriScheme=https",POINT_METADATA_URL:"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/{imagerySet}/{lat},{lng}?zl={z}&key={bingMapsKey}&uriScheme=https"},VALID_IMAGERY_SETS:["Aerial","AerialWithLabels","Road"],initialize:function initialize(options){if("string"===typeof options){options={bingMapsKey:options}}if(options&&options.BingMapsKey){options.bingMapsKey=options.BingMapsKey;console.warn("use options.bingMapsKey instead of options.BingMapsKey")}if(!options||!options.bingMapsKey){throw new Error("Must supply options.BingMapsKey")}options=L.setOptions(this,options);if(-1===this.VALID_IMAGERY_SETS.indexOf(options.imagerySet)){throw new Error("'"+options.imagerySet+"' is an invalid imagerySet")}options.minZoom=Math.max(1,options.minZoom);this._initMeta();if(!L.Browser.android){this.on("tileunload",this._onTileRemove)}},setKey:function setKey(newKey){if(newKey&&this.options.bingMapsKey!==newKey){this.options.bingMapsKey=newKey;this._initMeta().then(function(){this.redraw()}.bind(this))}},setImagery:function setImagery(newSet){if(!newSet||-1===this.VALID_IMAGERY_SETS.indexOf(newSet)){throw new Error("'"+newSet+"' is an invalid imagerySet")}if(this.options.imagerySet!==newSet){this.options.imagerySet=newSet;this._removeAllAttributions();this._initMeta().then(function(){this.redraw();this._updateAttribution()}.bind(this))}},setCulture:function setCulture(newCulture){if(newCulture&&this.options.culture!==newCulture){this.options.culture=newCulture;this.redraw()}},enableAttribution:function enableAttribution(){if(this.options.noAttribution){this.options.noAttribution=!1;this._updateAttribution()}},disableAttribution:function disableAttribution(){if(!this.options.noAttribution){this.options.noAttribution=!0;this._removeAllAttributions()}},getMetaData:function getMetaData(latlng,zoom){if(!this._map&&(!latlng||!zoom)){return Promise.reject(new Error("If layer is not attached to map, you must provide LatLng and zoom"))}latlng=latlng||this._map.getCenter();zoom=zoom||this._map.getZoom();var PointMetaDataUrl=L.Util.template(L.TileLayer.Bing.POINT_METADATA_URL,{bingMapsKey:this.options.bingMapsKey,imagerySet:this.options.imagerySet,z:zoom,lat:latlng.lat,lng:latlng.lng});return fetch(PointMetaDataUrl).then(function(response){return response.json()}).catch(console.error.bind(console))},createTile:function createTile(coords,done){var tile=document.createElement("img");L.DomEvent.on(tile,"load",L.bind(this._tileOnLoad,this,done,tile));L.DomEvent.on(tile,"error",L.bind(this._tileOnError,this,done,tile));if(this.options.crossOrigin){tile.crossOrigin=""}tile.alt="";if(this._url){tile.src=this.getTileUrl(coords)}else{this._initMeta().then(function(){tile.src=this.getTileUrl(coords)}.bind(this)).catch(function(e){console.error(e);done(e)})}return tile},getTileUrl:function getTileUrl(coords){var quadkey=this._toQuadKey(coords.x,coords.y,coords.z);return L.Util.template(this._url,{quadkey:quadkey,subdomain:this._getSubdomain(coords),culture:this.options.culture})},onAdd:function onAdd(map){map.on("moveend",this._updateAttribution,this);L.TileLayer.prototype.onAdd.call(this,map);this._updateAttribution()},onRemove:function onRemove(map){map.off("moveend",this._updateAttribution,this);this._removeAllAttributions(map);L.TileLayer.prototype.onRemove.call(this,map)},_initMeta:function _initMeta(){var fetchPromise;if(this._fetchingMeta&&this._fetch){fetchPromise=this._fetch}else{var boundFetch=this._startMetadataFetch.bind(this);fetchPromise=this._fetch=boundFetch()}return fetchPromise},_startMetadataFetch:function _startMetadataFetch(){this._fetchingMeta=!0;this._url=null;this._imageryProviders=[];this._attributions=[];var metadataUrl=L.Util.template(L.TileLayer.Bing.METADATA_URL,{bingMapsKey:this.options.bingMapsKey,imagerySet:this.options.imagerySet});return fetch(metadataUrl).then(function(response){return response.json()}).then(this._handleMetadataLoaded.bind(this)).then(function(){this._fetchingMeta=!1}.bind(this)).catch(console.error.bind(console))},_handleMetadataLoaded:function _handleMetadataLoaded(metadata){if(200!==metadata.statusCode){throw new Error("Bing Imagery Metadata error: \n"+JSON.stringify(metadata,null,"  "))}var resource=metadata.resourceSets[0].resources[0];this._url=resource.imageUrl;this._imageryProviders=this._reduceProviders(resource.imageryProviders);this.options.subdomains=resource.imageUrlSubdomains;this._updateAttribution();return Promise.resolve()},_reduceProviders:function _reduceProviders(providers){var response={providers:[],areas:[]},provider,areaObj,p,plen,a,alen;for(p=0,plen=providers.length;p<plen;p++){provider=providers[p];response.providers.push(provider);for(a=0,alen=provider.coverageAreas.length;a<alen;a++){areaObj={provider:provider,bounds:L.latLngBounds([provider.coverageAreas[a].bbox[0],provider.coverageAreas[a].bbox[1]],[provider.coverageAreas[a].bbox[2],provider.coverageAreas[a].bbox[3]]),zoomMin:provider.coverageAreas[a].zoomMin,zoomMax:provider.coverageAreas[a].zoomMax};response.areas.push(areaObj)}}return response},_updateAttribution:function _updateAttribution(){var map=this._map;if(!map||!map.attributionControl)return;var zoom=map.getZoom(),bounds=map.getBounds();if(this._fetchingMeta){this._initMeta().then(this._addAndRemoveAttributions.bind(this,map,bounds,zoom))}else{this._addAndRemoveAttributions(map,bounds,zoom)}},_addAndRemoveAttributions:function _addAndRemoveAttributions(map,bounds,zoom){var nextAttrs=this._getAttributions(bounds,zoom),prevAttrs=this._attributions,i,len;for(i=0,len=nextAttrs.length;i<len;i++){if(-1!==prevAttrs.indexOf(nextAttrs[i]))continue;map.attributionControl.addAttribution(nextAttrs[i])}for(i=0,len=prevAttrs.length;i<len;i++){if(-1!==nextAttrs.indexOf(prevAttrs[i]))continue;map.attributionControl.removeAttribution(prevAttrs[i])}this._attributions=nextAttrs},_getAttributions:function _getAttributions(bounds,zoom){if(this.options.noAttribution||"object"!==babelHelpers.typeof(this._imageryProviders)||!Array.isArray(this._imageryProviders.areas)||!bounds||!bounds.isValid()||!zoom){return[]}var providers=[],i=0,len=this._imageryProviders.areas.length;for(;i<len;i++){if(!this._imageryProviders.areas[i].bounds&&!this._imageryProviders.areas[i].bounds.isValid())continue;if(-1===providers.indexOf(this._imageryProviders.areas[i].provider.attribution)&&this._imageryProviders.areas[i].bounds.intersects(bounds)&&zoom>=this._imageryProviders.areas[i].zoomMin&&zoom<=this._imageryProviders.areas[i].zoomMax){providers.push(this._imageryProviders.areas[i].provider.attribution)}}return providers},_removeAllAttributions:function _removeAllAttributions(map){map=map||this._map;if(!map||!Array.isArray(this._attributions)||!this._attributions.length)return;var i=0,len=this._attributions.length;for(;i<len;i++){map.attributionControl.removeAttribution(this._attributions[i])}this._attributions=[]},_toQuadKey:function _toQuadKey(x,y,z){for(var index="",i=z;0<i;i--){var b=0,mask=1<<i-1;if(0!==(x&mask))b++;if(0!==(y&mask))b+=2;index+=b.toString()}return index}});L.tileLayer.bing=function(options){return new L.TileLayer.Bing(options)};