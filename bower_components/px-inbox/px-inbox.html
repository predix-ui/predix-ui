<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. tests, examples), we assume the server is started with
    'gulp serve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="css/px-inbox-styles.html">
<link rel="import" href="../px-dropdown/px-dropdown.html">
<link rel="import" href="../px-icon-set/px-icon-set-navigation.html">
<link rel="import" href="../px-icon-set/px-icon.html">
<link rel="import" href="../px-alert-label/px-alert-label.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">

<!--

### Usage

    <px-inbox list-items='[{"id":"1","title":"GT Vibration","subtitle":"Block 2","severity":"important","date":"2016-10-05T01:29"}]'>
      // define or bind to detail view here
    </px-inbox>

### Styling
The following custom properties are available for styling. See also px-alert-label for the variables to use for the badge icons.

Custom property | Description | Default
:----------------|:-------------|:----------
`--px-inbox-list-width` | Width of the list portion of the inbox | 320px
`--px-inbox-height` | Height of the full inbox component | 100vh
`--px-inbox-border-color` | Border color for list items |
`--px-inbox-secondary-text-color` | Text color for subtitle and date |
`--px-inbox-li-background-color` | Background color for list items |
`--px-inbox-li-background-color--hover` | Background color for list item when hovered |
`--px-inbox-li-background-color--selected` | Background color for selected list item |
`--px-inbox-li-text-color--selected` | Text color for selected list item |

@element px-inbox
@blurb A list/detail or "Inbox" view for drilling down on items for more information.
@homepage index.html
@demo index.html
-->

</head><body><dom-module id="px-inbox">
  <template>
    <style include="px-inbox-styles"></style>
    <section class$="inbox-container [[_getCollapsedClassNames(_isCollapsed, _detailViewActive)]]">
      <div id="list" class="list flex flex--col">
        <div class="search u-mt u-mh u-mb-">
          <input class="text-input" value="{{_query::input}}" placeholder="[[localize('Search')]]">
          <px-icon class="search__icon" icon="px-nav:search"></px-icon>
        </div>
        <div class="flex flex--justify flex--middle u-ph u-pb shadow-navigation">
          <div class="flex flex--row flex--middle">
            <span class="label u-mr--">[[localize('Sort by')]]:</span>
            <px-dropdown id="dropdown" class="sort-dropdown" select-by="key" button-style="bare" selected="{{sortBy}}" display-value="{{localize(sortBy)}}" items="[[_getLocalizedSortOptions(localize)]]" disable-clear="">
            </px-dropdown>
          </div>
          <px-icon id="sortIcon" class="actionable actionable--action" on-tap="_handleReverseSort" icon="[[_getSortIcon(sortOrder)]]"></px-icon>
        </div>
        <ul id="list__body" class="list-ui list-ui--small" on-scroll="_updateShadowScrollClassName">
          <template is="dom-repeat" items="{{listItems}}" as="listItem" filter="{{_computeFilter(_query)}}" sort="{{_computeSort(sortBy, sortOrder)}}">
            <li id="{{listItem.id}}" class$="list-ui__item pointer {{_getSelectedItemClassName(selectedItem,listItem.id)}}" on-tap="_handleItemTapped">
              <div class="flex flex--justify">
                <div class="flex flex--left">
                  <template is="dom-if" if="{{listItem.severity}}">
                    <px-alert-label class="flex__item--msfix" type="{{listItem.severity}}" label="{{_getLabel(listItem.severity)}}" badge=""></px-alert-label>
                  </template>
                  <div class="text">
                    <div class="title flex__item">{{listItem.title}}</div>
                    <div class="subtitle flex__item">{{listItem.subtitle}}</div>
                  </div>
                </div>
                <span class="info">{{_getFormattedDate(listItem.date, localize)}}</span>
              </div>
            </li>
          </template>
        </ul>
      </div>
      <div id="detail" class="detail">
        <span class="back-link actionable u-m-" on-tap="_handleShowListView"><px-icon class="u-mr--" icon="px-nav:back"></px-icon>[[localize('Back')]]</span>
        <slot></slot>
      </div>
    </section>
  </template>
</dom-module>

<script>Polymer({is:"px-inbox",behaviors:[Polymer.IronResizableBehavior,Polymer.AppLocalizeBehavior],properties:{listItems:{type:Array,observer:"_setInitialSelectedItem"},selectedItem:{type:String,notify:!0},selectedItemRef:{type:Object,notify:!0,readOnly:!0,computed:"_computeSelectedItemRef(selectedItem, listItems, listItems.*)"},_query:{type:String},sortBy:{type:String,value:"Date",notify:!0},sortOrder:{type:String,value:"ascending",notify:!0},disableAutoSelect:{type:Boolean,value:!1},language:{type:String,value:"en"},useKeyIfMissing:{type:Boolean,value:!0},resources:{type:Object,value:function value(){return{en:{Back:"Back","Sort by":"Sort by",Search:"Search",Title:"Title",Subtitle:"Subtitle",Severity:"Severity",Date:"Date","years ago":"years ago","a year ago":"a year ago","months ago":"months ago","a month ago":"a month ago","days ago":"days ago","a day ago":"a day ago","hours ago":"hours ago","an hour ago":"an hour ago","minutes ago":"minutes ago","a minute ago":"a minute ago","a few seconds ago":"a few seconds ago"}}}},_isCollapsed:{type:Boolean,value:!1},_detailViewActive:{type:Boolean,value:!1,observer:"_setInitialSelectedItem"}},listeners:{"iron-resize":"_calculateBounds"},_setInitialSelectedItem:function _setInitialSelectedItem(){if(Array.isArray(this.listItems)&&0<this.listItems.length&&!this.selectedItem&&!1===this.disableAutoSelect){this.selectedItem=this.listItems[0].id}},_handleItemTapped:function _handleItemTapped(evt){this.selectedItem=evt.model.listItem.id;this._detailViewActive=!0},_handleShowListView:function _handleShowListView(){this._detailViewActive=!1},_calculateBounds:function _calculateBounds(evt){this.debounce("resize",function(){if(700>this.getBoundingClientRect().width){this._isCollapsed=!0}else{this._isCollapsed=!1;this._detailViewActive=!0}},500)},_getFormattedDate:function _getFormattedDate(date,localize){if("string"===typeof date&&this._isValidDate(date)){return this._formatDateFromNow(new Date(date),new Date,localize)}if(babelHelpers.instanceof(date,Date)&&this._isValidDate(date)){return this._formatDateFromNow(date,new Date,localize)}return date},_isValidDate:function _isValidDate(dateString){return!isNaN(new Date(dateString).getTime())},_formatDateFromNow:function _formatDateFromNow(date,nowDate,localize){var _Mathfloor=Math.floor,seconds=_Mathfloor((nowDate-date)/1e3),years=_Mathfloor(seconds/31536e3),months=_Mathfloor(seconds/2592e3),days=_Mathfloor(seconds/86400),hours=_Mathfloor(seconds/3600),minutes=_Mathfloor(seconds/60);if(548<days)return"".concat(years," ").concat(this.localize("years ago"));if(320<=days&&547>=days)return this.localize("a year ago");if(45<=days&&319>=days)return"".concat(months," ").concat(this.localize("months ago"));if(26<=days&&45>=days)return this.localize("a month ago");if(36<=hours&&25>=days)return"".concat(days," ").concat(this.localize("days ago"));if(22<=hours&&35>=hours)return this.localize("a day ago");if(90<=minutes&&21>=hours)return"".concat(hours," ").concat(this.localize("hours ago"));if(45<=minutes&&89>=minutes)return this.localize("an hour ago");if(90<=seconds&&44>=minutes)return"".concat(minutes," ").concat(this.localize("minutes ago"));if(45<=seconds&&89>=seconds)return this.localize("a minute ago");if(0<=seconds&&45>=seconds)return this.localize("a few seconds ago")},_computeFilter:function _computeFilter(query){if(!query){return null}else{query=query.toLowerCase();return function(listItem){var title=listItem.title.toLowerCase(),subtitle=listItem.subtitle.toLowerCase();return-1!=title.indexOf(query)||-1!=subtitle.indexOf(query)}}},_handleReverseSort:function _handleReverseSort(){if("ascending"===this.sortOrder){this.sortOrder="descending"}else if("descending"===this.sortOrder){this.sortOrder="ascending"}},_computeSort:function _computeSort(sortBy,sortOrder){sortBy=sortBy?sortBy.toLowerCase():"";var asc="ascending"===sortOrder;if("severity"===sortBy&&asc){return function(a,b){var severities={important:4,warning:3,error:2,information:1,"":0,undefined:0};return severities[b.severity]-severities[a.severity]}}else if("severity"===sortBy&&!asc){return function(b,a){var severities={important:4,warning:3,error:2,information:1,"":0,undefined:0};return severities[b.severity]-severities[a.severity]}}else if("date"===sortBy&&asc){return function(a,b){return a.date>b.date?-1:a.date<b.date?1:0}}else if("date"===sortBy&&!asc){return function(b,a){return a.date>b.date?-1:a.date<b.date?1:0}}else if(asc){return function(a,b){return a[sortBy]<b[sortBy]?-1:a[sortBy]>b[sortBy]?1:0}}else{return function(b,a){return a[sortBy]<b[sortBy]?-1:a[sortBy]>b[sortBy]?1:0}}},_getSortIcon:function _getSortIcon(sortOrder){if("ascending"===sortOrder){return"px-nav:up"}if("descending"===sortOrder){return"px-nav:down"}},_getLocalizedSortOptions:function _getLocalizedSortOptions(localize){return[{key:"Title",val:localize("Title")},{key:"Subtitle",val:localize("Subtitle")},{key:"Severity",val:localize("Severity")},{key:"Date",val:localize("Date")}]},_getSelectedItemClassName:function _getSelectedItemClassName(selectedId,id){if(selectedId&&id&&id===selectedId){return"selected"}},_getCollapsedClassNames:function _getCollapsedClassNames(isCollapsed,detailViewActive){if(isCollapsed){return"collapsed "+(detailViewActive?"collapsed--detail-active":"collapsed--list-active")}},_getLabel:function _getLabel(severity){if("important"===severity)return"1";if("warning"===severity)return"2";if("error"===severity)return"3";if("information"===severity)return"4"},_computeSelectedItemRef:function _computeSelectedItemRef(selectedItemId,items){if(selectedItemId&&items&&Array.isArray(items)){for(var i=0;i<items.length;i++){if(items[i].id===selectedItemId){return items[i]}}}},_updateShadowScrollClassName:function _updateShadowScrollClassName(){this.debounce("update-class",function(){if(0<this.$.list__body.scrollTop){this.toggleClass("shadow-component",!0,Polymer.dom(this.root).querySelector(".list__header"))}else{this.toggleClass("shadow-component",!1,Polymer.dom(this.root).querySelector(".list__header"))}},50)}});</script>
</body></html>