<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="px-vis-behavior-common.html">
<link rel="import" href="px-vis-behavior-d3.html">
<link rel="import" href="../px-tooltip/px-tooltip.html">
<link rel="import" href="css/px-vis-styles.html">

<!--

### Minimal instantiation

    <px-vis-svg
        width="[[width]]"
        height="[[height]]"
        margin="[[margin]]"
        svg="{{svg}}">
    </px-vis-svg>
    <px-vis-scale
        x-axis-type="time"
        y-axis-type="linear"
        complete-series-config="[[seriesConfig]]"
        data-extents="[[dataExtents]]"
        width="[[width]]"
        height="[[height]]"
        margin="[[margin]]"
        chart-data={{chartData}}
        x="{{x}}"
        y="{{y}}"
        domain-changed="{{domainChanged}}">
    </px-vis-scale>
    <px-vis-axis
        svg="[[svg]]"
        axis="[[y]]"
        margin="[[margin]]"
        width="[[width]]"
        height="[[height]]"
        title="myTitle"
        orientation="left"
        label-position="center"
        complete-series-config="[[seriesConfig]]"
        muted-series=[[mutedSeries]]
        domain-changed="[[domainChanged]]">
    </px-vis-axis>

### d3 reference
https://github.com/mbostock/d3/wiki/SVG-Axes

### Styling
The following custom properties are available for styling:

Custom property | Description
:----------------|:-------------
  `--px-vis-font-family` | The font family for all labels and text
  `--px-vis-axis-color` | The color for the axis lines, axis ticks, and axis tick labels
  `--px-vis-axis-title-color` | The color for the axis title
  `--px-vis-axis-inline-title-color` | The color for the axis title
  `--px-vis-axis-inline-type-color` | The color for the axis lines, axis ticks, and axis tick labels when using 'inline' labelPosition
  `--px-vis-axis-inline-box-color` | The color for the tick boxes when using 'inline' labelPosition

@element px-vis-axis
@blurb d3 element which creates an axis for the chart
@homepage index.html
@demo demo.html
-->

</head><body><dom-module id="px-vis-axis">
  <template>
    <style include="px-vis-styles"></style>
  </template>
</dom-module>

<script>Polymer({is:"px-vis-axis",behaviors:[PxVisBehavior.observerCheck,PxVisBehaviorD3.svg,PxVisBehavior.sizing,PxVisBehaviorD3.axis,PxVisBehavior.completeSeriesConfig,PxVisBehavior.commonMethods,PxVisBehaviorD3.axisConfig,PxVisBehavior.truncating,PxVisBehaviorD3.domainUpdate,PxVisBehavior.preventInitialDrawing,PxVisBehavior.isAttached,PxVisBehavior.updateStylesOverride,PxVisBehavior.titleTruncation,PxVisBehavior.scaleTypeCheck],properties:{_axis:{type:Object,value:function value(){return{}}},_axisGroup:{type:Object},axisId:{type:String,value:"",reflectToAttribute:!0},displayedTitle:{type:String,notify:!0},appendUnitInTitle:{type:Boolean,value:!1},preventSeriesBar:{type:Boolean,value:!1},titleDrawn:{type:Number,value:0},seriesId:{type:String},_currentUnits:{type:String,value:"",computed:"_computeUnits(appendUnitInTitle, title, unit)"},_titleTruncated:{type:Boolean,value:!1},axisType:{type:String,value:"linear"},rotation:{type:Number},offset:{type:Array,value:[0,0]},disableTicks:{type:Boolean,value:!1},_titleGroup:{type:Object},_animationFrameDone:{type:Boolean,value:!1},seriesOnAxis:{type:Array,value:function value(){return[]}},rebuildOnDraw:{type:Boolean,value:!1},_removingAxis:{type:Boolean,value:!1},_tooltipElem:{type:HTMLElement},_axisDrawn:{type:Number,value:0},unit:{type:String,value:""},titleOffset:{type:Array,value:function value(){return[0,0]}},_builtAxisType:String,_tooltipTimer:Number,_tooltipRequested:{type:Boolean,value:!1},_titleText:Object},observers:["drawElement(domainChanged, svg, axis, margin, width, height, disableTicks, _animationFrameDone, preventInitialDrawing, _isAttached, _stylesUpdated)","_calcDrawnTicks(domainChanged)","drawSeriesBars(completeSeriesConfig.*, titleDrawn)","_muteSeriesBars(mutedSeries.*)","_updateTicks(ticks)","_updateTicks(tickFormat)","_updateTicks(tickValues)","_titleChanged(displayedTitle, _axisDrawn, titleLocation.*)","_truncateTitle(title, truncationLength, appendUnitInTitle, completeSeriesConfig, _currentUnits)","_orientationChanged(orientation)"],detached:function detached(){this.removeAll();if(this.drawnTickValues&&0<this.drawnTickValues.length){this.set("drawnTickValues",[]);this.fire("px-vis-axis-drawn-tick-values-changed",{drawnTickValues:[]})}},ready:function ready(){window.requestAnimationFrame(function(){this.set("_animationFrameDone",!0)}.bind(this));if(!this.axisId){this.set("axisId",this.generateRandomID("axis_"))}},attached:function attached(){if(this._axisGroup){this.fire("px-axis-done")}},defineAxis:function defineAxis(){var _Mathmax=Math.max;switch(this.orientation){case"bottom":this._axis=Px.d3.axisBottom(this.axis);var h=_Mathmax(this.height-this.margin.bottom-this.margin.top,0);this.translateAmt=[this.offset[0],this.offset[1]+h];break;case"top":this._axis=Px.d3.axisTop(this.axis);this.translateAmt=[this.offset[0],this.offset[1]];break;case"right":this._axis=Px.d3.axisRight(this.axis);var w=_Mathmax(this.width-this.margin.left-this.margin.right,0);this.translateAmt=[this.offset[0]+w,this.offset[1]];break;default:this._axis=Px.d3.axisLeft(this.axis);this.translateAmt=[this.offset[0],this.offset[1]];break;}this._builtAxisType=this.axisType;this._processTicks()},_processTicks:function _processTicks(){if(this.ticks&&!this._isOrdinalType(this.axisType)){if("number"===typeof this.ticks||!isNaN(parseInt(this.ticks))){this._axis.ticks(this.ticks)}else if("function"===typeof this.ticks){this._axis.ticks(this.ticks)}else if("object"===babelHelpers.typeof(this.ticks)&&this.ticks.interval&&this.ticks.format){this._axis.ticks(this.ticks.interval,this.ticks.format)}else if("object"===babelHelpers.typeof(this.ticks)&&this.ticks.interval&&"time"!==this.axisType||"timeLocal"!==this.axisType){this._axis.ticks(this.ticks.interval)}else if("object"===babelHelpers.typeof(this.ticks)&&this.ticks.format&&"time"!==this.axisType||"timeLocal"!==this.axisType){this._axis.ticks(10,this.ticks.format)}else{console.error("Cannot interpret axis ticks")}}if(this.tickFormat&&!this._isOrdinalType(this.axisType)){if("function"===typeof this.tickFormat){this._axis.tickFormat(this.tickFormat)}else if("time"===this.axisType){this._axis.tickFormat(Px.d3.utcFormat(this.tickFormat))}else if("timeLocal"===this.axisType){this._axis.tickFormat(Px.d3.timeFormat(this.tickFormat))}else if("linear"===this.axisType){this._axis.tickFormat(Px.d3.format(this.tickFormat))}}if(this.tickValues&&0<this.tickValues.length&&!this._isOrdinalType(this.axisType)){if(!isNaN(this.axis.domain()[0])&&!isNaN(this.axis.domain()[1])){this._axis.tickValues(this.tickValues)}}if("inline"===this.labelPosition){this._axis.tickSizeInner(0)}else if("center"!==this.labelPosition){this._axis.tickSizeInner(this.labelTypeSize)}if(this.tickSizeInner||0===this.tickSizeInner){this._axis.tickSizeInner(this.tickSizeInner)}if(this.tickPadding||0===this.tickPadding){this._axis.tickPadding(this.tickPadding)}this._axis.tickSizeOuter(this.tickSizeOuter);if(this.disableTicks){this._axis.ticks(0)}},removeAll:function removeAll(){this.removeTitle();this.removeAxis()},removeAxis:function removeAxis(){this._removingAxis=!0;this._axisDrawn=0;if(this._axisGroup){this._axisGroup.remove();this._axisGroup=null}this._removingAxis=!1},removeTitle:function removeTitle(){if(this._titleGroup){this._titleGroup.remove();this._titleGroup=null}},drawElement:function drawElement(){if(this.hasUndefinedArguments(arguments)){return}if(babelHelpers.typeof(this.preventInitialDrawing)!==void 0&&!1===this.preventInitialDrawing){this.debounce("drawaxis",function(){if(this._isAttached&&this._animationFrameDone&&this._doesD3HaveValues(this.svg)&&this.domainChanged&&this.orientation&&this.axis){if(this.rebuildOnDraw){this.removeAxis()}this.defineAxis();if(!this._axisGroup){this._buildAxis()}else{this._updateAxis()}this._axisDrawn+=1;this.fire("px-axis-done")}},10)}},_updateAxis:function _updateAxis(){this._axisGroup.attr("transform",function(){if(this.rotation){return"rotate("+ +this.rotation+") translate("+this.translateAmt.join(",")+")"}else{return"translate("+this.translateAmt.join(",")+")"}}.bind(this)).call(this._axis);this._setLineStyles(this._axisGroup);this._setLabelStyles(this._axisGroup);this._calcDrawnTicks()},_buildAxis:function _buildAxis(){var g=this.svg.append("g").attr("class","axis").attr("axis-id",this.axisId).attr("transform",function(){if(this.rotation){return"rotate("+ +this.rotation+") translate("+this.translateAmt.join(",")+")"}else{return"translate("+this.translateAmt.join(",")+")"}}.bind(this)).call(this._axis);g.select("path.domain").attr("stroke",this._findAxisSubColor(this.axisLineColor,"--px-vis-axis-color","black"));this.set("_axisGroup",g);this._setLineStyles(this._axisGroup);this._setLabelStyles(this._axisGroup);this._calcDrawnTicks()},_updateTicks:function _updateTicks(){if(this.hasUndefinedArguments(arguments)){return}if(this._doesObjHaveValues(this._axis)&&this.axis&&this.margin&&this.height&&"undefined"!==typeof this.disableTicks){this.drawElement()}},_calcDrawnTicks:function _calcDrawnTicks(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("drawnTicks",function(){if(!this.domainChanged||this._isOrdinalType(this.axisType)||!this._axis||!this._axis.scale||this._builtAxisType!==this.axisType){return}if(this.ticks&&"number"===typeof this.ticks){this.set("drawnTickValues",this._axis.scale().ticks(this.ticks))}else{this.set("drawnTickValues",this._axis.scale().ticks())}this.fire("px-vis-axis-drawn-tick-values-changed",{drawnTickValues:this.drawnTickValues})},1)},setLabelDims:function setLabelDims(){var label={};if("inline"===this.labelPosition){if("left"===this.orientation||"right"===this.orientation){label.x=0;label.y=0;label.anchor="middle"}else{label.x=0;label.y=-this.labelTypeSize/3;label.anchor="middle"}return label}switch(this.orientation){case"bottom":label.x=5;label.y=this.labelTypeSize/4;label.anchor="after"===this.labelPosition?"start":"end";break;case"top":label.x=5;label.y=this.labelTypeSize/-4;label.anchor="after"===this.labelPosition?"start":"end";break;case"left":label.x=-2*this.labelTypeSize/3;label.y="after"===this.labelPosition?-2*this.labelTypeSize/3:2*this.labelTypeSize/3;label.anchor="end";break;case"right":label.x=2*this.labelTypeSize/3;label.y="after"===this.labelPosition?-2*this.labelTypeSize/3:2*this.labelTypeSize/3;label.anchor="start";break;}return label},_setLabelStyles:function _setLabelStyles(elem){elem.selectAll("text").attr("font-size",this.labelTypeSize+"px").style("font-family",this._checkThemeVariable("--px-vis-font-family","Comic Sans MS")).attr("font-style",this._checkThemeVariable("--px-vis-font-family","Comic Sans MS"));if("inline"!==this.labelPosition){elem.selectAll("text").attr("fill",this._findAxisSubColor(this.axisLabelColor,"--px-vis-axis-color","black"));elem.selectAll("g.tick").selectAll("line").attr("stroke",this._findAxisSubColor(this.axisTickColor,"--px-vis-axis-color","black"))}if("center"!==this.labelPosition){var label=this.setLabelDims();elem.selectAll("text").attr("y",label.y).attr("x",label.x).attr("text-anchor",label.anchor).style("text-anchor",label.anchor).attr("transform","rotate("+this.labelRotation+") translate("+this.labelTranslation.join(",")+")")}if("inline"===this.labelPosition){var gTick=elem.selectAll("g.tick"),tickText=gTick.select("text");gTick.selectAll("rect").remove();gTick.insert("rect","text").attr("x",function(d,i){return tickText.nodes()[i].getBoundingClientRect().width/-2-3}).attr("y",-.5*this.labelTypeSize-2).attr("width",function(d,i){return tickText.nodes()[i].getBoundingClientRect().width+6}).attr("height",this.labelTypeSize+4).attr("fill",this._findAxisSubColor(this.axisLineColor,"--px-vis-axis-inline-box-color","black")).attr("transform","rotate("+this.labelRotation+")");tickText.attr("fill",this._checkThemeVariable("--px-vis-axis-inline-type-color","rbg(255,255,255)"))}},_setLineStyles:function _setLineStyles(elem){var theme="inline"===this.labelPosition?"--px-vis-axis-inline-box-color":"--px-vis-axis-color";elem.selectAll("path").attr("fill","none").attr("stroke",this._findAxisSubColor(this.axisLineColor,theme,"black")).attr("shape-rendering","crispEdges").attr("stroke-width",this.strokeWidth);elem.selectAll("line").attr("fill","none").attr("stroke",this._findAxisSubColor(this.axisTickColor,theme,"black")).attr("shape-rendering","crispEdges").attr("stroke-width",this.strokeWidth)},_getAxisGroupSize:function _getAxisGroupSize(){var ext;try{ext=this._axisGroup.node().getBBox()}catch(e){ext=this._axisGroup.node().getBoundingClientRect()}return ext},_calcTopBottomLabelSize:function _calcTopBottomLabelSize(){return"center"===this.labelPosition?this.labelTypeSize:0},_calcLeftRightLabelSize:function _calcLeftRightLabelSize(){var _Mathmax2=Math.max,size=0;if(this._isTimeType(this.axisType)||this._isOrdinalType(this.axisType)){size=parseFloat(this._getAxisGroupSize().width)}else{var ticks=null;if(this.ticks&&"number"===typeof this.ticks){ticks=this.ticks}else if(this.ticks&&"object"===babelHelpers.typeof(this.ticks)&&this.ticks.interval){ticks=this.ticks.interval}var chars=0,ticksVals=this.tickValues?this.tickValues:this.axis.ticks(ticks),formatter=this.tickFormat?this._axis.tickFormat():this.axis.tickFormat(),formattedMin=formatter(ticksVals[0]),formattedMax=formatter(ticksVals[ticksVals.length-1]);chars=_Mathmax2(formattedMin.length,chars);chars=_Mathmax2(formattedMax.length,chars);size=.5*(chars*this.labelTypeSize)+.5*this.labelTypeSize}return size},drawTitle:function drawTitle(){this.removeTitle();var ext={},location=this._doesObjHaveValues(this.titleLocation)?"custom":this.orientation,x,y,r,anchor;switch(location){case"bottom":ext.width=(this.axis.range()[1]-this.axis.range()[0])/2;ext.height=this.labelRotation?parseFloat(this._getAxisGroupSize().height):this._axis.tickSizeInner()+this._calcTopBottomLabelSize()+this.labelTranslation[1]+this.titleTypeSize+5;x=ext.width+this.translateAmt[0]+this.titleOffset[0];y=ext.height+this.translateAmt[1]+this.titleOffset[1];r=0;anchor="middle";break;case"top":ext.width=(this.axis.range()[1]-this.axis.range()[0])/2;ext.height=this.labelRotation?parseFloat(this._getAxisGroupSize().height):this._axis.tickSizeInner()+this._calcTopBottomLabelSize()+this.labelTranslation[1]+5;x=ext.width+this.translateAmt[0]+this.titleOffset[0];y=-ext.height+this.translateAmt[1]+this.titleOffset[1];r=0;anchor="middle";break;case"left":ext.width=this.labelRotation?-1*parseFloat(this._getAxisGroupSize().width):this._axis.tickSizeInner()+this._calcLeftRightLabelSize()+this.labelTranslation[0]+5;ext.height=(this.axis.range()[1]-this.axis.range()[0])/2;x=-ext.width+this.translateAmt[0]+this.titleOffset[0];y=-ext.height+this.translateAmt[1]+this.titleOffset[1];r=-90;anchor="middle";break;case"right":ext.width=this.labelRotation?parseFloat(this._getAxisGroupSize().width):this._axis.tickSizeInner()+this._calcLeftRightLabelSize()+this.labelTranslation[0]+this.titleTypeSize;ext.height=(this.axis.range()[1]-this.axis.range()[0])/2;x=ext.width+this.translateAmt[0]+this.titleOffset[0];y=-ext.height+this.translateAmt[1]+this.titleOffset[1];r=-90;anchor="middle";break;case"custom":x=this.titleLocation.x;y=this.titleLocation.y;r=this.titleLocation.r;anchor=this.titleLocation.anchor;break;}this._titleGroup=this.svg.append("g").attr("class","title-group").attr("for",this.axisId).attr("transform","translate("+x+","+y+")");var themeVar="inline"===this.labelPosition?"--px-vis-axis-inline-title-color":"--px-vis-axis-title-color";this._titleText=this._titleGroup.append("text").attr("class","axis-title").attr("fill",this._findAxisSubColor(this.axisTitleColor,themeVar,"black")).attr("font-size",this.titleTypeSize+"px").style("font-family",this._checkThemeVariable("--px-vis-font-family","Comic Sans MS")).attr("font-style",this._checkThemeVariable("--px-vis-font-family","Comic Sans MS")).text(this.displayedTitle).attr("text-anchor",anchor).style("text-anchor",anchor).attr("transform","rotate("+r+")").attr("pointer-events","none").on("mouseenter",null).on("mouseleave",null);if(this._titleTruncated){this._titleText.attr("pointer-events","all").on("mouseenter",this._onTitleHover.bind(this)).on("mouseleave",this._onTitleLeave.bind(this))}this.set("titleDrawn",this.titleDrawn+1)},drawSeriesBars:function drawSeriesBars(){if(this.hasUndefinedArguments(arguments)){return}if(!this.preventSeriesBar&&this._doesObjHaveValues(this.completeSeriesConfig)&&this._axisGroup&&this._titleGroup){var keys=0<this.seriesOnAxis.length?this.seriesOnAxis:Object.keys(this.completeSeriesConfig),kLen=keys.length,i;for(i=0;i<kLen;i++){if(this.completeSeriesConfig[keys[i]]){this._drawBar(this._titleGroup,keys[i],this.completeSeriesConfig[keys[i]].color,i,this.completeSeriesConfig[keys[i]].dashPattern)}}}},_muteSeriesBars:function _muteSeriesBars(){if(this.hasUndefinedArguments(arguments)){return}if(this._doesD3HaveValues(this._titleGroup)&&!this.preventSeriesBar){for(var keys=Object.keys(this.mutedSeries),i=0,series;i<keys.length;i++){series=this._titleGroup.select("[series-bar-id=bar_"+this._escapeCssSelector(keys[i])+"]");if(this.mutedSeries[keys[i]]){series.attr("opacity",.5)}else{series.attr("opacity",1)}}}},_drawBar:function _drawBar(elem,sid,color,index,dashPattern){var w=elem.select(".axis-title").node().getComputedTextLength(),translate="translate(-12,"+(-w/2-10-8*index)+")",mutedSeriesValue=this.mutedSeries&&this.mutedSeries[sid]?.5:1;elem.append("line").attr("x1",0).attr("x2",15).attr("y1",0).attr("y2",0).attr("stroke",color).attr("stroke-width",3).attr("stroke-dasharray",dashPattern).attr("series-bar-id","bar_"+sid).attr("transform",translate).attr("opacity",mutedSeriesValue)},_computeUnits:function _computeUnits(appendUnitInTitle){if(appendUnitInTitle===void 0){return}var result="";if(appendUnitInTitle&&this.unit){result=" ["+this.unit+"]"}return result},_truncateTitle:function _truncateTitle(title,truncationLength,appendUnitInTitle){if(this.hasUndefinedArguments(arguments)){return}this.debounce("_truncateTitle",function(){var oldTitle=this.displayedTitle,newTitle;if(this.titleTruncation&&2<title.length&&title.length>this.truncationLength){newTitle=this._truncateName(title,truncationLength)+this._currentUnits;this.set("_titleTruncated",!0)}else{newTitle=title+this._currentUnits;this.set("_titleTruncated",!1)}if(newTitle!==oldTitle){this.fire("px-vis-axis-displayed-title-changed",{displayedTitle:newTitle,title:this.title,id:this.seriesId});this.set("displayedTitle",newTitle)}},5)},_titleChanged:function _titleChanged(displayedTitle){if(this.hasUndefinedArguments(arguments)){return}if(!this._removingAxis&&this._axisDrawn){this.drawTitle()}},_orientationChanged:function _orientationChanged(){if(this.hasUndefinedArguments(arguments)){return}this.removeAxis();this.drawElement()},_findAxisSubColor:function _findAxisSubColor(subProperty,cssVarName,cssVarDefault){if(subProperty){return subProperty}else{return this.axisColor?this.axisColor:this._checkThemeVariable(cssVarName,cssVarDefault)}},_onTitleHover:function _onTitleHover(){var _this=this;if(!this._titleTruncated){return}this._tooltipRequested=!0;this._tooltipTimer=setTimeout(function(){var detail={origin:_this,is:_this.is,element:_this._titleText.node(),data:[{text:"".concat(_this.title," ").concat(_this._currentUnits)}]};_this.dispatchEvent(new CustomEvent("central-tooltip-display-request",{bubbles:!0,composed:!0,detail:detail}));_this._tooltipRequested=!1},500)},_onTitleLeave:function _onTitleLeave(){if(!this._titleTruncated){return}if(this._tooltipRequested){clearTimeout(this._tooltipTimer)}else{this.dispatchEvent(new CustomEvent("central-tooltip-cancel-request",{bubbles:!0,composed:!0,detail:{origin:this}}))}}});</script>
</body></html>