<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="px-vis-behavior-common.html">
<link rel="import" href="px-vis-behavior-d3.html">
<link rel="import" href="px-vis-scale.html">
<link rel="import" href="px-vis-svg.html">


</head><body><dom-module id="px-vis-box-whisker">
  <script>Polymer({is:"px-vis-box-whisker",behaviors:[PxVisBehavior.commonMethods,PxVisBehavior.dynamicConfigProperties,PxVisBehavior.svgDefinition,PxVisBehavior.updateStylesOverride,PxVisBehaviorD3.axes,PxVisBehaviorD3.domainUpdate,PxVisBehaviorD3.scatterMarkers],properties:{seriesKey:{type:String},completeSeriesConfig:{type:Object},data:{type:Object,value:{}},position:{type:String,value:"0"},orientation:{type:String,value:"vertical"},boxWidth:{type:Number,value:30},edgeWidth:{type:Number,value:15},outlierSymbol:{type:String},outlierSize:{type:Number},outlierScale:{type:Number},meanSymbol:{type:String},meanSize:{type:Number},meanScale:{type:Number},fillColor:{type:String},strokeColor:{type:String},medianColor:{type:String},medianWidth:{type:String},meanStrokeColor:{type:String},meanFillColor:{type:String},outlierStrokeColor:{type:String},outlierFillColor:{type:String},drawDebounceTime:{type:Number,value:50},_svgGroup:{type:Object},_stylesResolved:{type:Boolean,value:!1}},observers:["draw(data, position, svg, x, y, domainChanged, boxWidth, edgeWidth, seriesKey, completeSeriesConfig, _stylesResolved)","_resolveCssVars(_stylesUpdated, completeSeriesConfig)"],detached:function detached(){if(this._svgGroup){this._svgGroup.remove()}},getSvgBoxElement:function getSvgBoxElement(){var boxEls=this._svgGroup.selectAll(".box");if(boxEls&&boxEls._groups&&boxEls._groups[0]){return boxEls._groups[0][0]}return[]},getSvgOutlierElements:function getSvgOutlierElements(){var outlierEls=this._svgGroup.selectAll(".outlier");if(outlierEls&&outlierEls._groups){return outlierEls._groups[0]}return[]},draw:function draw(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("drawDebounce",function(){this._drawDebounced()},this.drawDebounceTime)},_drawDebounced:function _drawDebounced(){if(!this._isObjEmpty(this._svgGroup)){this._svgGroup.remove()}if(!this.data){console.warn("Skipping draw, no data");return}if(!this.x||!this.y){console.warn("Skipping draw, no x and y functions");return}var drawingData;try{drawingData=this._getDrawingData(this.data,this.position,this.orientation,this.boxWidth,this.edgeWidth)}catch(e){console.info("Skipping draw, invalid draw data (likely due to out of date x or y function)");return}this._svgGroup=this.svg.append("g");var boxWhisker=this._svgGroup.append("g").attr("class","box hoverTransition");this._appendLine(boxWhisker,drawingData.max,this.strokeColor,"1px");this._appendLine(boxWhisker,drawingData.q3Whisker,this.strokeColor,"1px");this._appendRectangle(boxWhisker,drawingData.q3Box,this.strokeColor,this.fillColor);this._appendRectangle(boxWhisker,drawingData.q1Box,this.strokeColor,this.fillColor);this._appendLine(boxWhisker,drawingData.q1Whisker,this.strokeColor,"1px");this._appendLine(boxWhisker,drawingData.min,this.strokeColor,"1px");this._appendLine(boxWhisker,drawingData.median,this.medianColor,this.medianWidth);var meanBuilder=boxWhisker.selectAll("path.mean").data([this.data.mean]);meanBuilder.exit().remove();meanBuilder.enter().append("path").attr("class","mean").merge(meanBuilder).attr("d",Px.d3.symbol().type(this.markerMapping[this.meanSymbol]).size(this.meanSize)).attr("fill",this.meanFillColor).attr("stroke",this.meanStrokeColor).attr("pointer-events","none").attr("transform",function(value){return this._getSvgTransform(value,this.position,this.meanScale,this.orientation)}.bind(this));if(this.data.outliers){var outlierBuilder=this._svgGroup.selectAll("path.outlier").data(this.data.outliers);outlierBuilder.exit().remove();outlierBuilder.enter().append("path").attr("class","outlier hoverTransition").on("mouseover",this._handleOutlierMouseover.bind(this)).on("mouseout",this._handleOutlierMouseout.bind(this)).on("click",this._handleOutlierClick.bind(this)).merge(outlierBuilder).attr("d",Px.d3.symbol().type(this.markerMapping[this.outlierSymbol]).size(this.outlierSize)).attr("fill",this.outlierFillColor).attr("stroke",this.outlierStrokeColor).attr("transform",function(value){return this._getSvgTransform(value,this.position,this.outlierScale,this.orientation)}.bind(this))}var mouseoverBox={x:drawingData.q3Box.x,y:drawingData.q3Box.y,height:drawingData.q3Box.height+drawingData.q1Box.height,width:drawingData.q3Box.width},mouseoverSvg=this._appendRectangle(boxWhisker,mouseoverBox,"transparent","transparent");mouseoverSvg.attr("pointer-events","all");boxWhisker.on("mouseover",this._handleBoxMouseover.bind(this)).on("mouseout",this._handleBoxMouseout.bind(this)).on("click",this._handleBoxClick.bind(this))},_appendRectangle:function _appendRectangle(svg,data,strokeColor,fillColor){return svg.append("rect").attr("x",data.x).attr("y",data.y).attr("width",data.width).attr("height",data.height).attr("stroke",strokeColor).attr("fill",fillColor).attr("pointer-events","none")},_appendLine:function _appendLine(svg,data,strokeColor,strokeWidth){return svg.append("line").attr("x1",data.x1).attr("y1",data.y1).attr("x2",data.x2).attr("y2",data.y2).attr("stroke",strokeColor).attr("stroke-width",strokeWidth).attr("pointer-events","none")},_getDrawingData:function _getDrawingData(data,position,orientation,boxWidth,minMaxWidth){return"horizontal"===orientation?this._getDrawingDataHorizontal(data,position,boxWidth,minMaxWidth):this._getDrawingDataVertical(data,position,boxWidth,minMaxWidth)},_getDrawingDataVertical:function _getDrawingDataVertical(data,position,boxWidth,minMaxWidth){var drawingData={},points=this._chartDataToSvgPoints(data,position,this.y,this.x),boxLeft=points.middle-boxWidth/2,boxRight=boxLeft+boxWidth,minMaxLeft=points.middle-minMaxWidth/2,minMaxRight=minMaxLeft+minMaxWidth;drawingData.max={x1:minMaxLeft,y1:points.max,x2:minMaxRight,y2:points.max};drawingData.min={x1:minMaxLeft,y1:points.min,x2:minMaxRight,y2:points.min};drawingData.q3Whisker={x1:points.middle,y1:points.max,x2:points.middle,y2:points.q3};drawingData.q1Whisker={x1:points.middle,y1:points.q1,x2:points.middle,y2:points.min};drawingData.q3Box={x:boxLeft,y:points.q3,width:boxWidth,height:points.median-points.q3};drawingData.q1Box={x:boxLeft,y:points.median,width:boxWidth,height:points.q1-points.median};drawingData.median={x1:boxLeft,y1:points.median,x2:boxRight,y2:points.median};return drawingData},_getDrawingDataHorizontal:function _getDrawingDataHorizontal(data,position,boxWidth,minMaxWidth){var drawingData={},points=this._chartDataToSvgPoints(data,position,this.x,this.y),boxLeft=points.middle-boxWidth/2,boxRight=boxLeft+boxWidth,minMaxLeft=points.middle-minMaxWidth/2,minMaxRight=minMaxLeft+minMaxWidth;drawingData.max={y1:minMaxLeft,x1:points.max,y2:minMaxRight,x2:points.max};drawingData.min={y1:minMaxLeft,x1:points.min,y2:minMaxRight,x2:points.min};drawingData.q3Whisker={y1:points.middle,x1:points.max,y2:points.middle,x2:points.q3};drawingData.q1Whisker={y1:points.middle,x1:points.q1,y2:points.middle,x2:points.min};drawingData.q3Box={y:boxLeft,x:points.median,height:boxWidth,width:points.q3-points.median};drawingData.q1Box={y:boxLeft,x:points.q1,height:boxWidth,width:points.median-points.q1};drawingData.median={y1:boxLeft,x1:points.median,y2:boxRight,x2:points.median};return drawingData},_chartDataToSvgPoints:function _chartDataToSvgPoints(data,position,y,x){var formatted={};for(var key in data){if(Array.isArray(data[key])){formatted[key]=Array(data[key].length);for(var i in data[key]){if("number"===typeof data[key][i]){formatted[key][i]=y(data[key][i]);if(isNaN(formatted[key][i])){throw"Value "+data[key][i]+" converted to NaN"+""}}}}else if("number"===typeof data[key]){formatted[key]=y(data[key]);if(isNaN(formatted[key])){throw"Value "+data[key]+" converted to NaN"+""}}else{console.warn("unknown property")}}formatted.middle=x(position)+x.bandwidth()/2;if(isNaN(formatted.middle)){throw"Value "+position+" converted to NaN"+""}return formatted},_getSvgTransform:function _getSvgTransform(value,position,scale,orientation){var transform=this._pointToSvgPoint(value,position,orientation),str="translate("+transform.x+","+transform.y+")";if(scale!==void 0){str+=" scale("+scale+")"}return str},_pointToSvgPoint:function _pointToSvgPoint(value,position,orientation){if("horizontal"===orientation){return{x:this.x(value),y:this.y(position)+this.y.bandwidth()/2}}else{return{x:this.x(position)+this.x.bandwidth()/2,y:this.y(value)}}},_handleBoxMouseover:function _handleBoxMouseover(d,i,svgEl){this.fire("px-vis-box-mouseover",{seriesKey:this.seriesKey,data:this.data,position:this.position,svgEl:svgEl[i]})},_handleBoxMouseout:function _handleBoxMouseout(d,i,svgEl){this.fire("px-vis-box-mouseout",{seriesKey:this.seriesKey,data:this.data,position:this.position,svgEl:svgEl[i]})},_handleBoxClick:function _handleBoxClick(d,i,svgEl){this.fire("px-vis-box-click",{seriesKey:this.seriesKey,data:this.data,position:this.position,svgEl:svgEl[i]})},_handleOutlierMouseover:function _handleOutlierMouseover(outlierValue,i,svgEl){this.fire("px-vis-outlier-mouseover",{seriesKey:this.seriesKey,data:outlierValue,position:this.position,svgEl:svgEl[i]})},_handleOutlierMouseout:function _handleOutlierMouseout(outlierValue,i,svgEl){this.fire("px-vis-outlier-mouseout",{seriesKey:this.seriesKey,data:outlierValue,position:this.position,svgEl:svgEl[i]})},_handleOutlierClick:function _handleOutlierClick(outlierValue,i,svgEl){this.fire("px-vis-outlier-click",{seriesKey:this.seriesKey,data:outlierValue,position:this.position,svgEl:svgEl[i]})},_resolveCssVars:function _resolveCssVars(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("resolve-css-vars",function(){var seriesConfig=this.completeSeriesConfig||{},config=seriesConfig[this.seriesKey]||{};this.fillColor=config.color||this._checkThemeVariable("--px-vis-box-whisker-fill-color","#000");this.strokeColor=config.strokeColor||this._checkThemeVariable("--px-vis-box-whisker-stroke-color","#000");this.medianColor=config.medianColor||this._checkThemeVariable("--px-vis-box-whisker-median-color","#FFF");this.medianWidth=config.medianWidth||this._checkThemeVariable("--px-vis-box-whisker-median-width","1px");this.meanStrokeColor=config.meanStrokeColor||this._checkThemeVariable("--px-vis-box-whisker-mean-color",this.strokeColor);this.meanFillColor=config.meanFillColor||this._checkThemeVariable("--px-vis-box-whisker-mean-fill-color","#FFF");this.meanSize=this._removePx(config.meanSize||this._checkThemeVariable("--px-vis-box-whisker-mean-size",10));this.outlierStrokeColor=config.outlierStrokeColor||this._checkThemeVariable("--px-vis-box-whisker-outlier-color",this.strokeColor);this.outlierFillColor=config.outlierFillColor||this._checkThemeVariable("--px-vis-box-whisker-outlier-fill-color","transparent");this.outlierSize=this._removePx(config.outlierSize||this._checkThemeVariable("--px-vis-box-whisker-outlier-size",10));this.outlierSymbol=config.outlierSymbol||"circle";this.outlierScale=config.outlierScale||1;this.meanSymbol=config.meanSymbol||"circle";this.meanScale=config.meanScale||1;var comps;if(this.shadowRoot){comps=this.shadowRoot.querySelectorAll("px-vis-box-whisker")}else{comps=Polymer.dom(this.root).querySelectorAll("px-vis-box-whisker")}if(comps){comps.forEach(function(comp){comp.updateStyles()})}this.set("_stylesResolved",!this._stylesResolved)}.bind(this),10)},_removePx:function _removePx(str){if(str&&"string"===typeof str){return str.replace("px","")}else{return str}}});</script>
</dom-module>
</body></html>