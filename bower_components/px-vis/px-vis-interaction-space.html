<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-icon-set/px-icon-set.html">
<link rel="import" href="px-vis-behavior-common.html">
<link rel="import" href="px-vis-behavior-interaction.html">
<link rel="import" href="px-vis-behavior-d3.html">
<link rel="import" href="css/px-vis-styles.html">

<!--
Sets the tooltipData property, which can then be used to share adjacent datapoint values with other components, such as the register.

### Usage

    <px-vis-interaction-space
        svg="[[svg]]"
        width="[[width]]"
        height="[[height]]"
        margin="[[margin]]"
        chart-data="[[chartData]]"
        x="[[x]]"
        y="[[y]]"
        tooltip-data="{{tooltipData}}"
        extents-data="{{extentsData}}">
    </px-vis-interaction-space>

### Styling
The following custom properties are available for styling:

Custom property | Description | Default
:----------------|:-------------|----------
  `--px-vis-zoom-brush-outline-color` | The stroke (border) color for the on-chart zoom/selection brush | `$grey6`
  `--px-vis-zoom-brush-fill-color` | The fill (background) color for the on-chart zoom/selection brush | `$gray2`
  `--px-vis-zoom-brush-fill-opacity` | The opacity for the on-chart zoom/selection brush | `0.5`

  `--px-vis-lasso-outline-color` | The stroke (border) color for the on-chart lasso selection | `$grey12`
  `--px-vis-lasso-fill-color` | The fill (background) color for the on-chart lasso selection | `none`
  `--px-vis-lasso-fill-opacity` | The opacity for the on-chart lasso selection | `0.5`

@element px-vis-interaction-space
@blurb Element providing on-chart hover functionality to get data values near the mouse cursor.
@homepage index.html
@demo demo.html

TODO implement a dev setting to choose between only showing data at that x, snapping to nearest data, or interpolating value at x

-->

</head><body><dom-module id="px-vis-interaction-space">
    <template>
      <style include="px-vis-styles"></style>


    </template>
</dom-module>

<script>Polymer({is:"px-vis-interaction-space",behaviors:[PxVisBehavior.observerCheck,PxVisBehavior.sizing,PxVisBehaviorD3.svg,PxVisBehaviorD3.axes,PxVisBehavior.dataset,PxVisBehavior.tooltipData,PxVisBehavior.mutedSeries,PxVisBehavior.crosshairData,PxVisBehavior.extentsData,PxVisBehavior.commonMethods,PxVisBehavior.axisTypes,PxVisBehavior.completeSeriesConfig,PxVisBehavior.zoomSelection,PxVisBehavior.seriesKeys,PxVisBehavior.selectionType,PxVisBehavior.polarData,PxVisBehavior.applyActionConfig,PxVisBehavior.interactionSpaceShared,PxVisBehavior.preventWebWorkerSynchronization,PxVisBehavior.wwDataSyncCounter,PxVisBehaviorD3.cursorIcon,PxVisBehaviorInteraction.lasso,PxVisBehavior.scaleTypeCheck],properties:{_rect:{type:Object},_actionArea:{type:Object,value:function value(){return{}}},mouseRect:{type:Object,notify:!0},timeData:{type:String,value:"Timestamp"},actionMapping:{type:Object,readOnly:!0,value:{startZooming:"_startZooming",stopZooming:"_finishActionBox",startStriping:"_startStriping",stopStriping:"_finishActionBox",calcTooltipData:"_calcTooltipData",calcCrosshairData:"_calcCrosshairData",calcTooltipAndCrosshairData:"_calcTooltipAndCrosshairData",resetTooltipAndCrosshairData:"_resetTooltipAndCrosshairData",resetTooltip:"_resetTooltipData",resetCrosshair:"_resetCrosshairData",startPanning:"_startPanning",stopPanning:"_stopPanning",reportMouseCoords:"_reportMouseCoords",startLasso:"_startLasso",stopLasso:"_stopLasso",calcPinnedMarkedData:"_calcPinnedMarkedData"}},actionConfig:{type:Object,notify:!0,value:function value(){return{mousedown:"startZooming",mouseup:"stopZooming",mouseout:"resetTooltip",mousemove:"calcTooltipData"}}},_panningStartVal:{type:Array,value:function value(){return[]}},showTooltip:{type:Boolean,value:!0},_calculatingData:{type:Boolean,value:!1},radial:{type:Boolean,value:!1},_calcTooltip:{type:Boolean,value:!1},_calcPinnedMarker:{type:Boolean,value:!1},_calcCrosshair:{type:Boolean,value:!1},searchRadius:{type:Number},chartId:{type:String},searchType:{type:String,value:"closestPoint"},searchFor:{type:String,value:"timestamp"},_cursor:{type:Object},_icon:{type:Object},_cursorGroup:{type:Object},_lastIcon:{type:String,value:"none"},_lastCursor:{type:String,value:"none"},iconType:{type:String,value:"none"},cursorType:{type:String,value:"none"},useQuadtree:{type:Boolean,value:!1},_originalBoxCoords:{type:Object,value:function value(){return{x:null,y:null,ox:null,oy:null,width:null,height:null}}},_height:Number,_width:Number,isBar:{type:Boolean,value:!1},isHeatmap:{type:Boolean,value:!1}},observers:["drawElement(domainChanged, chartData.*, svg, width, height, completeSeriesConfig, offset.*)","_drawCursorIcon(_cursorGroup, iconType)","_drawCursor(_icon, cursorType)","_updateRadius(searchRadius)","_setupActions(actionConfig.*)","_resetTooltipDataLegacy(completeSeriesConfig.*)","_resetTooltipData(seriesKeys.*, defaultEmptyData.*)","_createQuadtreeData(wwDataSyncCounter, width, height, margin.*, domainChanged, searchType, useQuadtree, counterClockwise, xAxisType, preventWebWorkerSynchronization)","_callCreateQuadtreeData(mutedSeries)","_updateTooltipData(domainChanged)"],attached:function attached(){if(this._doesObjHaveValues(this.tooltipData)){this.fire("px-vis-tooltip-updated",{dataVar:"tooltipData",data:this.tooltipData,method:"set"})}if(this._doesObjHaveValues(this.mouseRect)){this.fire("px-vis-mouse-rect-updated",{data:this.mouseRect,dataVar:"mouseRect",method:"set"})}},drawElement:function drawElement(){var _Mathmax=Math.max;if(this.hasUndefinedArguments(arguments)){return}if(!this._rect){if(!this.radial){this._width=_Mathmax(this.width-this.margin.left-this.margin.right,0);this._height=_Mathmax(this.height-this.margin.bottom-this.margin.top,0);this._rect=this.svg.append("rect").attr("id","mouseCapture").attr("width",this._width).attr("height",this._height).attr("fill","none").attr("pointer-events","all").style("cursor","crosshair")}else{this._rect=this.svg.append("circle").attr("id","mouseCapture").attr("r",_Mathmax(this.width,0)).attr("cx",0).attr("cy",0).attr("fill","none").attr("pointer-events","all").style("cursor","crosshair")}this._rect.on("mousemove.cursor",this._updateCursor.bind(this));this._rect.on("mouseout.cursor",this._hideCursor.bind(this));this._rect.on("mouseenter",function(){this.dispatchEvent(new CustomEvent("px-vis-tooltip-sizing-request",{bubbles:!0,composed:!0}))}.bind(this));this._drawCursorGroup();if(this.actionConfig){this._setupActions()}this.set("mouseRect",this._rect.node());this.fire("px-vis-mouse-rect-updated",{data:this.mouseRect,dataVar:"mouseRect",method:"set"})}else{if(!this.radial){this._width=_Mathmax(this.width-this.margin.left-this.margin.right,0);this._height=_Mathmax(this.height-this.margin.bottom-this.margin.top,0);this._rect.attr("width",this._width).attr("height",this._height)}else{this._rect.attr("r",_Mathmax(this.width,0))}}},_startStriping:function _startStriping(){this.set("extentsAction","stripe");this._drawActionBox()},_startZooming:function _startZooming(){this.set("extentsAction","zoom");this._drawActionBox()},_drawCursorGroup:function _drawCursorGroup(){if(!this._cursorGroup){this._cursorGroup=this.svg.append("g").attr("display","none").attr("pointer-events","none")}},_drawCursor:function _drawCursor(){if(this.hasUndefinedArguments(arguments)){return}if(this._doesD3HaveValues(this._cursor)){this._cursor.remove()}if("circle"===this.cursorType){this._cursorGroup.insert("circle",":first-child").attr("class","mouseCursor").attr("fill",this._checkThemeVariable("--px-vis-zoom-brush-fill-color","rgb(0,0,0)")).attr("fill-opacity",this._checkThemeVariable("--px-vis-zoom-brush-fill-opacity",.15)).attr("stroke",this._checkThemeVariable("--px-vis-zoom-brush-outline-color","rgb(0,0,0)")).attr("r",this.searchRadius).attr("cx",0).attr("cy",0).attr("pointer-events","none")}if("crosshair"===this.cursorType){this._cursorGroup.insert("line",":first-child").attr("class","mouseCursor").attr("stroke",this._checkThemeVariable("--px-vis-cursor-line-color","rgb(0,0,0)")).attr("stroke-width",2).attr("opacity",1).attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0).attr("pointer-events","none");this._cursorGroup.insert("line",":first-child").attr("class","mouseCursor").attr("stroke",this._checkThemeVariable("--px-vis-cursor-line-color","rgb(0,0,0)")).attr("stroke-width",2).attr("opacity",1).attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0).attr("pointer-events","none")}this._cursor=this._cursorGroup.selectAll(".mouseCursor");this._addClipPath(this._cursor)},_updateRadius:function _updateRadius(){if(this.hasUndefinedArguments(arguments)){return}if("circle"!==this.cursorType){this.cursorType="circle";this._drawCursor()}this._cursor.attr("r",this.searchRadius)},_addClipPath:function _addClipPath(elem){if(this.clipPath){this.addClipPath(elem)}},_updateCursor:function _updateCursor(){if(this._isD3Empty(this._cursorGroup)||this._isD3Empty(this._icon)){return}var mousePos=Px.d3.mouse(this._rect.node());this._cursorGroup.attr("display",null);this._positionCursorIcon(mousePos);if("circle"===this.cursorType){this._cursor.attr("cx",mousePos[0]).attr("cy",mousePos[1])}},_hideCursor:function _hideCursor(){this._cursorGroup.attr("display","none")},_setupActions:function _setupActions(){if(this.hasUndefinedArguments(arguments)){return}if(this._rect){this._setupRegularActions(this._rect,this._rect.node(),!1)}},_resetTooltipDataLegacy:function _resetTooltipDataLegacy(){if(this.hasUndefinedArguments(arguments)){return}if(!this.seriesKeys){this._resetTooltipData()}},_resetTooltipAndCrosshairData:function _resetTooltipAndCrosshairData(){this._resetTooltipData();this._resetCrosshairData()},_resetCrosshairData:function _resetCrosshairData(){this.set("_calculatingData",!1);var ttD={rawData:[],timeStamps:[]};this.set("crosshairData",ttD);this.set("_lassoCrosshairData",ttD);this.generatingCrosshairData=!1},_calcTooltipAndCrosshairData:function _calcTooltipAndCrosshairData(){this._calcTooltip=!0;this._calcCrosshair=!0;this._calcPinnedMarker=!1;this._calcData()},_calcTooltipData:function _calcTooltipData(){this._calcTooltip=!0;this._calcCrosshair=!1;this._calcPinnedMarker=!1;this._calcData()},_calcCrosshairData:function _calcCrosshairData(){this._calcTooltip=!1;this._calcCrosshair=!0;this._calcPinnedMarker=!1;this._calcData()},_calcPinnedMarkedData:function _calcPinnedMarkedData(){var mousePos=Px.d3.mouse(this._rect.node());this.set("_calculatingData",!0);this.set("_calcPinnedMarker",!0);this._calcData()},_calcData:function _calcData(){if("lasso"===this.searchType&&!this._isLassoing){return}this.set("_calculatingData",!0);if(!this.mouseDown&&0<this.chartData.length&&this.y){var mousePos=Px.d3.mouse(this._rect.node());this.debounce("move",function(){this._getDataForAllSeries(mousePos)},10)}},_calcDataFinished:function _calcDataFinished(dataObj){if(this._calculatingData){if(this._calcCrosshair){this.generatingCrosshairData=!0;if("lasso"===this.searchType&&this.crosshairData){var newData;if(this._lassoCrosshairData){newData={rawData:this._lassoCrosshairData.rawData||[],timeStamps:this._lassoCrosshairData.timeStamps||[]}}else{newData={rawData:[],timeStamps:[]}}newData.rawData=newData.rawData.concat(dataObj.rawData);newData.timeStamps=newData.timeStamps.concat(dataObj.timeStamps);this.set("crosshairData",newData)}else{this.set("crosshairData",{rawData:dataObj.rawData,timeStamps:dataObj.timeStamps})}this.fire("px-vis-crosshair-data-generated",{crosshairData:this.crosshairData})}delete dataObj.timeStampsTracker;if(this._calcTooltip){delete dataObj.rawData;delete dataObj.timeStamps;this.set("tooltipData",dataObj);this.fire("px-vis-tooltip-updated",{dataVar:"tooltipData",data:dataObj,method:"set"})}if(this._calcPinnedMarker){delete dataObj.rawData;delete dataObj.timeStamps;this.set("tooltipData",dataObj);this.fire("px-vis-pinnedmarker-updated",{dataVar:"tooltipData",data:dataObj,method:"set"});this.set("_calcPinnedMarker",!1)}this.set("_calculatingData",!1)}},_getDataForAllSeries:function _getDataForAllSeries(mousePos){var x1=this._isOrdinalType(this.xAxisType)?null:this.x.invert(mousePos[0]),dataObj=this._returnTooltipDataStub(mousePos);if(this.preventWebWorkerSynchronization||this._isOrdinalType(this.xAxisType)){this._searchLocally(mousePos,dataObj,x1);return}if(this._isTimeType(this.xAxisType)&&"point"!==this.searchFor&&"xRect"===this.lassoType){console.log(this.lassoType);dataObj.time=x1;this._searchLocally(mousePos,dataObj,x1);return}this._searchOnWebWorker(mousePos,dataObj);return},_searchOnWebWorker:function _searchOnWebWorker(mousePos,dataObj){var ctx={action:"findQuadtreePoints",originatorName:this.nodeName,chartId:this.chartId,data:this._createBaseDataObjForWebWorker()};ctx.data.mousePos=mousePos;ctx.data.calcCrosshair=this._calcCrosshair;ctx.data.radius=this.searchRadius;ctx.data.searchType=this.searchType;ctx.data.searchFor=this.searchFor;ctx.data.polygon=this._lassoCoords;ctx.data.mutedSeries=this.mutedSeries;ctx.data.hardMute=this.hardMute;ctx.successCallback=function(e){if(!e.data){return}dataObj.series=e.data.series;dataObj.seriesObj=e.data.seriesObj;dataObj.rawData=e.data.rawData;dataObj.timeStamps=e.data.timeStamps;dataObj.time=e.data.time?e.data.time:dataObj.time;dataObj.timeSeriesKey=e.data.timeSeriesKey?e.data.timeSeriesKey:dataObj.timeSeriesKey;dataObj.additionalPoints=e.data.additionalPoints;this._calcDataFinished(dataObj)}.bind(this);Px.vis.scheduler.process(ctx)},_returnTooltipDataStub:function _returnTooltipDataStub(mousePos){return this._createTooltipDataStub(mousePos,null,!this.showTooltip)},_searchLocally:function _searchLocally(mousePos,dataObj,x1){if(this._isTimeType(this.xAxisType)||this.isBar||this.isHeatmap){this._findSingleDataset(mousePos,dataObj,x1)}else{this._findDataPerKey(mousePos,dataObj,x1)}this._calcDataFinished(dataObj)},_findSingleDataset:function _findSingleDataset(mousePos,dataObj,x1){if(this.isBar){this._searchBarData(mousePos,dataObj,x1)}else if(this.isHeatmap){this._searchHeatmapData(mousePos,dataObj)}else{this._searchTimeData(mousePos,dataObj,x1)}},_findDataPerKey:function _findDataPerKey(mousePos,dataObj,x1){var keys=this.seriesKeys&&this.seriesKeys.length?this.seriesKeys:Object.keys(this.completeSeriesConfig),closestTimestamp={distance:Number.MAX_VALUE,time:null};searchTimeStamp=null===dataObj.time&&!!this.chartData[0][this.timeData];for(var i=0;i<keys.length;i++){if(!this._calculatingData){break}if(!this.hardMute||!this.mutedSeries[keys[i]]){this._calcSerieData(dataObj,searchTimeStamp,closestTimestamp,x1,keys[i],mousePos)}else{this._createEmptySeriesEntry(dataObj,keys[i])}}if(searchTimeStamp&&closestTimestamp.time){dataObj.time=closestTimestamp.time}},_createEmptySeriesEntry:function _createEmptySeriesEntry(dataObj,k){dataObj.series.push({name:k,value:null,coord:null})},_calcSerieData:function _calcSerieData(dataObj,searchTimeStamp,closestTimestamp,x1,k,mousePos){var yKey=this.completeSeriesConfig[k].y,xKey=this.completeSeriesConfig[k].x,axisKey=this.completeSeriesConfig[k].axis&&this.completeSeriesConfig[k].axis.id?this.completeSeriesConfig[k].axis.id:null,result={series:{}},xCoord,yCoord,y1,isContinuous=!1;if(this._isOrdinalType(this.xAxisType)){result.series[xKey]=this._getOrdinalValue(!0,mousePos[0],axisKey);if(this._isOrdinalType(this.yAxisType)){result.series[yKey]=this._getOrdinalValue(!1,mousePos[1],axisKey)}else{y1=this.isMultiY?this.y[axisKey].invert(mousePos[1]):this.y.invert(mousePos[1]);result.series[yKey]=this._getClosestValue(!1,y1,this.chartData,xKey,yKey,result.series[xKey])}}else if(this._isOrdinalType(this.yAxisType)){result.series[yKey]=this._getOrdinalValue(!1,mousePos[1],axisKey);result.series[xKey]=this._getClosestValue(!0,x1,this.chartData,xKey,yKey,result.series[yKey])}else{result=this._searchContinuousData(searchTimeStamp,closestTimestamp,mousePos,xKey,yKey,axisKey,dataObj);isContinuous=!0}if(!isContinuous){result.coords=this._getCoordsForValues(result.series[xKey],result.series[yKey],axisKey);dataObj.xArr.push(result.coords[0]);dataObj.yArr.push(result.coords[1])}dataObj.series.push({name:k,value:result.series,coord:result.coords});dataObj.seriesObj[k]={value:result.series,coord:result.coords};dataObj.rawData=result.rawData;dataObj.timeStamps=result.timeStamps},_searchTimeData:function _searchTimeData(mousePos,dataObj,x1){var keys=this.seriesKeys&&this.seriesKeys.length?this.seriesKeys:Object.keys(this.completeSeriesConfig),bisectDate=Px.d3.bisector(function(d){return d[this.timeData]}.bind(this)).left,index,yKey,d0,d1,r,result={series:{},rawData:dataObj.rawData,timeStamps:dataObj.timeStamps,timeStampsTracker:dataObj.timeStampsTracker};if("lasso"===this.searchType){var ext=d3.extent(this._lassoCoords,function(d){return d[0]}),resultArr=[],searching=!0,timestamp;ext[0]=+this.x.invert(ext[0]);ext[1]=+this.x.invert(ext[1]);index=bisectDate(this.chartData,ext[0],1);do{timestamp=this.chartData[index][this.timeData];if(timestamp<ext[1]){resultArr.push(this.chartData[index]);if(!result.timeStampsTracker[timestamp]){result.rawData.push(this.chartData[index]);result.timeStamps.push(timestamp);result.timeStampsTracker[timestamp]=!0}index++}else{searching=!1}}while(searching)}else{index=bisectDate(this.chartData,x1,1),d0=this.chartData[index-1],d1=this.chartData[index]?this.chartData[index]:this.chartData[index-1],r=x1-d0[this.timeData]>d1[this.timeData]-x1?d1:d0;result.series=r;if(!result.timeStampsTracker[r[this.timeData]]){result.rawData.push(r);result.timeStamps.push(r[this.timeData]);result.timeStampsTracker[r[this.timeData]]=!0}}for(var coord,axisKey,i=0;i<keys.length;i++){yKey=this.completeSeriesConfig[keys[i]].y;axisKey=this.completeSeriesConfig[keys[i]].axis&&this.completeSeriesConfig[keys[i]].axis.id?this.completeSeriesConfig[keys[i]].axis.id:null;coord=[this.x(result.series[this.timeData]),this.isMultiY?this.y[axisKey](result.series[yKey]):this.y(result.series[yKey])];dataObj.series.push({name:keys[i],value:result.series,coord:coord});dataObj.seriesObj[keys[i]]={value:result.series,coord:coord}}dataObj.rawData=result.rawData;dataObj.timeStamps=result.timeStamps;dataObj.time=result.series[this.timeData]},_searchContinuousData:function _searchContinuousData(searchTimeStamp,closestTimestamp,mousePos,xKey,yKey,axisKey,dataObj){for(var xDomain=this.x.domain(),yDomain=this.isMultiY?this.y[axisKey].domain():this.y.domain(),yDomainTot=yDomain[1]-yDomain[0],yRange=this.isMultiY?this.y[axisKey].range()[1]-this.y[axisKey].range()[0]:this.y.range()[1]-this.y.range()[0],dataX,dataY,pixelX,pixelY,pixelXCopy,pixelYCopy,closestPointIndex,d,crosshairResultIndices=[],minDist=this.searchRadius?this.searchRadius:Number.MAX_VALUE,result={series:{},rawData:dataObj.rawData,timeStamps:dataObj.timeStamps,timeStampsTracker:dataObj.timeStampsTracker},i=0;i<this.chartData.length;i++){dataX=this.chartData[i][xKey];dataY=this.chartData[i][yKey];if(dataX>=xDomain[0]&&dataX<=xDomain[1]&&dataY>=yDomain[0]&&dataY<=yDomain[1]){if(this.radial){var tmp=this._getPixelCoordForRadialData(dataX,dataY,yRange,yDomain,yDomainTot);pixelX=tmp[0];pixelY=tmp[1]}else{pixelX=this.x(dataX);pixelY=this.isMultiY?this.y[axisKey](dataY):this.y(dataY)}pixelXCopy=pixelX;pixelYCopy=pixelY;d=Math.sqrt((pixelX-=mousePos[0])*pixelX+(pixelY-=mousePos[1])*pixelY);if(this._calcTooltip||this._calcCrosshair&&0===this.crosshairPixelSearch){if(d<minDist){minDist=d;crosshairResultIndices=[];crosshairResultIndices.push(i);closestPointIndex=i;result.series[xKey]=dataX;result.series[yKey]=dataY;result.coords=[pixelXCopy,pixelYCopy]}else if(d===minDist){crosshairResultIndices.push(i)}}else if(this._calcCrosshair){if(d<minDist){crosshairResultIndices=[];crosshairResultIndices.push(i);closestPointIndex=i}else if(d===this.crosshairPixelSearch){crosshairResultIndices.push(i)}}}}if(this._calcTooltip&&searchTimeStamp&&closestTimestamp.distance>minDist&&(closestPointIndex||0===closestPointIndex)){closestTimestamp.distance=minDist;closestTimestamp.time=this.chartData[closestPointIndex][this.timeData]}if(this._calcCrosshair){for(var i=0,d;i<crosshairResultIndices.length;i++){d=this.chartData[crosshairResultIndices[i]];if(this.timeData&&!result.timeStampsTracker[d[this.timeData]]){result.rawData.push(d);result.timeStamps.push(d[this.timeData]);result.timeStampsTracker[d[this.timeData]]=!0}else if(!this.timeData){result.rawData.push(d)}}}return result},_getOrdinalValue:function _getOrdinalValue(xAxis,mousePos,axisKey){var _NumberMAX_VALUE=Number.MAX_VALUE,domain,range;if(xAxis){domain=this.x.domain();range=this.x.range()}else if(this.isMultiY){domain=this.y[axisKey].domain();range=this.y[axisKey].range()}else{domain=this.y.domain();range=this.y.range()}rangeInterval=(range[1]-range[0])/domain.length;for(var axisPos=0,distance=_NumberMAX_VALUE,minDistance=_NumberMAX_VALUE,result=-1,i=0;i<domain.length;i++){axisPos=(i+.5)*rangeInterval;distance=Math.abs(axisPos-mousePos);if(distance<minDistance){minDistance=distance;result=i}}return domain[result]},_getOrdinalRange:function _getOrdinalRange(xAxis,from,to){for(var allValues=!0===xAxis?this.x.domain():this.y.domain(),fromVal=this._getOrdinalValue(xAxis,from),toVal=this._getOrdinalValue(xAxis,to),fromIndex=allValues.indexOf(fromVal),toIndex=allValues.indexOf(toVal),result=[],i=fromIndex;i<toIndex+1;i++){result.push(allValues[i])}return result},_getClosestValue:function _getClosestValue(xAxis,value,data,xKey,yKey,ordValue){var dataIndex=xAxis?xKey:yKey,ordIndex=xAxis?yKey:xKey,minDiff=Number.MAX_VALUE,curr,currDiff,result;data.forEach(function(point,index){if(point[ordIndex]===ordValue){curr=point[dataIndex];currDiff=Math.abs(value-curr);if(currDiff<minDiff){minDiff=currDiff;result=curr}}});return result},_searchBarData:function _searchBarData(mousePos,dataObj,x1){var keys=this.seriesKeys,ordVal,bandStart,bandEnd,ordScale,linScale,mouseIndex,ordKey,x,y,result={series:{},coord:[]};if(this._isOrdinalType(this.xAxisType)){ordScale="x";linScale="y";mouseIndex=0;ordKey=this.completeSeriesConfig[keys[0]].x}else{ordScale="y";linScale="x";mouseIndex=1;ordKey=this.completeSeriesConfig[keys[0]].y}ordVal=this[ordScale].invert(mousePos[mouseIndex]);bandStart=this[ordScale](ordVal);bandEnd=bandStart+this[ordScale].bandwidth();if(bandStart<=mousePos[mouseIndex]&&mousePos[mouseIndex]<=bandEnd){for(var i=0;i<this.chartData.length;i++){if(this.chartData[i][ordKey]===ordVal){result.series=this.chartData[i];break}}x=this[ordScale](ordVal);for(var i=0;i<keys.length;i++){y=this[linScale](result.series[this.completeSeriesConfig[keys[i]][linScale]]);result.coord="x"===ordScale?[x,y]:[y,x];dataObj.series.push({name:keys[i],value:result.series,coord:result.coord});dataObj.seriesObj[keys[i]]={value:result.series,coord:result.coord};dataObj.ordinalSet=ordVal}}},_searchHeatmapData:function _searchHeatmapData(mousePos,dataObj){for(var x=this.x.invert(mousePos[0]),y=this.y.invert(mousePos[1]),xKey=this.completeSeriesConfig[this.seriesKeys[0]].x,yKey=this.completeSeriesConfig[this.seriesKeys[0]].y,i=0;i<this.chartData.length;i++){if(this.chartData[i][xKey]===x&&this.chartData[i][yKey]===y){dataObj.series.push({name:this.seriesKeys[0],value:this.chartData[i],coord:[this.x(this.chartData[i][xKey]),this.y(this.chartData[i][yKey])]});break}}},_mouseUpOutsideSvg:function _mouseUpOutsideSvg(){this._finishActionBox()},_startPanning:function _startPanning(){if(0===Px.d3.event.button){this.set("extentsAction","pan");this.mouseDown=!0;Px.d3.select(document).on("mouseup.action",this._stopPanning.bind(this));Px.d3.select(document).on("mousemove.action",this._updatePanning.bind(this));var mousePos=Px.d3.mouse(this._rect.node());if(this.radial){this._initializePanningRadial(mousePos)}else{this._initializePanning(mousePos)}this.fire("px-vis-interaction-space-start-panning")}},_initializePanningRadial:function _initializePanningRadial(mousePos){this._panningStartVal[0]=mousePos[0];this._panningStartVal[1]=mousePos[1]},_initializePanning:function _initializePanning(mousePos){if("ordinal"===this.xAxisType||"scaleBand"===this.xAxisType){this._panningStartVal[0]=mousePos[0]}else{this._panningStartVal[0]=this.x.invert(mousePos[0])}if("ordinal"===this.yAxisType||"scaleBand"===this.yAxisType){this._panningStartVal[1]=mousePos[1]}else{this._panningStartVal[1]=this._processYValues(function(axis,index){return axis.invert(mousePos[1])})}},_updatePanning:function _updatePanning(){var newExtents,mousePos=Px.d3.mouse(this._rect.node());if(this.radial){newExtents=this._updatePanningCoordsRadial(mousePos)}else{newExtents=this._updatePanningCoords(mousePos)}this.set("extentsData",newExtents)},_updatePanningCoordsRadial:function _updatePanningCoordsRadial(mousePos){return{x1:this._panningStartVal[0],y1:this._panningStartVal[1],x2:mousePos[0],y2:mousePos[1]}},_updatePanningCoords:function _updatePanningCoords(mousePos){var newExtents={},currentPanningVal,diff,xDomain=this.x.domain(),yDomain;if("ordinal"!==this.xAxisType&&"scaleBand"!==this.xAxisType){currentPanningVal=this.x.invert(mousePos[0]);diff=currentPanningVal-this._panningStartVal[0];newExtents.eX=[xDomain[0]-diff,xDomain[1]-diff]}else{newExtents.eX=xDomain;this._adjustOrdinalAlign(this.x,mousePos[0],this._panningStartVal[0]);this._panningStartVal[0]=mousePos[0]}if("ordinal"!==this.yAxisType&&"scaleBand"!==this.yAxisType){newExtents.eY=this._processYValues(function(axis,index){currentPanningVal=axis.invert(mousePos[1]);diff=index||0===index?currentPanningVal-this._panningStartVal[1][index]:currentPanningVal-this._panningStartVal[1];yDomain=axis.domain();return[yDomain[0]-diff,yDomain[1]-diff]})}else{newExtents.eY=this._processYValues(function(axis,index){if(index||0===index){this._adjustOrdinalAlign(axis,mousePos[1],this._panningStartVal[1][index]);this._panningStartVal[1][index]=mousePos[1]}else{this._adjustOrdinalAlign(axis,mousePos[1],this._panningStartVal[1]);this._panningStartVal[1]=mousePos[1]}return axis.domain()})}return newExtents},_adjustOrdinalAlign:function _adjustOrdinalAlign(axis,mousePos,initialMousePos){var _Mathmin=Math.min,_Mathmax2=Math.max,diff=(mousePos-initialMousePos)/2,step=axis.step(),axisRange=axis.range(),outerSize=axis.step()*axis.padding(),leftSize=outerSize*axis.align(),newAlign;leftSize=_Mathmin(_Mathmax2(0,leftSize+diff),step);newAlign=_Mathmax2(0,_Mathmin(leftSize/outerSize,1));axis.align(newAlign)},_stopPanning:function _stopPanning(){this._updatePanning();Px.d3.select(document).on("mouseup.action",null);Px.d3.select(document).on("mousemove.action",null);this.mouseDown=!1;this.fire("px-vis-interaction-space-stop-panning")},_drawActionBox:function _drawActionBox(){if(0===Px.d3.event.button){this.mouseDown=!0;Px.d3.select(document).on("mouseup.action",this._mouseUpOutsideSvg.bind(this));Px.d3.select(document).on("mousemove.action",this._updateActionBox.bind(this));var mousePos=Px.d3.mouse(this._rect.node()),startX=mousePos[0],startY=mousePos[1];if("xAxis"===this.selectionType){startY=0}else if("yAxis"===this.selectionType){startX=0}this._originalBoxCoords={x:startX,y:startY,ox:startX,oy:startY,width:0,height:0};this._actionArea=this.svg.append("rect").attr("class","action-area").attr("x",startX).attr("y",startY).attr("rx",2).attr("ry",2).attr("width",0).attr("height",0).attr("fill",this._checkThemeVariable("--px-vis-zoom-brush-fill-color","rgb(0,0,0)")).attr("fill-opacity",this._checkThemeVariable("--px-vis-zoom-brush-fill-opacity",.5)).attr("stroke",this._checkThemeVariable("--px-vis-zoom-brush-outline-color","rgb(0,0,0)"))}},_updateActionBox:function _updateActionBox(){if(this._doesObjHaveValues(this._actionArea)){var mousePos=Px.d3.mouse(this._rect.node()),originalX=this._originalBoxCoords.ox,originalY=this._originalBoxCoords.oy,width=this._originalBoxCoords.width,height=this._originalBoxCoords.height,newX=mousePos[0],newY=mousePos[1],newW,newH;if(originalX>newX){newX=originalX;originalX=mousePos[0]}if(originalY>newY){newY=originalY;originalY=mousePos[1]}if("xAxis"===this.selectionType){newY=this._height}else if("yAxis"===this.selectionType){newX=this._width}if(newX>=originalX){newW=newX-originalX;this._actionArea.attr("x",originalX);this._actionArea.attr("width",newW);this._originalBoxCoords.x=originalX;this._originalBoxCoords.width=newW}else{newW=originalX-newY;this._actionArea.attr("x",newX);this._actionArea.attr("width",newW);this._originalBoxCoords.x=newX;this._originalBoxCoords.width=newW}if(newY>=originalY){newH=newY-originalY;this._actionArea.attr("y",originalY);this._actionArea.attr("height",newH);this._originalBoxCoords.y=originalY;this._originalBoxCoords.height=newH}else{newH=originalY-newY;this._actionArea.attr("y",newY);this._actionArea.attr("height",newH);this._originalBoxCoords.y=newY;this._originalBoxCoords.height=newH}Px.d3.event.preventDefault()}},_finishActionBox:function _finishActionBox(){Px.d3.select(document).on("mouseup.action",null);Px.d3.select(document).on("mousemove.action",null);if(this.mouseDown){this.mouseDown=!1;var extents={};if(this._doesD3HaveValues(this._actionArea)){if(0<this._originalBoxCoords.width&&0<this._originalBoxCoords.height){extents.x1=this._originalBoxCoords.x;extents.y1=this._originalBoxCoords.y;extents.w=this._originalBoxCoords.width;extents.h=this._originalBoxCoords.height;extents.x2=extents.x1+extents.w;extents.y2=extents.y1+extents.h;if("ordinal"===this.xAxisType||"scaleBand"===this.xAxisType){extents.eX=this._getOrdinalRange(!0,extents.x1,extents.x2)}else if("time"===this.xAxisType||"timeLocal"===this.xAxisType){extents.eX=[this.x.invert(extents.x1).getTime(),this.x.invert(extents.x2).getTime()]}else{extents.eX=[this.x.invert(extents.x1),this.x.invert(extents.x2)]}if("ordinal"===this.yAxisType||"scaleBand"===this.yAxisType){extents.eY=this._getOrdinalRange(!1,extents.y2,extents.y1)}else{extents.eY=this._processYValues(function(axis,index){return[axis.invert(extents.y2),axis.invert(extents.y1)]})}this.set("extentsData",extents);this.fire("px-vis-extents-data-updated",{data:extents,dataVar:"extentsData",method:"set"})}}if(this._actionArea&&this._actionArea.remove){this._actionArea.remove()}this._originalBoxCoords={x:null,y:null,width:null,height:null}}},_reportMouseCoords:function _reportMouseCoords(){var mousePos=Px.d3.mouse(this._rect.node());this.fire("px-vis-interaction-space-mouse-coords",{mouse:mousePos,type:Px.d3.event.type})},_callCreateQuadtreeData:function _callCreateQuadtreeData(){if(this.hardMute){this._createQuadtreeData()}},_createQuadtreeData:function _createQuadtreeData(){if(this.hasUndefinedArguments(arguments)){return}if(this.domainChanged&&this.useQuadtree&&!this.preventWebWorkerSynchronization&&"ordinal"!==this.xAxisType&&"scaleBand"!==this.xAxisType){this.debounce("buildQuadtree",function(){var w=this.width-this.margin.right-this.margin.left,h=this.height-this.margin.top-this.margin.bottom,ext=[[0,0],[w,h]],data=this._createBaseDataObjForWebWorker(),time=window.performance.now();data.width=w;data.height=h;data.extents=ext;data.searchType=this.searchType;data.hardMute=this.hardMute;data.mutedSeries=this.mutedSeries;Px.vis.scheduler.process({action:"createQuadtree",originatorName:this.nodeName,data:data,chartId:this.chartId})}.bind(this),50)}},_createBaseDataObjForWebWorker:function _createBaseDataObjForWebWorker(){var data={},yAxisKeys=this.isMultiY?Object.keys(this.y):"defaultAxis";data.completeSeriesConfig=this.completeSeriesConfig;data.keys=this.seriesKeys&&this.seriesKeys.length?this.seriesKeys:Object.keys(this.completeSeriesConfig);data.timeData=this.timeData;data.radial=this.radial;data.counterClockwise=this.counterClockwise;data.useDegrees=this.useDegrees;data.isMultiY=this.isMultiY;data.logBase=this.logBase;data.x={};data.x.range=this.x.range();data.x.domain=this.x.domain();data.x.type=this.x._scaleType;data.y={};if(this.isMultiY){for(var i=0;i<yAxisKeys.length;i++){data.y[yAxisKeys[i]]={range:this.y[yAxisKeys[i]].range(),domain:this.y[yAxisKeys[i]].domain(),type:this.y[yAxisKeys[i]]._scaleType}}}else{data.y[yAxisKeys]={range:this.y.range(),domain:this.y.domain(),type:this.y._scaleType}}return data},_updateTooltipData:function _updateTooltipData(){if(this.tooltipData&&this.tooltipData.seriesObj){var updated=!1;this.tooltipData.series.forEach(function(item,i){if(item.value&&item.coord&&this.completeSeriesConfig[item.name]){var axisKey;if(this.isMultiY){axisKey=this.completeSeriesConfig[item.name].axis&&this.completeSeriesConfig[item.name].axis.id?this.completeSeriesConfig[item.name].axis.id:null}this.fire("px-vis-request-pixel-for-data",{callback:function(info){item.coord=info.pixel;this.tooltipData.seriesObj[item.name]=item}.bind(this),data:[item.value[this.completeSeriesConfig[item.name].x],item.value[this.completeSeriesConfig[item.name].y]],series:item.name,margin:{top:0,bottom:0,left:0,right:0},relativeToCenter:!0});updated=!0}}.bind(this));if(updated){for(var newTtData={},keys=Object.keys(this.tooltipData),i=0;i<keys.length;i++){newTtData[keys[i]]=this.tooltipData[keys[i]]}this.set("tooltipData",newTtData)}}},_getCoordsForValues:function _getCoordsForValues(xVal,yVal,axisKey){return[this.x(xVal),this.isMultiY?this.y[axisKey](yVal):this.y(yVal)]}});</script>
</body></html>