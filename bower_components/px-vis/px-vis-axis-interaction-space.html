<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-icon-set/px-icon-set.html">
<link rel="import" href="px-vis-behavior-common.html">
<link rel="import" href="px-vis-behavior-d3.html">
<link rel="import" href="px-vis-behavior-axis-drag.html">
<link rel="import" href="css/px-vis-styles.html">

<!--

### Usage
    <px-vis-axis-interaction-space
        svg="[[svg]]"
        width="[[width]]"
        height="[[height]]"
        margin="[[margin]]"
        x="[[x]]"
        y="[[y]]"
        domain-changed="[[domainChanged]]"
        complete-series-config="[[completeSeriesConfig]]"
        dimension="[[dimension]]"
        dimensions="[[dimensions]]"
        series-key="[[seriesKey]]"
        category-key="[[categoryKey]]"
        chart-data="[[chartData]]"
        muted-series="{{mutedSeries}}"
        radial="[[radial]]"
        center-offset="[[centerOffset]]"
        brush-to-remove="[[brushToRemove]]"
        brush-domains="[[brushDomains]]"
        drag-container-elem="[[dragContainerElem]]"
        cartesian-drag-behavior="[[cartesianDragBehavior]]"
        redraw-series="[[redrawSeries]]"
        dynamic-redraw="[[dynamicRedraw]]"
        action-config="[[actionConfig]]">
    </px-vis-axis-interaction-space>

### Styling
The following custom properties are available for styling:

Custom property | Description
:----------------|:-------------
`--px-vis-axis-brush-outline-color` | The stroke (border) color for the brushed box on an axis
`--px-vis-axis-brush-fill-color`  | The fill (background) color for the brushed box on an axis
`--px-vis-axis-brush-fill-opacity`  | The opacity of the brushed box on an axis

@element px-vis-axis-interaction-space
@blurb Element providing user interaction on an axis.
@homepage index.html
@demo demo.html
-->

</head><body><dom-module id="px-vis-axis-interaction-space">
    <template>
      <style include="px-vis-styles"></style>
    </template>
</dom-module>

<script>Polymer({is:"px-vis-axis-interaction-space",behaviors:[PxVisBehavior.observerCheck,PxVisBehaviorD3.svg,PxVisBehaviorD3.axes,PxVisBehavior.commonMethods,PxVisBehavior.dataset,PxVisBehavior.mutedSeries,PxVisBehavior.combinedMutedSeries,PxVisBehaviorD3.selectedDomain,PxVisBehaviorD3.domainUpdate,PxVisBehaviorD3.radialAxisConfig,PxVisBehavior.radial,PxVisBehaviorD3.dynamicRedraw,PxVisBehaviorDrag.parallelAxisDrag,PxVisBehaviorDrag.cartesianDrag,PxVisBehavior.categories,PxVisBehavior.completeSeriesConfig,PxVisBehavior.applyActionConfig,PxVisBehaviorD3.cursorIcon,PxVisBehaviorD3.axisOrientation,PxVisBehavior.updateStylesOverride,PxVisBehavior.extentsData,PxVisBehavior.brushDomains,PxVisBehavior.timeDomain,PxVisBehavior.gradientColorsFunction],properties:{dimension:{type:String},_brushElem:{type:Object},_brushD3:{type:Object},_previousRange:{type:Array},_brush:{type:Object},brushToRemove:{type:Boolean,value:!1},dragContainerElem:{type:HTMLElement},cartesianDragBehavior:{type:Boolean,value:!1},dragBehavior:{type:Object},specialActionsList:{type:Array,value:function value(){return["callAxisMute","callAxisDrag","startZooming","startLasso"]}},brushActions:{type:Object,value:function value(){return{callAxisMute:"muted",startZooming:"zoom",startLasso:"lasso"}}},actionMapping:{type:Object,readOnly:!0,value:function value(){return{callAxisMute:"_startMute",callAxisDrag:"_enableDrag",calcTooltipData:"_calcTooltipData",calcCrosshairData:"_calcCrosshairData",calcTooltipAndCrosshairData:"_calcTooltipAndCrosshairData",resetTooltipAndCrosshairData:"_resetTooltipAndCrosshairData",resetTooltip:"_resetTooltipData",resetCrosshair:"_resetCrosshairData",startZooming:"_startZoom",startPanning:"_startPanning",stopPanning:"_stopPanning",startLasso:"_startLasso"}}},actionConfig:{type:Object,value:function value(){return{mousedown:null,mouseup:null,mouseout:"resetTooltip",mousemove:"calcTooltipData"}}},smallerSide:{type:Number,value:0},_isDirty:{type:Boolean,value:!1},_panningLastVal:{type:Number},_unselectedBrushHolder:{type:Object},_continuousBrush:{type:Boolean,value:!1}},observers:["drawElement(svg, margin.* , height, domainChanged)","_showBrushes(brushDomains.*, actionConfig.*, domainChanged)","_showUnselectedBrushes(actionConfig.*, domainChanged)","_setupActions(actionConfig.*)","_setDragBehavior(cartesianDragBehavior, dragContainerElem)","_drawCursorIconAndGroup(svg, iconType)","_setBrushStyles(_stylesUpdated)","_computeGradientRange(timeDomain)"],attached:function attached(){if(this._isDirty){this.drawElement();this._isDirty=!1}},detached:function detached(){if(this._doesD3HaveValues(this._brushD3)){this.deleteAndClearBrush();this._brushD3.remove();this._brushD3=null}this._isDirty=!0},_setDragBehavior:function _setDragBehavior(){if(this.hasUndefinedArguments(arguments)){return}if(this.cartesianDragBehavior){this.createCartesianDrag()}else{this.createParallelAxisDrag()}},drawElement:function drawElement(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("_axisBrush",function(){if(this.domainChanged&&this.svg){var range=this._calcRange();if(this._doesD3HaveValues(this._brushD3)){this._resizeBrush(range)}else{this._unselectedBrushHolder=this.svg.append("g").attr("id","unselected-brushes");this._createBrush(range)}this._translateBrush();this._styleBrushSelection()}},10)},_calcRange:function _calcRange(){var range=this.radial?[[-10,this.centerOffset],[10,this.height]]:[[-10,0],[10,Math.max(this.height-this.margin.top-this.margin.bottom,1)]];range[1][0]=range[1][0]>range[0][0]?range[1][0]:range[0][0];range[1][1]=range[1][1]>range[0][1]?range[1][1]:range[0][1];return range},_createBrush:function _createBrush(range){var b=this.svg.append("g").attr("class","interaction");b.call(this._brush=Px.d3.brushY().extent(range).filter(function(){return 1}).on("start.brush",this.brushstart.bind(this)).on("brush.brush",this.brushActive.bind(this)).on("end.brush",this.brushEnd.bind(this)));this._brushD3=b;this._brushElem=b.node();this._setBrushStyles();this._setupActions()},_resizeBrush:function _resizeBrush(range){this._brushD3.call(this._brush.extent(range).on("start.brush",this.brushstart.bind(this)).on("end.brush",this.brushEnd.bind(this)))},_setBrushStyles:function _setBrushStyles(){if(this.hasUndefinedArguments(arguments)){return}if(this._doesD3HaveValues(this._brushD3)){this._brushD3.selectAll("rect.selection").attr("fill",this._checkThemeVariable("--px-vis-axis-brush-fill-color","rgb(0,0,0)")).attr("fill-opacity",this._checkThemeVariable("--px-vis-axis-brush-fill-opacity",.3)).attr("stroke",this._checkThemeVariable("--px-vis-axis-brush-outline-color","rgb(50,50,50)"))}},_translateBrush:function _translateBrush(){var _Mathmax=Math.max,h=0,w=0;switch(this.orientation){case"bottom":h=_Mathmax(this.height-this.margin.bottom-this.margin.top,0);break;case"right":w=_Mathmax(this.width-this.margin.left-this.margin.right,0);break;}this._brushD3.attr("transform","translate("+w+","+h+")")},_styleBrushSelection:function _styleBrushSelection(){if(this.brushToRemove&&"callAxisMute"===this.actionConfig.mousedown){this._brushD3.selectAll("rect.selection").attr("stroke-dasharray","5, 5")}else{this._brushD3.selectAll("rect.selection").attr("stroke-dasharray",null)}},_setupActions:function _setupActions(){if(this.hasUndefinedArguments(arguments)){return}if(this._doesD3HaveValues(this._brushD3)){this._disableAllAction();this._brushD3.selectAll("rect").attr("cursor","crosshair").on("mousemove.cursor",this._updateCursor.bind(this)).on("mouseout.cursor",this._hideCursor.bind(this));this._brushD3.selectAll("rect").on("mouseenter.sizing",function(){this.dispatchEvent(new CustomEvent("px-vis-tooltip-sizing-request",{bubbles:!0,composed:!0}))}.bind(this));var dontDoUpDown=this._setupSpecialActions();this._setupRegularActions(this._brushD3,this._brushElem,dontDoUpDown)}},_setupSpecialActions:function _setupSpecialActions(){var dontDoUpDown=!1,mouseEvent=null,action=null;if(-1!==this.specialActionsList.indexOf(this.actionConfig.mousedown)){dontDoUpDown=!0;mouseEvent="mousedown"}else if(-1!==this.specialActionsList.indexOf(this.actionConfig.mouseup)){dontDoUpDown=!0;mouseEvent="mouseup"}if(dontDoUpDown){action=this.actionConfig[mouseEvent];this[this.actionMapping[action]]()}return dontDoUpDown},_disableActions:function _disableActions(){this._brushD3.on("mousedown",null).on("mouseup",null).on("mousemove",null).on("mouseout",null)},_disableBrush:function _disableBrush(){this._brushD3.call(this._brush.filter(function(){return 0}))},_startMute:function _startMute(){this.extentsAction="mute";this._continuousBrush=!1;this._disableBrush();this._enableBrush()},_startZoom:function _startZoom(){this.extentsAction="zoom";this._continuousBrush=!1;this._disableBrush();this._enableBrush()},_startLasso:function _startLasso(){this.extentsAction="lasso";this._continuousBrush=!0;this._disableBrush();this._enableBrush()},_enableBrush:function _enableBrush(){this._brushD3.call(this._brush.filter(function(){return 1}).on("start.brush",this.brushstart.bind(this)).on("brush.brush",this.brushActive.bind(this)).on("end.brush",this.brushEnd.bind(this)));this._brushD3.select("rect.overlay").attr("cursor","crosshair");this._brushD3.select("rect.selection").attr("cursor","move");this._brushD3.selectAll("rect.handle").attr("cursor","ns-resize")},_disableDrag:function _disableDrag(){if(!this.dragBehavior){console.warn("Drag behavior not configured");return}this._brushD3.call(this.dragBehavior.filter(function(){return 0}))},_enableDrag:function _enableDrag(){if(!this.dragBehavior){console.warn("Drag behavior not configured");return}this._brushD3.call(this.dragBehavior.filter(function(){return 1}));this._brushD3.selectAll("rect").attr("cursor","move")},_disableAllAction:function _disableAllAction(){this._disableBrush();this._disableDrag();this._disableActions()},_startPanning:function _startPanning(){if(0===Px.d3.event.button){this.set("extentsAction","pan");this._resetTooltipData();Px.d3.select(document).on("mouseup.action",this._stopPanning.bind(this));Px.d3.select(document).on("mousemove.action",this._updatePanning.bind(this));this._panningLastVal=Px.d3.mouse(this._brushElem)[1];this.dispatchEvent(new CustomEvent("px-vis-interaction-space-start-panning",{bubbles:!0,composed:!0}))}},_updatePanning:function _updatePanning(){var mousePos=Px.d3.mouse(this._brushElem),delta=this._panningLastVal-mousePos[1],extents={dimension:this.dimension,action:this.extentsAction,extents:[]},range=this._getRange();if(this.radial){extents.extents.push(range[0]+delta);extents.extents.push(range[1]+delta)}else{extents.extents.push(range[1]+delta);extents.extents.push(range[0]+delta)}this._panningLastVal=mousePos[1];this.dispatchEvent(new CustomEvent("px-vis-axis-interaction-space-extents-data",{bubbles:!0,composed:!0,detail:extents}))},_stopPanning:function _stopPanning(){Px.d3.select(document).on("mouseup.action",null);Px.d3.select(document).on("mousemove.action",null);this.dispatchEvent(new CustomEvent("px-vis-interaction-space-stop-panning",{bubbles:!0,composed:!0}))},_getRange:function _getRange(){var range;if("function"===typeof this.y){range=this.y.range()}else{range=this.y[this.dimension].range()}return range},_resetTooltipAndCrosshairData:function _resetTooltipAndCrosshairData(){this._resetTooltipData();this._resetCrosshairData()},_calcTooltipAndCrosshairData:function _calcTooltipAndCrosshairData(){this._calcTooltip=!0;this._calcCrosshair=!0;this._calcHoverData()},_calcTooltipData:function _calcTooltipData(){this._calcTooltip=!0;this._calcCrosshair=!1;this._calcHoverData()},_calcCrosshairData:function _calcCrosshairData(){this._calcTooltip=!1;this._calcCrosshair=!0;this._calcHoverData()},_calcHoverData:function _calcHoverData(){var m=Px.d3.mouse(this._brushElem);this.debounce("axisMouseMove",function(){this._calcSerieData(this.dimension,m)},10)},_resetTooltipData:function _resetTooltipData(){var ttD={axis:null,yVal:null,mouse:null,time:null,dataset:null,series:[],seriesObj:{},color:null,tooltipConfig:null};window.setTimeout(function(){this.set("tooltipData",ttD);this.fire("px-vis-axis-interaction-space-reset-tooltip",ttD)}.bind(this),11)},_resetCrosshairData:function _resetCrosshairData(){var chD={rawData:[],timeStamps:[]};window.setTimeout(function(){this.set("crosshairData",chD);this.generatingCrosshairData=!1;this.fire("px-vis-axis-interaction-space-reset-crosshair",chD)}.bind(this),11)},_calcSerieData:function _calcSerieData(aid,mousePos){for(var _NumberMAX_VALUE=Number.MAX_VALUE,result={distance:_NumberMAX_VALUE,minDistance:_NumberMAX_VALUE,rawData:[],timeStamps:[]},ttD,chD,i=0;i<this.chartData.length;i++){if(!this.combinedMutedSeries[this.chartData[i][this.seriesKey]]){this._searchData(aid,mousePos[1],result,this.chartData[i])}}if(this._calcTooltip){ttD=this._createTooltipData(aid,mousePos,result);if(ttD){this.set("tooltipData",ttD);this.fire("px-vis-axis-interaction-space-tooltip-data",ttD)}}if(this._calcCrosshair){chD=this._createCrosshairData(result);this.generatingCrosshairData=!0;this.set("crosshairData",chD);this.fire("px-vis-axis-interaction-space-crosshair-data",chD)}},_searchData:function _searchData(aid,mouseVal,result,d){if(this.y.domain()[0]>d[aid]||d[aid]>this.y.domain()[1]){return}if(this.timeDomain&&this.timeDomain.x&&(d[this.seriesKey]<this.timeDomain.x[0]||d[this.seriesKey]>this.timeDomain.x[1])){return}result.distance=Math.abs(Math.floor(this.y(d[aid]))-mouseVal);if(result.distance<result.minDistance){result.minDistance=result.distance;result.rawData=[d];result.timeStamps=[d[this.seriesKey]]}else if(result.distance===result.minDistance){result.rawData.push(d);result.timeStamps.push(d[this.seriesKey])}},_createTooltipData:function _createTooltipData(aid,mousePos,result){var tooltipData;if(result.rawData.length){tooltipData=this._createSingleDataset(aid,mousePos,result.rawData[0]);tooltipData.additionalPoints=[];for(var i=1;i<result.rawData.length;i++){tooltipData.additionalPoints.push(this._createSingleDataset(aid,mousePos,result.rawData[i]))}}return tooltipData},_createSingleDataset:function _createSingleDataset(aid,mousePos,d){var data,tooltipConfig={},value={};tooltipConfig[aid]={};var baseColors=this.categoryKey&&d[this.categoryKey]&&this.completeSeriesConfig[d[this.categoryKey]]?this.completeSeriesConfig[d[this.categoryKey]].color:this.completeSeriesConfig[this.seriesKey].color,gradient=this.createGradientFunction(baseColors);tooltipConfig[aid].color=gradient(d[this.seriesKey]);tooltipConfig[aid].name=this.completeSeriesConfig[aid]&&this.completeSeriesConfig[aid].title?this.completeSeriesConfig[aid].title:aid;tooltipConfig[aid].yAxisUnit=this.completeSeriesConfig[aid]&&this.completeSeriesConfig[aid].yAxisUnit?this.completeSeriesConfig[aid].yAxisUnit:"";tooltipConfig[aid].y=aid;value[aid]=d[aid];data={axis:aid,yVal:d[aid],mouse:mousePos,time:d[this.seriesKey],dataset:d,series:[{name:aid,value:value}],seriesObj:{},color:tooltipConfig[aid].color,tooltipConfig:tooltipConfig};data.seriesObj[aid]={name:aid,value:value};return data},_createCrosshairData:function _createCrosshairData(result){var data={rawData:result.rawData,timeStamps:result.timeStamps};return data},brushstart:function brushstart(){if(Px.d3.event.sourceEvent&&"end"!==Px.d3.event.sourceEvent.type){Px.d3.event.sourceEvent.stopPropagation()}this._brushD3.select("rect.selection").attr("width",20)},brushActive:function brushActive(){if(this._continuousBrush){var extents;if(Px.d3.brushSelection(this._brushElem)){extents=Px.d3.brushSelection(this._brushElem)}var data={dimension:this.dimension,extents:extents,action:this.extentsAction};this.dispatchEvent(new CustomEvent("px-vis-axis-interaction-space-extents-data",{bubbles:!0,composed:!0,detail:data}))}},brushEnd:function brushEnd(){var extents=[];if(Px.d3.brushSelection(this._brushElem)){extents=this._checkMinSize(Px.d3.brushSelection(this._brushElem),this._brushD3)}var data={dimension:this.dimension,extents:extents,action:this.extentsAction};this.clearBrush();this._enableBrush();this.dispatchEvent(new CustomEvent("px-vis-axis-interaction-space-extents-data",{bubbles:!0,composed:!0,detail:data}))},_checkMinSize:function _checkMinSize(sel){if(4>sel[1]-sel[0]){var ext=0>sel[0]-4-this.centerOffset?[sel[0],sel[1]+4]:[sel[0]-4,sel[1]];return ext}else{return sel}},_checkBrushSize:function _checkBrushSize(domains){var newAxisDomain=this.y.domain(),oldBrushDomain=[domains[1],domains[0]],newBrushRange=[];if(newAxisDomain[0]<=oldBrushDomain[0]&&newAxisDomain[1]>=oldBrushDomain[1]){newBrushRange=this._getNewBrushRange(oldBrushDomain[0],oldBrushDomain[1]);newBrushRange=this._checkMinSize(newBrushRange)}else if(newAxisDomain[0]>oldBrushDomain[0]&&newAxisDomain[0]<oldBrushDomain[1]&&newAxisDomain[1]>=oldBrushDomain[1]){newBrushRange=this._getNewBrushRange(newAxisDomain[0],oldBrushDomain[1]);newBrushRange=this._checkMinSize(newBrushRange)}else if(newAxisDomain[0]<=oldBrushDomain[0]&&newAxisDomain[1]<oldBrushDomain[1]&&newAxisDomain[1]>oldBrushDomain[0]){newBrushRange=this._getNewBrushRange(oldBrushDomain[0],newAxisDomain[1]);newBrushRange=this._checkMinSize(newBrushRange)}else{return[]}return newBrushRange},_getNewBrushRange:function _getNewBrushRange(d1,d2){var newRange=[this.y(d1),this.y(d2)];return this.radial?newRange:[newRange[1],newRange[0]]},clearBrush:function clearBrush(){this._brushD3.call(this._brush.on("start.brush",null).on("end.brush",null));this._brushD3.call(this._brush.move,null)},deleteAndClearBrush:function deleteAndClearBrush(){this.clearBrush();this.dispatchEvent(new CustomEvent("px-vis-axis-interaction-space-extents-clear",{bubbles:!0,composed:!0,detail:{dimension:this.dimension}}))},_showBrushes:function _showBrushes(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("showbrushes",function(){this._showBrushesDebounced()},10)},_showBrushesDebounced:function _showBrushesDebounced(){if(this._isD3Empty(this._brushD3)||!this.domainChanged){return}this.clearBrush();this._styleBrushSelection();var key=this.brushActions[this.actionConfig.mousedown];if(!key){return}if(!this.brushDomains[key]||this._isObjEmpty(this.brushDomains[key])){this._enableBrush();return}var domains=this.brushDomains[key][this.dimension];if(domains&&0<domains.length){var bd=this._checkBrushSize(domains);this._brushD3.call(this._brush.move,bd)}this._enableBrush()},_showUnselectedBrushes:function _showUnselectedBrushes(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("showUnselectedbrushes",function(){this._showUnselectedBrushesDebounced()},10)},_showUnselectedBrushesDebounced:function _showUnselectedBrushesDebounced(){if(this._isD3Empty(this._brushD3)||!this.domainChanged||this._isObjEmpty(this.brushActions)){return}var currentAction=this.brushActions[this.actionConfig.mousedown],actions=Object.keys(this.brushActions);this._unselectedBrushHolder.html(null);actions.forEach(function(action){var key=this.brushActions[action];if(key===currentAction||!this.brushDomains[key]||!this.brushDomains[key][this.dimension]||0===this.brushDomains[key][this.dimension].length){return}var domains=this.brushDomains[key][this.dimension],range=this._checkBrushSize(domains),g=this._unselectedBrushHolder.append("g").attr("id","unselected-"+key);g.append("rect").attr("x",-10).attr("width",20).attr("y",range[0]).attr("height",range[1]-range[0]).attr("fill",this._checkThemeVariable("--px-vis-axis-brush-fill-color-unselected-"+key,"rgb(0,0,0)")).attr("fill-opacity",this._checkThemeVariable("--px-vis-axis-brush-fill-opacity-unselected-"+key,.1)).attr("stroke",this._checkThemeVariable("--px-vis-axis-brush-outline-color-unselected-"+key,""))}.bind(this))},_drawCursorIconAndGroup:function _drawCursorIconAndGroup(){if(this.hasUndefinedArguments(arguments)){return}if(!this._cursorGroup){this._cursorGroup=this.svg.append("g").attr("display","none").attr("pointer-events","none")}this._drawCursorIcon()},_updateCursor:function _updateCursor(){if(this._isD3Empty(this._cursorGroup)){return}var mousePos=Px.d3.mouse(this._brushD3.node());this._cursorGroup.attr("display",null);this._positionCursorIcon(mousePos)},_hideCursor:function _hideCursor(){if(this._isD3Empty(this._cursorGroup)||this._isD3Empty(this._icon)){return}this._cursorGroup.attr("display","none")}});</script>
</body></html>