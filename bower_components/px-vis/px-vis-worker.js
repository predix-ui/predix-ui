var dataMapping={},quadtrees={};quadtreeBuilt=!1;function reply(data){postMessage({data:data})}function updateData(eventData){dataMapping[eventData.chartId]=eventData.data.chartData;reply(null)}function deleteData(eventData){delete dataMapping[eventData.chartId];delete quadtrees[eventData.chartId];reply(null)}function recreateD3Scale(scaleObj){var result;if("time"===scaleObj.type){result=d3.scaleUtc().nice().range(scaleObj.range).domain(scaleObj.domain)}else if("timeLocal"===scaleObj.type){result=d3.scaleTime().nice().range(scaleObj.range).domain(scaleObj.domain)}else if("linear"===scaleObj.type){result=d3.scaleLinear().nice().range(scaleObj.range).domain(scaleObj.domain)}else if("log"===scaleObj.type){result=d3.scaleLog().nice().base(scaleObj.logBase).range(scaleObj.range).domain(scaleObj.domain)}else if("scaleBand"===scaleObj.type){result=d3.scaleBand().range(scaleObj.range).domain(scaleObj.domain).round(!0).paddingInner(.5)}else{result=d3.scalePoint().range(scaleObj.range).domain(scaleObj.domain).padding(.5)}return result}function getMultiScale(visData){for(var o={},k,axis,i=0;i<visData.keys.length;i++){k=visData.keys[i];axis=visData.isMultiY?visData.completeSeriesConfig[k].axis.id:"defaultAxis";if(!o[axis]){o[axis]=recreateD3Scale(visData.y[axis])}}return o}function createDataStub(){return{time:null,timeSeriesKey:null,series:[],seriesObj:{},rawData:[],timeStamps:[],timeStampsTracker:{},additionalPoints:[]}}function flattenData(visData,d,xScale,yScale,index,arr){for(var _Mathfloor=Math.floor,i=0;i<visData.keys.length;i++){if(visData.hardMute&&visData.mutedSeries[visData.keys[i]]){continue}var o={},k=visData.keys[i],axis=visData.completeSeriesConfig[k].axis?visData.completeSeriesConfig[k].axis.id:"default";o.i=index;o.k=k;if(visData.radial){var pix=calcPixelCoordForRadial(d[visData.completeSeriesConfig[k].x],d[visData.completeSeriesConfig[k].y],axis,visData);o.px=_Mathfloor(pix[0]);o.py=_Mathfloor(pix[1])}else{o.px=_Mathfloor(xScale(d[visData.completeSeriesConfig[k].x],axis));o.py=_Mathfloor(yScale(d[visData.completeSeriesConfig[k].y],axis))}arr.push(o)}return arr}function buildQuadtreeHelperObj(visData,k,index,xScale){var obj={},axis=visData.completeSeriesConfig[k].axis?visData.completeSeriesConfig[k].axis.id:null;obj.xKey=visData.completeSeriesConfig[k].x;obj.yKey=visData.completeSeriesConfig[k].y;if(visData.radial){var calcPx=function calcPx(d){return calcPixelCoordForRadial(d[obj.xKey],d[obj.yKey],axis,visData)};obj.xScale=function(d){return calcPx(d)[0]};obj.yScale=function(d){return calcPx(d)[1]};obj.yScale.index=index}else{obj.yScale=recreateD3Scale(visData.y[axis]);obj.yScale.index=index;obj.xScale=recreateD3Scale(visData.x)}return obj}function adjustAngleForPolarChart(angle,toDegrees,visData){var _MathPI=Math.PI,offset=toDegrees?180:_MathPI;if(!visData.counterClockwise&&!toDegrees||visData.counterClockwise&&toDegrees){angle*=-1}if(visData.useDegrees){if(toDegrees){return angle+offset}else{return 2*(angle/360)*_MathPI+offset}}else{if(toDegrees){return 360*(angle/(2*_MathPI))+offset}else{return angle+offset}}}function calcPixelCoordForRadial(angle,amp,axis,visData){var yRange=visData.y[axis].range[1]-visData.y[axis].range[0],yDomainTot=visData.y[axis].domain[1]-visData.y[axis].domain[0],pixelAmplitude=yRange*(amp-visData.y[axis].domain[0])/yDomainTot;angle=adjustAngleForPolarChart(angle,!1,visData);return[Math.sin(angle)*pixelAmplitude,Math.cos(angle)*pixelAmplitude]}function calcXScale(visData){if(!visData.radial){var x=recreateD3Scale(visData.x);return function(d){return x(d)}}}function calcYScale(visData){if(!visData.radial){var y=getMultiScale(visData);return function(d,axis){return y[axis](d)}}}function createSingleQuadtree(data){var visData=data.data,chartData=dataMapping[data.chartId],flatData,xScale=calcXScale(visData),yScale=calcYScale(visData),quadtree;if(chartData){quadtree=d3.quadtree().extent(visData.extents).x(function(d){return d.px}).y(function(d){return d.py});for(var allFlat=[],i=0;i<chartData.length;i++){flattenData(visData,chartData[i],xScale,yScale,i,allFlat)}quadtree.addAll(allFlat);return quadtree}else{return null}}function createSeriesQuadtree(data){var visData=data.data,chartData=dataMapping[data.chartId],k,quadtree={},xScale=function xScale(d){return visData.radial?this.xScale(d):this.xScale(d[this.xKey])},yScale=function yScale(d){return visData.radial?this.yScale(d):this.yScale(d[this.yKey])};if(chartData){for(var i=0;i<visData.keys.length;i++){k=visData.keys[i];if(visData.hardMute&&visData.mutedSeries[k]){continue}var obj=buildQuadtreeHelperObj(visData,k,i);quadtree[k]=d3.quadtree().extent(visData.extents).x(xScale.bind(obj)).y(yScale.bind(obj)).addAll(chartData)}return quadtree}else{return null}}function createQuadtree(data){quadtreeBuilt=!1;quadtrees[data.chartId]="pointPerSeries"===data.data.searchType?createSeriesQuadtree(data):createSingleQuadtree(data);quadtreeBuilt=!0;reply(null,null)}function _getPixelSpaceVal(d,chartScale,key,axis){return axis?chartScale[axis](d[key]):chartScale(d[key])}function calcValueQuadtree(d,x,y){var o={};o[x]=d[x];o[y]=d[y];return o}function calcCoordQuadtree(d,x,y,xScale,yScale,visData,axis){var a=[];if(visData.radial){a=calcPixelCoordForRadial(d[x],d[y],axis,visData)}else{a[0]=xScale(d[x]);a[1]=yScale(d[y])}return a}function calcDataSeriesQuadtree(d,k,xScale,yScale,visData,axis){var x=visData.completeSeriesConfig[k].x,y=visData.completeSeriesConfig[k].y;return{coord:calcCoordQuadtree(d,x,y,xScale,yScale,visData,axis),name:k,value:calcValueQuadtree(d,x,y)}}function calcClosestPoint(mousePos,foundPoint,series,time){var pixelX=series.coord[0],pixelY=series.coord[1],currDist=(pixelX-=mousePos[0])*pixelX+(pixelY-=mousePos[1])*pixelY;if(!foundPoint||foundPoint.dist>currDist){return{dist:currDist,time:time,key:series.name}}return foundPoint}function calcDataSingleQuadtree(rawData,k,visData){var x=visData.completeSeriesConfig[k].x,y=visData.completeSeriesConfig[k].y,axis=visData.completeSeriesConfig[k].axis?visData.completeSeriesConfig[k].axis.id:"default",value=calcValueQuadtree(rawData,x,y);return{coord:visData.radial?calcPixelCoordForRadial(value[x],value[y],axis,visData):[visData.xScale(value[x]),visData.yScale[axis](value[y])],name:k,value:value}}function addCrosshairDataQuadtree(dataObj,d,timeData){if(timeData&&!dataObj.timeStampsTracker[d[timeData]]){dataObj.rawData.push(d);dataObj.timeStamps.push(d[timeData]);dataObj.timeStampsTracker[d[timeData]]=!0}else if(!timeData){dataObj.rawData.push(d)}return dataObj}function constructDataObj(result,dataObj,k,visData,isSingle,xScale){if(!result||visData.hardMute&&visData.mutedSeries[k]||"point"===visData.searchFor&&result.k!==k&&"pointPerSeries"!==visData.searchType){dataObj.series.push(emptySeries(k))}else if(isSingle){var rawData=this.dataMapping[visData.chartId][result.i];dataObj.seriesObj[k]=calcDataSingleQuadtree(rawData,k,visData);dataObj.series.push(dataObj.seriesObj[k]);if(visData.calcCrosshair&&"allInArea"!==visData.searchType){dataObj=addCrosshairDataQuadtree(dataObj,rawData,visData.timeData)}}else{var axis=visData.completeSeriesConfig[k].axis.id,yScale=recreateD3Scale(visData.y[axis]),series=calcDataSeriesQuadtree(result,k,xScale,yScale,visData,axis);dataObj.seriesObj[k]=series;dataObj.series.push(series);if(visData.timeData){dataObj.closest=calcClosestPoint(visData.mousePos,dataObj.closest,series,result[visData.timeData])}if(visData.calcCrosshair){dataObj=addCrosshairDataQuadtree(dataObj,result,visData.timeData)}}return dataObj}function calcBoxSize(visData){var x0=visData.mousePos[0]-visData.radius,x1=visData.mousePos[0]+visData.radius,y0=visData.mousePos[1]-visData.radius,y1=visData.mousePos[1]+visData.radius;return{x0:x0,x1:x1,y0:y0,y1:y1}}function calcPolygonExtents(polygon){var xExt=d3.extent(polygon,function(d){return d[0]}),yExt=d3.extent(polygon,function(d){return d[1]});return{x0:xExt[0],x1:xExt[1],y0:yExt[0],y1:yExt[1]}}function searchPolygonQuadtree(visData,dataObj,quadtree){var boxSize=calcPolygonExtents(visData.polygon),scanned=0,selected=0;if(visData.polygon.length){quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;scanned++;if(d3.polygonContains(visData.polygon,[d.px,d.py])){dataObj=addCrosshairDataQuadtree(dataObj,this.dataMapping[visData.chartId][node.data.i],visData.timeData);selected++}}while(node=node.next);return!0}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0})}return dataObj}function searchAreaBoxQuadtree(quadtree,visData,dataObj){var boxSize=calcBoxSize(visData);quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;if(d.px>=boxSize.x0&&d.px<boxSize.x1&&d.py>=boxSize.y0&&d.py<boxSize.y1){dataObj=addCrosshairDataQuadtree(dataObj,d.data,visData.timeData)}}while(node=node.next)}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0});return dataObj}function searchAreaRadiusQuadtree(quadtree,visData,dataObj){var r2=visData.radius*visData.radius,boxSize=calcBoxSize(visData);quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){var _Mathpow=Math.pow;if(!node.length){do{if(!visData.hardMute||!visData.mutedSeries[node.data.k]){if(_Mathpow(node.data.px-visData.mousePos[0],2)+_Mathpow(node.data.py-visData.mousePos[1],2)<=r2){dataObj=addCrosshairDataQuadtree(dataObj,this.dataMapping[visData.chartId][node.data.i],visData.timeData)}}}while(node=node.next)}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0});return dataObj}function searchAreaQuadtree(quadtree,visData,dataObj){return visData.radius?searchAreaRadiusQuadtree(quadtree,visData,dataObj):searchAreaBoxQuadtree(quadtree,visData,dataObj)}function buildQtSingleDataObj(visData,dataObj,result){for(var i=0;i<visData.keys.length;i++){dataObj=constructDataObj(result,dataObj,visData.keys[i],visData,!0,null)}if(result){dataObj.time=dataMapping[visData.chartId][result.i][visData.timeData];dataObj.timeSeriesKey="point"===visData.searchFor?result.k:""}return dataObj}function findAllAtPoint(quadtreeData,point,visData){var allResults=[];quadtreeData.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;if(d.px===point.px&&d.py===point.py){allResults.push(d)}}while(node=node.next)}return nodeX0>point.px||nodeY0>point.py||nodeX1<point.px||nodeY1<point.py});return allResults}function buildAdditionalPoints(visData,allResults,result){var points=[],additionObj,timeStamps={};timeStamps[result.i]=!0;for(var i=0;i<allResults.length;i++){if(allResults[i].i===result.i&&allResults[i].k===result.k){continue}if("point"!==visData.searchFor&&timeStamps[allResults[i].i]){continue}additionObj=createDataStub();additionObj=buildQtSingleDataObj(visData,additionObj,allResults[i]);timeStamps[allResults[i].i]=!0;points.push(additionObj)}return points}function returnAllAtPoint(quadtreeData,visData,result,dataObj){var allResults=findAllAtPoint(quadtreeData,result,visData);if(1<allResults.length){dataObj.additionalPoints=buildAdditionalPoints(visData,allResults,result)}return dataObj}function searchQuadtreeSingle(visData,dataObj,quadtreeData){var r=visData.radius?visData.radius:1/0,result=quadtreeData.find(visData.mousePos[0],visData.mousePos[1],r);dataObj=buildQtSingleDataObj(visData,dataObj,result);if(result){dataObj=returnAllAtPoint(quadtreeData,visData,result,dataObj)}if(visData.calcCrosshair){if("allInArea"===visData.searchType){dataObj=searchAreaRadiusQuadtree(quadtreeData,visData,dataObj)}}return dataObj}function searchQuadtreeSeries(visData,dataObj,quadtreeData){for(var r=visData.radius?visData.radius:1/0,xScale=!visData.radial?recreateD3Scale(visData.x):null,result,k,i=0;i<visData.keys.length;i++){k=visData.keys[i];if(quadtreeData[k]){if(!visData.hardMute||!visData.mutedSeries[k]){result=quadtreeData[k].find(visData.mousePos[0],visData.mousePos[1],r);dataObj=constructDataObj(result,dataObj,k,visData,!1,xScale)}}}if(dataObj.closest){dataObj.time=dataObj.closest.time;dataObj.timeSeriesKey=dataObj.closest.key;delete dataObj.closest}return dataObj}function returnClosestsQuadtreePoints(eventData,time){var visData=eventData.data,dataObj=createDataStub(),quadtreeData=quadtrees[eventData.chartId];if(quadtreeData){visData.chartId=eventData.chartId;visData.xScale=recreateD3Scale(visData.x);visData.yScale=getMultiScale(visData);if("pointPerSeries"===visData.searchType){dataObj=searchQuadtreeSeries(visData,dataObj,quadtreeData)}else if("lasso"===visData.searchType){dataObj=searchPolygonQuadtree(visData,dataObj,quadtreeData)}else{dataObj=searchQuadtreeSingle(visData,dataObj,quadtreeData)}}delete dataObj.timeStampsTracker;reply(dataObj)}function returnQuadtreePointsInArea(eventData){var visData=eventData.data,quadtreeData=quadtrees[eventData.chartId],dataObj=createDataStub();if(quadtreeData){visData.chartId=eventData.chartId;visData.xScale=recreateD3Scale(visData.x);visData.yScale=getMultiScale(visData);dataObj=searchAreaBoxQuadtree(quadtreeData,visData,dataObj)}reply(dataObj)}function emptySeries(k){return{coord:[],name:k,value:{}}}function addCrosshairData(dataObj,d){if(this.timeData&&!dataObj.timeStampsTracker[d[this.timeData]]){dataObj.rawData.push(d);dataObj.timeStamps.push(d[this.timeData]);dataObj.timeStampsTracker[d[this.timeData]]=!0}else if(!this.timeData){dataObj.rawData.push(d)}return dataObj}function determineExtents(eventData){var visData=eventData.data,extents=null;extentCalc.xAxisType=visData.xAxisType;extentCalc.yAxisType=visData.yAxisType;extentCalc.completeSeriesConfig=visData.completeSeriesConfig;extentCalc.chartExtents=visData.chartExtents;extentCalc.dataExtents=visData.dataExtents;extentCalc.axes=visData.axes;extentCalc.seriesToAxes=visData.seriesToAxes;extentCalc.isYAxisObject=visData.isYAxisObject;extentCalc.mutedSeries=visData.mutedSeries;extentCalc.hardMute=visData.hardMute;if(dataMapping[eventData.chartId]){extents=extentCalc.determineExtents(dataMapping[eventData.chartId])}reply(extents)}onmessage=function onmessage(e){switch(e.data.action){case"registerCustomScript":if(e.data.data.url){importScripts(e.data.data.url)}reply(null);break;case"runCustomFunction":var obj=this[e.data.data.objectName],func,result;if(obj){func=obj[e.data.data.functionName];if(func){result=func(e.data.data.data,e.data.chartId)}else{throw"Couldn't run custom function "+e.data.data.functionName+" on custom Object "+e.data.data.objectName+" because the specified function doesn't exist on the specified Object."}}else{throw"Couldn't run custom function "+e.data.data.functionName+" on custom Object "+e.data.data.objectName+" because the specified Object doesn't exist. Make sure you have loaded your custom script defining the custom object."}reply(result);break;case"updateData":updateData(e.data);break;case"createQuadtree":createQuadtree(e.data);break;case"findQuadtreePoints":if(quadtreeBuilt){returnClosestsQuadtreePoints(e.data)}else{reply(null)}break;case"findQuadtreePointsInArea":if(quadtreeBuilt){returnQuadtreePointsInArea(e.data)}else{reply(null)}break;case"returnQuadtreeData":if(quadtreeBuilt){reply(quadtrees[e.data.chartId])}else{reply(null)}break;case"determineExtents":determineExtents(e.data);break;case"unregisterChart":deleteData(e.data);break;default:reply(null);}};