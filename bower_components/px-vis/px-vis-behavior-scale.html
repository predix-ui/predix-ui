<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">

<link rel="import" href="px-vis-behavior-common.html">
<link rel="import" href="px-vis-behavior-d3.html">

<script>var PxVisBehaviorScale=window.PxVisBehaviorScale=window.PxVisBehaviorScale||{};PxVisBehaviorScale.scale=[{properties:{_extents:{type:Array,value:function value(){return[[],[]]}},_chartDataHasChanged:{type:Number,value:0},_calculatingDomain:{type:Boolean,value:!1},_defaultScaleValue:{type:Object,value:function value(){return{x:[1/0,-Infinity],y:[1/0,-Infinity]}}},disableDynamicUpdate:{type:Boolean,value:!1},_runOnce:{type:Boolean,value:!1},chartId:{type:String},scalePadding:{type:Number,value:.5},paddingOuter:{type:Number,value:.1},logBase:{type:String,value:10}},listeners:{"px-vis-request-pixel-for-data":"_pixelRequest"},_recreateScales:function _recreateScales(width,height,margin){this._calculatingDomain=!0;if(this.x){this._internalSetXScale(width,margin,!0)}if(this.y){if(this.isMultiY){this._internalSetMultiYScale(height,margin,this.axes,!0)}else{this._internalSetYScale(height,margin,!0)}}this._calculatingDomain=!1},_setXScale:function _setXScale(width,margin){if(this.hasUndefinedArguments(arguments)){return}this._internalSetXScale(width,margin,!1)},_internalSetXScale:function _internalSetXScale(width,margin,forceRecreation){var w=Math.max(width-margin.left-margin.right,0);if(this.x&&this.x._scaleType===this.xAxisType&&!forceRecreation){this.x.range([0,w]);if(this.domainChanged){if(this._isOrdinalType(this.xAxisType)){this._createOrdinalInvert(this.x,!1)}this.set("domainChanged",this.domainChanged+1)}}else{this.set("x",this._setScale(this.xAxisType,[0,w],this.x))}},_setYScale:function _setYScale(height,margin){if(this.hasUndefinedArguments(arguments)){return}this._internalSetYScale(height,margin,!1)},_internalSetYScale:function _internalSetYScale(height,margin,forceRecreation){var h=Math.max(height-margin.top-margin.bottom,0);if(this.y&&this.y._scaleType===this.yAxisType&&!forceRecreation){this.y.range([h,0]);if(this.domainChanged){if(this._isOrdinalType(this.yAxisType)){this._createOrdinalInvert(this.y,!0)}this.set("domainChanged",this.domainChanged+1)}}else{this.set("y",this._setScale(this.yAxisType,[h,0],this.y))}},_setMultiYScale:function _setMultiYScale(height,margin,axes){if(this.hasUndefinedArguments(arguments)){return}this._internalSetMultiYScale(height,margin,axes,!1)},_internalSetMultiYScale:function _internalSetMultiYScale(height,margin,axes,forceRecreation){var h=Math.max(height-margin.top-margin.bottom,0),newY,copy,updated=!1,created=!1;if(!this.y){copy={}}else{copy=this.y}for(var i=0;i<this.axes.length;i++){if(copy[this.axes[i]]&&copy[this.axes[i]]._scaleType===this.yAxisType&&!forceRecreation){copy[this.axes[i]].range([h,0]);updated=!0}else{newY=this._setScale(this.yAxisType,[h,0],copy,!0,this.axes[i]);copy[this.axes[i]]=newY;created=!0}}if(created){this.set("y",copy)}if(updated){if(this.domainChanged){this.set("domainChanged",this.domainChanged+1)}}},_setScale:function _setScale(type,range,currentAxis,isMultiAxis,key){var isMultiAxis=isMultiAxis||!1,result;if("time"===type){result=Px.d3.scaleUtc().nice().range(range);result._scaleType="time"}else if("timeLocal"===type){result=Px.d3.scaleTime().nice().range(range);result._scaleType="timeLocal"}else if("linear"===type){result=Px.d3.scaleLinear().nice().range(range);result._scaleType="linear"}else if("log"===type){result=Px.d3.scaleLog().nice().base(this.logBase).range(range);result._scaleType="log"}else if("scaleBand"===type){result=Px.d3.scaleBand().range(range).round(!0).paddingInner(this.scalePadding).paddingOuter(this.paddingOuter);result._scaleType="scaleBand"}else{result=Px.d3.scalePoint().range(range).padding(this.scalePadding);result._scaleType="ordinal"}if(currentAxis&&isMultiAxis&&currentAxis[key]){result.domain(currentAxis[key].domain())}else if(currentAxis&&!isMultiAxis){result.domain(currentAxis.domain())}return result},_setDomain:function _setDomain(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("_setDomain",function(){if(this._calculatingDomain||this._isObjEmpty(this.chartData)||!this.x||!this.y||this._isObjEmpty(this.completeSeriesConfig)){return}this._calculatingDomain=!0;if(!this.chartId||this.preventWebWorkerSynchronization){var extents=this._determineExtents();this._applyExtents(extents);if(this._isOrdinalType(this.xAxisType)){this._createOrdinalInvert(this.x,!1)}if(this._isOrdinalType(this.yAxisType)){this._createOrdinalInvert(this.y,!0)}return}var wwInfo={xAxisType:this.xAxisType,yAxisType:this.yAxisType,completeSeriesConfig:this.completeSeriesConfig,chartExtents:this.chartExtents,dataExtents:this.dataExtents,axes:this.axes,seriesToAxes:this.seriesToAxes,isYAxisObject:"object"===babelHelpers.typeof(this.y),hardMute:this.hardMute,mutedSeries:this.mutedSeries};Px.vis.scheduler.process({action:"determineExtents",originatorName:this.nodeName,chartId:this.chartId,data:wwInfo,successCallback:function(e){if(e.data){this._applyExtents(e.data)}}.bind(this)})}.bind(this),10)},_createOrdinalInvert:function _createOrdinalInvert(scale,invert){scale.invert=function(){var dom=scale.domain(),r=scale.range(),domain=invert?dom.reverse():dom,range=invert?[r[1],r[0]]:r,sq=Px.d3.scaleQuantize().domain(range).range(domain);return function(d){return sq(d)}}()},_applyExtents:function _applyExtents(extents){if("object"===babelHelpers.typeof(this.y)){for(var i=0;i<this.axes.length;i++){if(!this.y[this.axes[i]]){continue}if("log"===this.yAxisType){extents.y[this.axes[i]]=this._fixLogExt(extents.y[this.axes[i]])}if(this.matchTicks&&!this.singleDomain){var min=10*Math.floor(extents.y[this.axes[i]][0]/10),max=10*Math.ceil(extents.y[this.axes[i]][1]/10);this.y[this.axes[i]].domain([min,max])}else{this.y[this.axes[i]].domain(extents.y[this.axes[i]])}}}else{if("log"===this.yAxisType){extents.y=this._fixLogExt(extents.y)}this.y.domain(extents.y)}this.fire("px-vis-extents-applied",extents);if("log"===this.xAxisType){extents.x=this._fixLogExt(extents.x)}if(this.disableDynamicUpdate){if(!this.runOnce){this.x.domain(extents.x);this.set("domainChanged",this.domainChanged+1);this.runOnce=!0}}else{this.x.domain(extents.x);this.set("domainChanged",this.domainChanged+1)}this._calculatingDomain=!1},_determineExtents:function _determineExtents(){var _Mathmin=Math.min,_Mathmax=Math.max,xOrd=this._isOrdinalType(this.xAxisType),yOrd=this._isOrdinalType(this.yAxisType),xTime=this._isTimeType(this.xAxisType),doX=xTime?!1:!0,doY=!0,keys=this._seriesKeys?this._seriesKeys:Object.keys(this.completeSeriesConfig),extents={x:[],y:[]};extents.x=this._checkForExtents(xOrd,this.chartExtents,this.dataExtents,"x");extents.y="object"===babelHelpers.typeof(this.y)?this._calcMultiAxisExtents():this._checkForExtents(yOrd,this.chartExtents,this.dataExtents,"y");if(0<extents.x.length&&extents.x[0]!==1/0&&extents.x[1]!==-Infinity){xTime=!1;doX=!1}if(!Array.isArray(extents.y)||0<extents.y.length&&extents.y[0]!==1/0&&extents.y[1]!==-Infinity){doY=!1}if(0===this.chartData.length){xTime=!1;doX=!1;doY=!1}if(doX||doY||xTime){this._findMinMax(this.chartData,doX,doY,xOrd,yOrd,xTime,extents,keys)}this._chartDataHasChanged=0;if(extents.x[0]===1/0){extents.x[0]=0}if(extents.x[1]===-Infinity){extents.x[1]=1}if(Array.isArray(extents.y)&&extents.y[0]===1/0){extents.y[0]=0}if(Array.isArray(extents.y)&&extents.y[1]===-Infinity){extents.y[1]=1}if(extents.x[1]===extents.x[0]){extents.x[0]-=.5;extents.x[1]+=.5}if(Array.isArray(extents.y)){if(extents.y[1]===extents.y[0]){extents.y[0]-=.5;extents.y[1]+=.5}}else{for(var yKeys=Object.keys(extents.y),i=0;i<yKeys.length;i++){if(extents.y[yKeys[i]][0]===extents.y[yKeys[i]][1]){extents.y[yKeys[i]][0]-=.5;extents.y[yKeys[i]][1]+=.5}}}if(this.startFromZero){if("linear"===this.xAxisType){extents.x[0]=_Mathmin(extents.x[0],0);extents.x[1]=_Mathmax(extents.x[1],0)}if("linear"===this.yAxisType){extents.y[0]=_Mathmin(extents.y[0],0);extents.y[1]=_Mathmax(extents.y[1],0)}}return extents},_checkForExtents:function _checkForExtents(isOrd,chartExtents,dataExtents,axis){var exts=[];if(isOrd){if(dataExtents&&dataExtents[axis]){exts=JSON.parse(JSON.stringify(dataExtents[axis]))}if(chartExtents&&chartExtents[axis]){exts=JSON.parse(JSON.stringify(chartExtents[axis]))}}else{var fromChartExtents=!1;exts=this._checkChartExtents(chartExtents,axis);fromChartExtents=2===exts.length?!0:!1;exts=this._checkDataExtents(dataExtents,chartExtents,axis,fromChartExtents,exts);if(2>exts.length){exts=[this._defaultScaleValue[axis][0],this._defaultScaleValue[axis][1]]}}return exts},_checkChartExtents:function _checkChartExtents(cExts,axis){var exts=[];if(cExts&&cExts[axis]&&2===cExts[axis].length){exts[0]="dynamic"===cExts[axis][0]?1/0:cExts[axis][0];exts[1]="dynamic"===cExts[axis][1]?-Infinity:cExts[axis][1]}return exts},_checkDataExtents:function _checkDataExtents(dExts,cExts,axis,bool,exts){var exts=exts||[];if(dExts&&dExts[axis]&&2===dExts[axis].length){if(bool){exts[0]="dynamic"===cExts[axis][0]?dExts[axis][0]:cExts[axis][0];exts[1]="dynamic"===cExts[axis][1]?dExts[axis][1]:cExts[axis][1]}else{exts[0]=Math.min(dExts[axis][0],this._defaultScaleValue[axis][0]);exts[1]=Math.max(dExts[axis][1],this._defaultScaleValue[axis][1])}}return exts},_findMinMax:function _findMinMax(data,doX,doY,ordX,ordY,timeX,result,keys){var j,xVal,yVal,jLen=data.length,x=this.completeSeriesConfig[keys[0]].x,y=this.completeSeriesConfig[keys[0]].y,doX0=!ordX&&result.x[0]===1/0?!0:!1,doX1=!ordX&&result.x[1]===-Infinity?!0:!1,doY0=!ordY&&result.y[0]===1/0?!0:!1,doY1=!ordY&&result.y[1]===-Infinity?!0:!1;if(timeX){this._findTimeMM(result,data,jLen,x,doX0,doX1)}for(j=0;j<jLen;j++){xVal=this._getDataExtents(data[j],keys,"x");yVal=this._getDataExtents(data[j],keys,"y");if(doX){this._processDataValues(ordX,result,data,"x",x,j,doX0,doX1,xVal[0],xVal[1])}if(doY){this._processDataValues(ordY,result,data,"y",y,j,doY0,doY1,yVal[0],yVal[1])}};},_getDataExtents:function _getDataExtents(d,keysArr,axis){for(var a=[],i=0,key;i<keysArr.length;i++){key=keysArr[i];if(!this.mutedSeries[keysArr[i]]){var val=d[this.completeSeriesConfig[key][axis]];if(val||0===val){a.push(val)}}}return[Math.min.apply(null,a),Math.max.apply(null,a)]},_findTimeMM:function _findTimeMM(result,d,l,x,doMin,doMax){if(doMin){this._setMin(result.x,d[0][x])}if(doMax){this._setMax(result.x,d[l-1][x])}},_setMin:function _setMin(r,d){if(isNaN(r[0])||r[0]>d){r[0]=d}},_setMax:function _setMax(r,d){if(isNaN(r[1])||r[1]<d){r[1]=d}},_processDataValues:function _processDataValues(isOrd,r,d,axis,key,i,doMin,doMax,v0,v1){if(isOrd){if(-1===r[axis].indexOf(d[i][key])){r[axis].push(d[i][key])}}else{if(doMin){this._setMin(r[axis],v0)}if(doMax){this._setMax(r[axis],v1)}}},_checkInSeriesConfig:function _checkInSeriesConfig(exts,a){for(var i=0,s;i<this.seriesToAxes[a].length;i++){s=this.seriesToAxes[a][i];if(!this.hardMute||!this.mutedSeries[s]){exts[a][0]=this.completeSeriesConfig[s].yMin||0===this.completeSeriesConfig[s].yMin?Math.min(this.completeSeriesConfig[s].yMin,exts[a][0]):exts[a][0];exts[a][1]=this.completeSeriesConfig[s].yMax||0===this.completeSeriesConfig[s].yMax?Math.max(this.completeSeriesConfig[s].yMax,exts[a][1]):exts[a][1]}}},_applyChartExtents:function _applyChartExtents(exts,a){var k=this.chartExtents[a]?a:"y";if(this.chartExtents[k]){if("dynamic"===this.chartExtents[k][0]){exts[a][0]=exts[a][0]||0===exts[a][0]?exts[a][0]:1/0}else{exts[a][0]=this.chartExtents[k][0]}if("dynamic"===this.chartExtents[k][1]){exts[a][1]=exts[a][1]||0===exts[a][1]?exts[a][1]:-Infinity}else{exts[a][1]=this.chartExtents[k][1]}}},_searchForExtents:function _searchForExtents(exts,seriesToSearch,data){for(var seriesList=Object.keys(seriesToSearch),i=0;i<data.length;i++){for(var j=0;j<seriesList.length;j++){var s=seriesList[j],sY=this.completeSeriesConfig[s].y,series=seriesToSearch[s],axis=series.axis;if(series.min&&(data[i][sY]||0===data[i][sY])){exts[axis][0]=Math.min(data[i][sY],exts[axis][0])}if(series.max&&(data[i][sY]||0===data[i][sY])){exts[axis][1]=Math.max(data[i][sY],exts[axis][1])}}}},_calcSeriesToSearch:function _calcSeriesToSearch(exts,a,seriesToSearch){for(var i=0,s;i<this.seriesToAxes[a].length;i++){s=this.seriesToAxes[a][i];if(!this.hardMute||!this.mutedSeries[s]){seriesToSearch[s]={axis:a,min:exts[a][0]===1/0?!0:!1,max:exts[a][1]===-Infinity?!0:!1}}}},_calcMultiAxisExtents:function _calcMultiAxisExtents(){for(var search=!1,exts={},seriesToSearch={},a,keys,i=0;i<this.axes.length;i++){a=this.axes[i];exts[a]=[];exts[a][0]=this._defaultScaleValue.y[0];exts[a][1]=this._defaultScaleValue.y[1];this._checkInSeriesConfig(exts,a);if(this.chartExtents){this._applyChartExtents(exts,a)}if(exts[a][0]===1/0||exts[a][1]===-Infinity){search=!0;this._calcSeriesToSearch(exts,a,seriesToSearch)}}if(search){this._searchForExtents(exts,seriesToSearch,this.chartData)}keys=Object.keys(exts);for(var i=0;i<keys.length;i++){if(exts[keys[i]][0]===1/0||exts[keys[i]][1]===-Infinity){exts[keys[i]]=[0,1]}}return exts},_updateDomain:function _updateDomain(selectedDomain){if(this.hasUndefinedArguments(arguments)){return}if(this.x&&this.y){if("reset"===selectedDomain||"rereset"===selectedDomain){this._setDomain()}else{if(0<selectedDomain.x.length){this.x.domain(selectedDomain.x)}if("object"===babelHelpers.typeof(this.y)&&!Array.isArray(selectedDomain.y)){for(var i=0;i<this.axes.length;i++){this.y[this.axes[i]].domain(selectedDomain.y[this.axes[i]])}}else if("function"===typeof this.y&&0<selectedDomain.y.length){this.y.domain(selectedDomain.y)}this.set("domainChanged",this.domainChanged+1)}}},_chartDataChanged:function _chartDataChanged(){if(this.hasUndefinedArguments(arguments)){return}this.set("_chartDataHasChanged",this._chartDataHasChanged++)},_setAxisScale:function _setAxisScale(leftDims,rightDims,leftAxisSize,rightAxisSize){var leftDims=leftDims||[],rightDims=rightDims||[],allDims=leftDims.concat(rightDims),leftAxisSize=leftAxisSize||50,rightAxisSize=rightAxisSize||50;if(0===allDims.length){return}var s=function s(d){if(-1!==leftDims.indexOf(d)){return-1*(leftDims.indexOf(d)*leftAxisSize)}else if(-1!==rightDims.indexOf(d)){return rightDims.indexOf(d)*rightAxisSize}};s.domain=function(){return allDims};s.leftDomain=function(newDims){if(newDims){leftDims=newDims}return leftDims};s.rightDomain=function(newDims){if(newDims){rightDims=newDims}return rightDims};return s},getPixelFromData:function getPixelFromData(data,series,margin){var x,y,marg=margin?margin:this.margin,outOfBounds=!1,yDomain=this.y[this.completeSeriesConfig[series].axis.id].domain();if(data[0]<this.x.domain()[0]||data[0]>this.x.domain()[1]||data[1]<yDomain[0]||data[1]>yDomain[1]){outOfBounds=!0}x=this.x(data[0])+ +marg.left;y=this.y[this.completeSeriesConfig[series].axis.id](data[1])+marg.top;return{pixel:[x,y],outOfBounds:outOfBounds}},getDataFromPixel:function getDataFromPixel(pixelVal,series){var x,y;x=this.x.invert(pixelVal[0]);y=this.y[this.completeSeriesConfig[series].axis.id].invert(pixelVal[1]);return[x,y]},_pixelRequest:function _pixelRequest(evt){var res=this.getPixelFromData(evt.detail.data,evt.detail.series,evt.detail.margin);evt.detail.callback(res)},_updatePadding:function _updatePadding(){var updated=!1;if("scaleBand"===this.xAxisType&&this.x&&this.x.paddingInner){this.x.paddingInner(this.scalePadding).paddingOuter(this.paddingOuter);updated=!0}if("scaleBand"===this.yAxisType&&this.y&&this.y.paddingInner){this.y.paddingInner(this.scalePadding).paddingOuter(this.paddingOuter);updated=!0}if(updated&&this.domainChanged){this.set("domainChanged",this.domainChanged+1)}},_updateLogBase:function _updateLogBase(){var updated=!1;if("log"===this.xAxisType&&this.x&&this.x.base){this.x.base(this.logBase);updated=!0}if("log"===this.yAxisType&&this.y){if("function"===typeof this.y){this.y.base(this.logBase);updated=!0}else if("object"===babelHelpers.typeof(this.y)){for(var i=0;i<this.axes.length;i++){if(this.y[this.axes[i]]&&this.y[this.axes[i]].base){this.y[this.axes[i]].base(this.logBase)}}updated=!0}}},_fixLogExt:function _fixLogExt(ext){var _Mathabs=Math.abs;if(0>=ext[0]&&0>=ext[1]){ext[1]=0===ext[1]?-1:ext[1]}else if(0<=ext[0]&&0<=ext[1]){ext[0]=0===ext[0]?1:ext[0]}else{console.warn("log domain crosses 0, which is invalid");if(_Mathabs(ext[0])>_Mathabs(ext[1])){ext[1]=0===ext[1]?-1:ext[1]}else{ext[0]=0===ext[0]?1:ext[0]}}return ext}},PxVisBehavior.sizing,PxVisBehaviorD3.axes,PxVisBehavior.dataset,PxVisBehavior.commonMethods,PxVisBehaviorD3.selectedDomain,PxVisBehavior.axisTypes,PxVisBehavior.completeSeriesConfig,PxVisBehavior.chartExtents,PxVisBehavior.dataExtents,PxVisBehaviorD3.domainUpdate,PxVisBehavior.preventWebWorkerSynchronization,PxVisBehavior.mutedSeries,PxVisBehavior.observerCheck,PxVisBehavior.scaleTypeCheck];</script>
</head><body></body></html>