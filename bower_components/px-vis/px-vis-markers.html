<!--
Copyright (c) 2018, General Electric

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-tooltip/px-tooltip.html">
<link rel="import" href="px-vis-behavior-common.html">
<link rel="import" href="px-vis-behavior-d3.html">
<link rel="import" href="px-vis-scatter-canvas.html">

<!--

### Usage

    <px-vis-svg
        ...
        svg="{{svg}}">
    </px-vis-svg>
    <px-vis-scale
        ...
        x="{{x}}"
        y="{{y}}"
        domain-changed="{{domainChanged}}">
    </px-vis-scale>
    <px-vis-interaction-space
        ...
        generating-crosshair-data="{{generatingCrosshairData}}"
        crosshair-data="{{crosshairData}}">
    </px-vis-interaction-space>

    <px-vis-markers
        svg="[[svg]]"
        x="[[x]]"
        y="[[y]]"
        domain-changed="[[domainChanged]]"
        time-data="[[key]]"
        complete-series-config="[[completeSeriesConfig]]"
        chart-data="[[chartData]]"
        generating-crosshair-data="[[generatingCrosshairData]]"
        crosshair-data="[[crosshairData]]">
    </px-vis-markers>


@element px-vis-markers
@blurb Element which draws markers on top or bottom of a chart
@homepage index.html
@demo demo/index.html

-->

</head><body><dom-module id="px-vis-markers">
    <template>

      <template is="dom-repeat" items="[[_markerTypes]]">
        <px-vis-scatter-canvas canvas-context="[[canvasContext]]" series-id="[[item]]" clip-path="" chart-data="[[_returnMarkerData(item, _markerData)]]" complete-series-config="[[_markerConfig]]" width="[[width]]" height="[[height]]" margin="[[_returnMargin(margin.*)]]" x="[[x]]" y="[[_returnYScale(item, _topDomain, _bottomDomain)]]" domain-changed="[[_returnDomain(item, _topDomain, _bottomDomain, domainChanged)]]" progressive-rendering-points-per-frame="500" renderer-type="markers">
        </px-vis-scatter-canvas>
      </template>
    </template>
</dom-module>

<script>Polymer({is:"px-vis-markers",behaviors:[PxVisBehavior.observerCheck,PxVisBehavior.sizing,PxVisBehaviorD3.canvasContext,PxVisBehaviorD3.axes,PxVisBehavior.dataset,PxVisBehavior.commonMethods,PxVisBehaviorD3.clipPath,PxVisBehavior.dynamicConfigProperties,PxVisBehavior.markers],properties:{_markerData:{type:Object,computed:"_computeMarkerData(markerData.*, _markerTypes.*)"},_markerConfig:{type:Object,computed:"_computeMarkerConfig(markerConfig.*)"},_markerTypes:{type:Array},_topScale:{type:Function},_bottomScale:{type:Function},_topDomain:{type:Number,value:0},_bottomDomain:{type:Number,value:0},_canvas:{type:Object,computed:"_getCanvas(canvasContext)"},tooltipDetectionRadius:{type:Number,value:20},_tooltipPosition:{type:Array},_showTooltip:{type:Boolean,value:!1},_lockTooltip:{type:Boolean,value:!1},_tooltipDataResult:{type:Array},_isSearchingTooltip:{type:Boolean,value:!1},_tooltipShown:{type:Boolean,value:!1},_defaultMarkerConfig:{type:Object,readonly:!0,value:function value(){return{color:"rgb(123,123,123)",markerStrokeOpacity:0,markerSymbol:"square",markerSize:64,markerScale:1,showTooltip:!0,tooltipOrientation:"top",priority:0,row:0,location:"top"}}}},observers:["_requestCanvasCreation(markerConfig, height, margin.*)","_createScales(height, margin.*, _markerTypes.*)","_redraw(domainChanged)"],_computeMarkerConfig:function _computeMarkerConfig(){if(this.hasUndefinedArguments(arguments)){return}for(var types=Object.keys(this.markerConfig),defaultKeys=Object.keys(this._defaultMarkerConfig),type,config={},i=0;i<types.length;i++){type=types[i];config[type]={x:"x",y:type};for(var j=0;j<defaultKeys.length;j++){config[type][defaultKeys[j]]=this.markerConfig[type][defaultKeys[j]]||!1===this.markerConfig[type][defaultKeys[j]]||0===this.markerConfig[type][defaultKeys[j]]?this.markerConfig[type][defaultKeys[j]]:this._defaultMarkerConfig[defaultKeys[j]]}config[type].markerFillOpacity=this._getFillOpacity(this.markerConfig[type].markerFillOpacity,config[type].markerFillOpacity)}this.set("_markerTypes",types);return config},_getFillOpacity:function _getFillOpacity(fill,stroke){if(fill){return fill}if(!stroke){return 1}return 0},_computeMarkerData:function _computeMarkerData(){if(this.hasUndefinedArguments(arguments)){return}if(this._lockTooltip){this._lockTooltip=!1;this._closeTooltip()}if(!this.markerData||0===this.markerData.length){return[]}for(var data=this._prepDataObject(this._markerTypes),type,row,time,o,i=0;i<this.markerData.length;i++){time=this.markerData[i].time;type=this.markerData[i].label;row=this.markerConfig&&this.markerConfig[type]&&this.markerConfig[type].row?this.markerConfig[type].row:0;o={};o.x=time;o[type]=row;o.originIndex=i;if(!data[type]){data[type]=[]}data[type].push(o)}return data},_prepDataObject:function _prepDataObject(types){for(var data={},i=0;i<types.length;i++){data[types[i]]=[]}return data},_requestCanvasCreation:function _requestCanvasCreation(){if(this.hasUndefinedArguments(arguments)){return}this.set("canvasLayersConfig.markers",{mouseevents:!0,height:this.height,margin:{top:0,bottom:0,left:this.margin.left,right:this.margin.right}})},_createScales:function _createScales(){if(this.hasUndefinedArguments(arguments)){return}this.debounce("createScalesMarker",function(){this._createScalesDebounced()},10)},_createScalesDebounced:function _createScalesDebounced(){for(var tH=this.margin.top,bH=this.height-this.margin.bottom,tRowSet={},bRowSet={},tRow,bRow,row,tScale,bScale,type,i=0;i<this._markerTypes.length;i++){type=this._markerTypes[i];row=this.markerConfig[type].row;if("bottom"===this.markerConfig[type].location){bRowSet[row]=!0}else{tRowSet[row]=!0}}bRow=Object.keys(bRowSet);tRow=Object.keys(tRowSet);bScale=Px.d3.scalePoint().range([bH,this.height]).padding(.5).domain(bRow);tScale=Px.d3.scalePoint().range([0,tH]).padding(.5).domain(tRow);this.set("_bottomScale",bScale);this.set("_topScale",tScale);this.set("_bottomDomain",this._bottomDomain+1);this.set("_topDomain",this._topDomain+1)},_returnYScale:function _returnYScale(item){if(this.hasUndefinedArguments(arguments)){return}if(this._topDomain&&this._bottomDomain){return"bottom"===this.markerConfig[item].location?this._bottomScale:this._topScale}},_returnDomain:function _returnDomain(item){if(this.hasUndefinedArguments(arguments)){return}if(this._topDomain&&this._bottomDomain&&this.domainChanged){return"bottom"===this.markerConfig[item].location?this._bottomDomain:this._topDomain}},_returnMarkerData:function _returnMarkerData(item){if(this.hasUndefinedArguments(arguments)){return}return this._markerData[item]},_returnMargin:function _returnMargin(){return{top:0,bottom:0,left:this.margin.left,right:this.margin.right}},_redraw:function _redraw(){if(this.hasUndefinedArguments(arguments)){return}if(this._topDomain&&this._bottomDomain&&this.domainChanged){this.set("_bottomDomain",this._bottomDomain+1);this.set("_topDomain",this._topDomain+1)}if(this._lockTooltip){this._lockTooltip=!1;this._closeTooltip()}},_mouseMove:function _mouseMove(evt){var d3Event={mousePos:Px.d3.mouse(this._canvas),pageX:Px.d3.event.pageX,pageY:Px.d3.event.pageY};if(!this._isSearchingTooltip&&this._topDomain){window.requestAnimationFrame(function(){this._searchTooltip(d3Event);this._isSearchingTooltip=!1}.bind(this));this._isSearchingTooltip=!0}},_searchTooltip:function _searchTooltip(d3Event){if(this._lockTooltip){return}var mousePos=d3Event.mousePos;if(mousePos[0]<=this.margin.left||mousePos[0]>=this.width-this.margin.right||0>=mousePos[1]){this._closeTooltip();return}var rowInfo=this._getRowInfoForMouse(mousePos);if(!(rowInfo.index||0===rowInfo.index)){this._closeTooltip();return}var labels=this._findLabelsForRow(rowInfo.index);if(0===labels.length){this._closeTooltip();return}for(var data=[],i=0;i<labels.length;i++){if(this._markerData[labels[i]]&&this._markerData[labels[i]].length){data=data.concat(this._markerData[labels[i]])}}if(0===data.length){this._closeTooltip();return}data.sort(function(a,b){return Px.d3.ascending(a.x,b.x)});var adjustedMousePos=[mousePos[0]-this.margin.left,mousePos[1]],bisect=Px.d3.bisector(function(d){return d.x}.bind(this)).right,maxDomain=this.x.domain()[1],minDomain=this.x.domain()[0],mouseTime=this.x.invert(adjustedMousePos[0]),right=bisect(data,mouseTime),left=Math.max(0,right?right-1:0),indexChosen;if(!data[left]||data[left].x<minDomain){indexChosen=right}else if(!data[right]||data[right].x>maxDomain){indexChosen=left}else if(data[right]&&data[right].x-mouseTime<mouseTime-data[left].x){indexChosen=right}else if(data[left]){indexChosen=left}var dataResult=this._createTooltipData(indexChosen,data);if(!dataResult||0===dataResult.length){this._closeTooltip();return}var detail=this._createStub(mousePos,dataResult[0],rowInfo,d3Event);if(!detail){this._closeTooltip();return}detail.data=this._formatDataForTooltip(dataResult);this._tooltipShown=!0;this.dispatchEvent(new CustomEvent("central-tooltip-display-request",{bubbles:!0,composed:!0,detail:detail}))},_createTooltipData:function _createTooltipData(index,data){var result=[],i=0,currType=this._findMarkerType(data[index]),newData=data[index];newData.priority=this._markerConfig[currType].priority;result.push(newData);i=1;while(data[index+i]&&data[index].x===data[index+i].x){currType=this._findMarkerType(data[index+i]);if(this._markerConfig[currType].showTooltip){newData=data[index+i];newData.priority=this._markerConfig[currType].priority;result.push(newData)}i++}i=-1;while(data[index+i]&&data[index].x===data[index+i].x){currType=this._findMarkerType(data[index+i]);if(this._markerConfig[currType].showTooltip){newData=data[index+i];newData.priority=this._markerConfig[currType].priority;result.push(newData)}i--}result.sort(function(a,b){return Px.d3.descending(a.priority,b.priority)});return result},_createStub:function _createStub(mousePos,dataResult,rowInfo,d3Event){var pixelResult=[],type=this._findMarkerType(dataResult);if(!type||!this._markerConfig[type].showTooltip){return null}pixelResult[0]=this.x(dataResult.x)+this.margin.left;if(Math.abs(pixelResult[0]-mousePos[0])>this.tooltipDetectionRadius){return null}pixelResult[0]+=d3Event.pageX-mousePos[0];pixelResult[1]=d3Event.pageY-mousePos[1]+rowInfo.rowY;return{mouseCoords:pixelResult,orientation:this._markerConfig[type].tooltipOrientation,delay:50,tooltipType:this.is,origin:this}},_formatDataForTooltip:function _formatDataForTooltip(data){var _this=this,formatted=[];data.forEach(function(d){formatted.push({title:_this.markerData[d.originIndex].label,time:d.x,data:_this._getAllKeys(_this.markerData[d.originIndex])})});return formatted},_getAllKeys:function _getAllKeys(d){var arr=[];Object.entries(d).forEach(function(_ref){var _ref2=babelHelpers.slicedToArray(_ref,2),key=_ref2[0],val=_ref2[1];if("time"!==key&&"label"!==key){arr.push({title:key,value:val})}});return arr},_closeTooltip:function _closeTooltip(){if(!this._tooltipShown){return}this._tooltipShown=!1;this.dispatchEvent(new CustomEvent("central-tooltip-cancel-request",{bubbles:!0,composed:!0,detail:{origin:this}}))},_findMarkerType:function _findMarkerType(data){for(var type,dataKey=Object.keys(data),i=0;i<dataKey.length;i++){if(-1!==this._markerTypes.indexOf(dataKey[i])){type=dataKey[i];break}}return type},_mouseClick:function _mouseClick(){if(this._tooltipShown){this._lockTooltip=!this._lockTooltip;var detail={is:this.is,origin:this};if(this._lockTooltip){this.dispatchEvent(new CustomEvent("central-tooltip-lock-request",{bubbles:!0,composed:!0,detail:detail}))}else{this.dispatchEvent(new CustomEvent("central-tooltip-lock-cancel",{bubbles:!0,composed:!0,detail:detail}));this._closeTooltip()}}},_mouseLeave:function _mouseLeave(){if(!this._lockTooltip){this._closeTooltip()}},_getRowInfoForMouse:function _getRowInfoForMouse(mousePos){var top=mousePos[1]<=this.margin.top?!0:!1,yStart,scale,domain,availableSpace,domainIndex=0,rowHeight,rowY;if(top){yStart=0;scale=this._topScale;availableSpace=this.margin.top}else{yStart=this.height-this.margin.bottom;scale=this._bottomScale;availableSpace=this.margin.bottom}domain=scale.domain();if(domain.length){rowHeight=availableSpace/domain.length;domainIndex=Math.floor((mousePos[1]-yStart)/rowHeight);rowY=yStart+(domainIndex+.5)*rowHeight}else{rowY=yStart+availableSpace/2}return{index:domain[domainIndex],rowY:rowY}},_findLabelsForRow:function _findLabelsForRow(rowIndex){var index=+rowIndex,result=[];Object.entries(this._markerConfig).forEach(function(_ref3){var _ref4=babelHelpers.slicedToArray(_ref3,2),key=_ref4[0],conf=_ref4[1];if(index===conf.row&&conf.showTooltip){result.push(key)}});return result},_getCanvas:function _getCanvas(){if(this.hasUndefinedArguments(arguments)){return}if(this.canvasContext){if(this._canvas===void 0){Px.d3.select(this.canvasContext.canvas).on("mousemove.markers",this._mouseMove.bind(this));Px.d3.select(this.canvasContext.canvas).on("mousedown.markers",this._mouseClick.bind(this));Px.d3.select(this.canvasContext.canvas).on("mouseleave.markers",this._mouseLeave.bind(this))}return this.canvasContext.canvas}}});</script>
</body></html>