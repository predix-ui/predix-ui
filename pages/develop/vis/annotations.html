<html><head><link defer="" rel="import" href="../../../bower_components/polymer/polymer.html">
  <link defer="" rel="import" href="../../../bower_components/px-demo/px-demo-footer.html">
  <link defer="" rel="import" href="../../../bower_components/px-demo/px-demo-footer.html">
  <link defer="" rel="import" href="../../../elements/px-catalog-page/px-catalog-page-behavior.html">
  <link defer="" rel="import" href="../../../elements/px-catalog-page/px-catalog-page-elements.html">
  <link defer="" rel="import" href="../../../elements/px-catalog-code-snippet/px-catalog-code-snippet.html">
  <link defer="" rel="import" href="../../../css/px-catalog-page-styles.html">
  <link defer="" rel="import" href="../../../css/px-catalog-theme-styles.html">
  

  </head><body><dom-module id="view-develop-vis-annotations">
    <template>
      <style include="px-catalog-theme-styles px-catalog-page-styles px-catalog-code-styles"></style>
      

      <div class="page">
        
  <div class="page-anchors" id="toc">
    <ul class="toc">
      
  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#introduction', activeAnchor)]]" href="#" anchor="#introduction" on-tap="_handleAnchorTapped">Introduction</a>
    
  </li>

  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#annotations-feature-one-array-and-some-hooks', activeAnchor)]]" href="#" anchor="#annotations-feature-one-array-and-some-hooks" on-tap="_handleAnchorTapped">Annotations feature: one array and some hooks</a>
    <ul class="toc">
  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#annotationdata', activeAnchor)]]" href="#" anchor="#annotationdata" on-tap="_handleAnchorTapped">annotationData</a>
    
  </li>

  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#events', activeAnchor)]]" href="#" anchor="#events" on-tap="_handleAnchorTapped">Events</a>
    
  </li>
</ul>
  </li>

  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#example-implementation', activeAnchor)]]" href="#" anchor="#example-implementation" on-tap="_handleAnchorTapped">Example implementation</a>
    <ul class="toc">
  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#requirements', activeAnchor)]]" href="#" anchor="#requirements" on-tap="_handleAnchorTapped">Requirements</a>
    
  </li>

  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#custom-toolbar-config', activeAnchor)]]" href="#" anchor="#custom-toolbar-config" on-tap="_handleAnchorTapped">Custom toolbar config</a>
    
  </li>

  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#creation', activeAnchor)]]" href="#" anchor="#creation" on-tap="_handleAnchorTapped">Creation</a>
    
  </li>

  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#display-annotation-message', activeAnchor)]]" href="#" anchor="#display-annotation-message" on-tap="_handleAnchorTapped">Display annotation message</a>
    
  </li>

  <li class="toc__item">
    <a class$="toc__item__link [[_getTocLinkClassName('#editdelete-annotations', activeAnchor)]]" href="#" anchor="#editdelete-annotations" on-tap="_handleAnchorTapped">Edit/Delete annotations</a>
    
  </li>
</ul>
  </li>

    </ul>
  </div>

        <div class="page-content">
          <h2 class="page-title">Using the annotations feature</h2>
          
          
<h3 id="introduction">Introduction</h3>
<p>Version 4.6.0 of the vis framework saw the introduction of the annotations feature. This feature has been voluntarily left unopiniated and much of its look and interaction will be left to the application to implement. This article will walk you through how the feature works and the <a href="https://www.predix-ui.com/px-vis-demos/px-vis-demos/annotations.html" target="_blank">example implementation</a> we provide.</p>
<p><catalog-picture img-src="../../img/guidelines/dev/vis/annotations/annotations_example" img-alt="example annotations" style="border:none;" caption="Implementation example of the annotations"></catalog-picture></p>
<h3 id="annotations-feature-one-array-and-some-hooks">Annotations feature: one array and some hooks</h3>
<p>The feature is minimalistic from the chart perspective: one <code class="code code--inline">annotationData</code> array containing all the annotation data and some events for the app to handle interactions with the annotations.</p>
<h4 id="annotationdata">annotationData</h4>
<p><code class="code code--inline">annotationData</code> is an array containing one object for each annotation:</p>
<px-catalog-code-snippet language="javascript">
      <script type="text/code">
{
  x: 1325897523,
  y: 15.7,
  series: y0,
  data: {

  }
}

      </script>
    </px-catalog-code-snippet><p><code class="code code--inline">x</code> and <code class="code code--inline">y</code> are data values (not pixel values). However they don't have to match an actual data point, the chart will convert those data values to the appropriate pixel values for displaying them.</p>
<p><code class="code code--inline">series</code> is an id of a series: for XY/Timeseries/Polar charts this is a series id in <code class="code code--inline">seriesConfig</code> and for parallel coordinates/radar charts this is an axis. This is needed for the annotation to know which scale to use to convert the data values to pixel values.</p>
<p><code class="code code--inline">data</code> is an arbitrary object that can hold any information you might need in the annotation. Typically this would have at least a message string. This data object will be available in the event handlers for annotation interaction.</p>
<h4 id="events">Events</h4>
<p>This array is all that is needed to display annotations. In order to ineract with those the following events are available:</p>
<ul>
<li><code class="code code--inline">px-vis-annotation-enter</code>: Fired when the mouse enters an annotation icon (mouseenter event)</li>
<li><code class="code code--inline">px-vis-annotation-out</code>: Fired when the mouse out an annotation icon (mouseout event)</li>
<li><code class="code code--inline">px-vis-annotation-over</code>: Fired when the mouse hovers an annotation icon (mouseover event)</li>
<li><code class="code code--inline">px-vis-annotation-leave</code>: Fired when the mouse leave an annotation icon (mouseleave event)</li>
<li><code class="code code--inline">px-vis-annotation-click</code>: Fired when a click happens on an annotation icon (click event)</li>
</ul>
<p>Each of those event holds a data object (<code class="code code--inline">event.detail.data</code>) which will have:</p>
<ul>
<li>an <code class="code code--inline">annotationData</code> property containing the related <code class="code code--inline">data</code> object from the <code class="code code--inline">annotationData</code> array</li>
<li>an <code class="code code--inline">icon</code> property which is the actual annotation icon that has been interacted with</li>
</ul>
<p>Another event is fired when an annotation creation request happens, i.e <strong>when using the out of the box <code class="code code--inline">annotations</code> toolbar configuration</strong> and the user clicks the chart: <code class="code code--inline">px-vis-annotation-creation</code>. This event is defined in the toolbar configuration, so if using a custom annotations toolbar configuration you might want to copy it or create your own.</p>
<p>this event detail will contain the following <code class="code code--inline">data</code> object:</p>
<px-catalog-code-snippet language="javascript">
      <script type="text/code">
data: {
 chart: //the chart responsible for this interaction
 clickTarget: //the actual interaction target that has been clicked. Usually an axis interaction space (parallell coordinates/radar) or an interaction space
 mouseCoords:// the coordinates of the mouse relative to the clickTarget
}

      </script>
    </px-catalog-code-snippet><p>the mouse coordinates can be converted to data values by calling
<code class="code code--inline">getDataFromPixel(mouseCoords, series)</code> on the chart. <code class="code code--inline">series</code> is
a series which scale will be used to convert (a <code class="code code--inline">seriesConfig</code> series
for xy/timeseries/polar or an axes for parallel coordinates/radar).</p>
<h3 id="example-implementation">Example implementation</h3>
<p>We provide an example of a possible implementation of the annotation feature. The demo can be found <a href="https://www.predix-ui.com/px-vis-demos/px-vis-demos/annotations.html" target="_blank">here</a> and the code <a href="https://github.com/PredixDev/px-vis-demos/blob/master/px-vis-demos-annotation.es6.js" target="_blank">there</a>.</p>
<h4 id="requirements">Requirements</h4>
<p>This implementation aims at allowing creation, edition and deletion of annotations on any type of chart. The annotation message should be displayed in a tooltip when hovering an annotation icon.</p>
<p>Furthermore the annotation should always be linked to an actual data point, the closest to the mouse when clicking, rather than being allowed anywhere on the chart</p>
<h4 id="custom-toolbar-config">Custom toolbar config</h4>
<p>In order to make it easier to find the closest point to the mouse we are going to use a custom annotations toolbar config. This custom config is an extended version of the out of the box one: we only change the tooltip search mode to be the closest point and make sure we run the tooltip search on hovering:</p>
<px-catalog-code-snippet language="javascript">
      <script type="text/code">
{
  'tooltipLabel': 'Annotations',
  'icon': 'px-vis:comment',
  'cursorIcon': 'px-vis:comment',
  'buttonGroup': 1,
  'onClick': function () {
    this.set('_internalShowTooltip', false);
    this.set('showStrongIcon', true);
    //setting tooltip search to closest point
    this.set('interactionSpaceConfig.searchType', 'closestPoint');
    this.set('interactionSpaceConfig.searchFor', 'point');
  },
  'onDeselect': function () {
    this.set('showStrongIcon', false);
    //reset tooltip search to timestamp
    this.set('interactionSpaceConfig.searchFor', 'timestamp');
  },
  'actionConfig': {
    //clear tooltip if mouse leaves the chart
    'mouseout': 'resetTooltip',
    //search for tooltip data on hover
    'mousemove': 'calcTooltipData',
    'mousedown': 'null',
    'click': function (evt) {
      this.fire('px-vis-event-request', { 'eventName': 'px-vis-annotation-creation', 'data': { 'mouseCoords': evt.mouseCoords, 'clickTarget': evt.target, 'chart': this } })
    },
    'mouseup': 'null'
  },
  'subConfig': {
    'hideAnnotations': {
      'tooltipLabel': 'Hide Annotations',
      'icon': 'px-vis:hide',
      'buttonGroup': 1,
      'toggle': true,
      'onClick': 'function(button) {this.$$("px-vis-annotations").set("hide", button.selected);}'
    }
  }
}

      </script>
    </px-catalog-code-snippet><p>The config looks a bit daunting but only the commented lines have been added, the rest is just the copied out of the box configuration.</p>
<h4 id="creation">Creation</h4>
<p>For creation we listen to the <code class="code code--inline">px-vis-annotation-creation</code> event. When it is fired we try to retrieve the value of the closest point and its associated series, which will be available in the <code class="code code--inline">tooltipData</code> since we run the tooltip data search on hover (see <code class="code code--inline">createAnnotation</code> in the demo code for actual code implementation).</p>
<p>Once we have the data values and series we open a modal the user can interact with. The modal will display the series, data values as well as a text area used to input the actual annotation.</p>
<p><catalog-picture img-src="../../img/guidelines/dev/vis/annotations/annotation_creation" img-alt="annotation creation" caption="Modal for creating an annotation"></catalog-picture></p>
<p>When the user clicks create we update the chart's <code class="code code--inline">annotationData</code> with the data values, series and message.</p>
<h4 id="display-annotation-message">Display annotation message</h4>
<p>We display the annotation on the <code class="code code--inline">px-vis-annotation-enter</code> event. We set the annotation message to the tooltip, set the annotation icon as the tooltip target and force the tooltip open:</p>
<px-catalog-code-snippet language="javascript">
      <script type="text/code">
if(!this._lockTooltip) {
  this.$.ttContent.annotationMessage = evt.detail.data.annotationData.data.message;

  this.set('_ttTarget', evt.detail.data.icon);
  this.$.tooltip.set('opened', true);
}

      </script>
    </px-catalog-code-snippet><p>On <code class="code code--inline">px-vis-annotation-leave</code> we force the tooltip close.</p>
<px-catalog-code-snippet language="javascript">
      <script type="text/code">
if(!this._lockTooltip) {
  this.$.tooltip.set('opened', false);
}

      </script>
    </px-catalog-code-snippet><h4 id="editdelete-annotations">Edit/Delete annotations</h4>
<p>For editing annotations we listen to <code class="code code--inline">px-vis-annotation-click</code>. When this happens we "lock" the tooltip: <code class="code code--inline">this._lockTooltip = true;</code>, preventing it from hiding.</p>
<p>We then modify the tooltip content to display a text area with the message and three buttons: Cancel, Delete and Save.</p>
<p><catalog-picture img-src="../../img/guidelines/dev/vis/annotations/annotation_edit" img-alt="annotation editing" style="border:none;" caption="Editing an annotation"></catalog-picture></p>
<p>On Cancel we just close the tooltip.</p>
<p>On Save we update the <code class="code code--inline">annotationData</code> with the new message.</p>
<p>On Delete we remove this annotation from <code class="code code--inline">annotationData</code>.</p>
<px-catalog-code-snippet language="javascript">
      <script type="text/code">
var index;
if(this._editAction === 'save') {
  index = this.currentChart.annotationData.indexOf(this._currentDataEdit);
  this.currentChart.annotationData[index].data.message = this.$.ttContent.annotationMessage;
} else if(this._editAction === 'delete') {
  index = this.currentChart.annotationData.indexOf(this._currentDataEdit);
  this.currentChart.splice('annotationData', index, 1);
}

      </script>
    </px-catalog-code-snippet><p>#Conclusion</p>
<p>The example we provide is that: just an example. The annotations feature is pretty open in terms of implementation and interaction, feel free to imagine different ways to create/edit/delete them!</p>

        </div>
      </div>
      <px-demo-footer></px-demo-footer>
    </template>
    <script>Polymer({is:"view-develop-vis-annotations",behaviors:[PxCatalogBehavior.Page],_dynamicTheme:!1,ready:function ready(){if(this._dynamicTheme){this.setAttribute("dynamic-theme","")}}});</script>
  </dom-module>
</body></html>